{"version":3,"file":"projects_eav-ui_src_app_app-administration_sub-dialogs_delete-extension_delete-extension_comp-79838c.d6946a20b7c18276.js","mappings":"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","names":["AppExtensionsService","HttpServiceBase","constructor","this","log","classLog","getAllLive","refresh","newHttpResource","url","apiUrl","params","appId","method","updateConfiguration","name","config","configJson","JSON","parse","http","post","zoneId","downloadExtension","folder","URLSearchParams","toString","window","open","uploadExtensions","file","editions","formData","FormData","append","pipe","map","success","Success","Messages","MessageType","Text","installPreflightExtension","files","forEach","preflightExtension","edition","deleteExtension","force","withData","delete","static","__ngFactoryType__","_angular_core__WEBPACK_IMPORTED_MODULE_4__","jDH","factory","ɵfac","DeleteExtensionComponent","#snackBar","#extensionsSvc","route","dialogData","dialog","inject","MatSnackBar","transient","extensionFolder","snapshot","paramMap","get","withForceAllowed","preflightResult","value","ngOnInit","#watchKeyboardShortcuts","keydownEvents","subscribe","event","isCtrlEnter","preventDefault","deleteAndClose","closeDialog","confirm","dismiss","close","forceDeleteAndClose","executeDelete","evaluatePreflight","inspect","fileSummary","summary","filesChanged","changed","added","missing","some","f","path","endsWith","status","foundLock","showError","askForce","dataCount","data","contentTypes","length","message","duration","onAction","next","error","err","exceptionMessage","msg","i0","i1","MAT_DIALOG_DATA","i2","_angular_core__WEBPACK_IMPORTED_MODULE_5__","VBU","selectors","decls","vars","consts","template","rf","ctx","$event","MatButtonModule","i3","MatIconModule","i4","MatDialogActions","SaveCloseButtonFabComponent","MatSlideToggleModule","i5","FormsModule","i6","MatExpansionModule","i7","InspectExtensionContentComponent","TippyDirective","styles"],"ignoreList":[],"sourceRoot":"webpack:///","sources":["./projects/eav-ui/src/app/app-administration/services/app-extensions.service.ts","./projects/eav-ui/src/app/app-administration/sub-dialogs/delete-extension/delete-extension.component.ts","./projects/eav-ui/src/app/app-administration/sub-dialogs/delete-extension/delete-extension.component.html"],"sourcesContent":["import { Injectable, Signal } from '@angular/core';\r\nimport { map } from 'rxjs';\r\nimport { FileUploadResult } from '../../shared/components/file-upload-dialog/file-upload-dialog.models';\r\nimport { classLog } from '../../shared/logging';\r\nimport { HttpServiceBase } from '../../shared/services/http-service-base';\r\nimport { Extension, ExtensionInspectResult, ExtensionPreflightItem } from '../models/extension.model';\r\n\r\n@Injectable()\r\nexport class AppExtensionsService extends HttpServiceBase {\r\n  log = classLog({ AppExtensionsService });\r\n\r\n  /** Get all extensions with live refresh capability */\r\n  getAllLive(refresh: Signal<unknown>) {\r\n    return this.newHttpResource<{ extensions: Extension[] }>(() => {\r\n      // Watch the refresh signal to trigger reloads\r\n      refresh();\r\n\r\n      return {\r\n        url: this.apiUrl('admin/appExtensions/extensions'),\r\n        params: { appId: this.appId },\r\n        method: 'GET',\r\n      };\r\n    });\r\n  }\r\n\r\n  /** Update config (mutations still best done via HttpClient per Angular docs) */\r\n  updateConfiguration(name: string, config: string) {\r\n    // Parse the config to JsonElement format that the API expects\r\n    const configJson = JSON.parse(config);\r\n\r\n    return this.http.post<boolean>(this.apiUrl('admin/appExtensions/configuration'), configJson, {\r\n      params: {\r\n        zoneId: this.zoneId,\r\n        appId: this.appId,\r\n        name\r\n      },\r\n    });\r\n  }\r\n\r\n  /** Open download link for an extension */\r\n  downloadExtension(folder: string) {\r\n    const params = new URLSearchParams({\r\n      appId: this.appId,\r\n      zoneId: this.zoneId,\r\n      name: folder,\r\n    });\r\n    const url = `${this.apiUrl('admin/appExtensions/download')}?${params.toString()}`;\r\n    window.open(url, '_blank', '');\r\n  }\r\n\r\n  /** Uploads extension files */\r\n  uploadExtensions(file: File, editions?: string) {\r\n    const formData = new FormData();\r\n    formData.append('files', file);\r\n\r\n    const params = {\r\n      appId: this.appId,\r\n      zoneId: this.zoneId,\r\n      ...(editions ? { editions } : {})\r\n    };\r\n\r\n    return this.http.post<boolean>(this.apiUrl('admin/appExtensions/install'), formData, {\r\n      params,\r\n    }).pipe(\r\n      map((success: boolean): FileUploadResult => ({\r\n        Success: success,\r\n        Messages: success\r\n          ? [{ MessageType: 1, Text: 'Extension uploaded successfully' }]\r\n          : [{ MessageType: 2, Text: 'Extension upload failed' }]\r\n      }))\r\n    );\r\n  }\r\n\r\n  installPreflightExtension(files: File[]) {\r\n    const formData = new FormData();\r\n    files.forEach(file => formData.append('files', file));\r\n\r\n    return this.http.post<{ extensions: ExtensionPreflightItem[] }>(\r\n      this.apiUrl('admin/appExtensions/installPreflight'),\r\n      formData,\r\n      {\r\n        params: {\r\n          appId: this.appId,\r\n          zoneId: this.zoneId\r\n        },\r\n      }\r\n    );\r\n  }\r\n\r\n  preflightExtension(name: string, edition?: string) {\r\n    const params: { appId: string, name: string, edition?: string } = {\r\n      appId: this.appId,\r\n      name,\r\n    };\r\n    if (edition) params.edition = edition;\r\n\r\n    return this.newHttpResource<ExtensionInspectResult>(() => ({\r\n      url: this.apiUrl('admin/appExtensions/inspect'),\r\n      params,\r\n      method: 'GET',\r\n    }));\r\n  }\r\n\r\n  deleteExtension(name: string, edition?: string, force = false, withData = false) {\r\n    const params = {\r\n      appId: this.appId,\r\n      name,\r\n      force,\r\n      withData,\r\n      ...(edition ? { edition: edition } : {})\r\n    };\r\n\r\n    return this.http.delete<boolean>(\r\n      this.apiUrl('admin/appExtensions/delete'),\r\n      { params }\r\n    );\r\n  }\r\n}\r\n","import { Component, inject, Inject, OnInit } from '@angular/core';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MAT_DIALOG_DATA, MatDialogActions, MatDialogRef } from '@angular/material/dialog';\r\nimport { MatExpansionModule } from '@angular/material/expansion';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSnackBar } from '@angular/material/snack-bar';\r\nimport { ActivatedRoute } from '@angular/router';\r\nimport { transient } from 'projects/core';\r\nimport { isCtrlEnter } from '../../../edit/dialog/main/keyboard-shortcuts';\r\nimport { TippyDirective } from '../../../shared/directives/tippy.directive';\r\nimport { SaveCloseButtonFabComponent } from '../../../shared/modules/save-close-button-fab/save-close-button-fab.component';\r\nimport { AppExtensionsService } from '../../services/app-extensions.service';\r\nimport { ConfirmDeleteDialogComponent } from '../confirm-delete-dialog/confirm-delete-dialog.component';\r\nimport { ConfirmDeleteDialogData } from '../confirm-delete-dialog/confirm-delete-dialog.models';\r\nimport { InspectExtensionContentComponent } from '../inspect-extension/inspect-extension-content/inspect-extension-content.component';\r\n\r\n@Component({\r\n  selector: 'app-delete-extension',\r\n  templateUrl: './delete-extension.component.html',\r\n  styleUrls: ['./delete-extension.component.scss'],\r\n  imports: [\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatDialogActions,\r\n    SaveCloseButtonFabComponent,\r\n    MatSlideToggleModule,\r\n    FormsModule,\r\n    MatExpansionModule,\r\n    InspectExtensionContentComponent,\r\n    TippyDirective,\r\n  ]\r\n})\r\nexport class DeleteExtensionComponent implements OnInit {\r\n  #snackBar = inject(MatSnackBar);\r\n  #extensionsSvc = transient(AppExtensionsService);\r\n\r\n  extensionFolder = this.route.snapshot.paramMap.get('extension') as 'extension';\r\n  withData = false;\r\n  withForceAllowed = false;\r\n\r\n  preflightResult = this.#extensionsSvc.preflightExtension(this.extensionFolder, '').value;\r\n\r\n  constructor(\r\n    private route: ActivatedRoute,\r\n    @Inject(MAT_DIALOG_DATA) public dialogData: ConfirmDeleteDialogData,\r\n    public dialog: MatDialogRef<ConfirmDeleteDialogComponent>,\r\n  ) { }\r\n  \r\n  ngOnInit() {\r\n    this.#watchKeyboardShortcuts();\r\n  }\r\n\r\n  #watchKeyboardShortcuts(): void {\r\n    this.dialog.keydownEvents().subscribe(event => {\r\n      if (isCtrlEnter(event)) {\r\n        event.preventDefault();\r\n        this.deleteAndClose();\r\n      }\r\n    });\r\n  }\r\n\r\n  closeDialog(confirm?: boolean) {\r\n    this.#snackBar.dismiss();\r\n    confirm\r\n      ? this.dialog.close(confirm)\r\n      : this.dialog.close();\r\n  }\r\n\r\n  forceDeleteAndClose(confirm: boolean) {\r\n    if (!confirm) {\r\n      this.dialog.close(false);\r\n      return;\r\n    }\r\n\r\n    this.executeDelete(true);\r\n  }\r\n\r\n  deleteAndClose() {\r\n    this.evaluatePreflight();\r\n  }\r\n\r\n  private evaluatePreflight() {\r\n    const inspect = this.preflightResult()\r\n\r\n    const fileSummary = inspect.summary;\r\n    const filesChanged = fileSummary.changed + fileSummary.added + fileSummary.missing;\r\n\r\n    // 1) Installed?\r\n    const isInstalled = inspect.files.some(f =>\r\n      f.path.endsWith('App_Data/extension.json') && f.status !== 'missing'\r\n    );\r\n\r\n    // If not installed → auto-force-delete\r\n    if (!isInstalled) {\r\n      this.executeDelete(true);\r\n      return;\r\n    }\r\n\r\n    // 2) Lock file must exist\r\n    if (!inspect.foundLock) {\r\n      this.showError('Missing extension.lock.json. Deletion not allowed.');\r\n      return;\r\n    }\r\n\r\n    // 3) Changed / added / missing files?\r\n    if (filesChanged > 0 && !this.withForceAllowed) {\r\n      this.askForce(`The extension has file changes (${filesChanged}).`);\r\n      return;\r\n    }\r\n\r\n    // 4) Existing data?\r\n    const dataCount = inspect.data.contentTypes.length;\r\n    if (dataCount > 0 && !this.withForceAllowed) {\r\n      this.askForce(`The extension has data (${dataCount} items).`);\r\n      return;\r\n    }\r\n\r\n    // 5) All good → normal delete\r\n    this.executeDelete(false);\r\n  }\r\n\r\n  private askForce(message: string) {\r\n    const snack = this.#snackBar.open(\r\n      `${message} Force delete?`,\r\n      'Force',\r\n      { duration: 10000 }\r\n    );\r\n\r\n    snack.onAction().subscribe(() => this.executeDelete(true));\r\n  }\r\n\r\n  private executeDelete(force: boolean) {\r\n    this.#extensionsSvc\r\n      .deleteExtension(this.extensionFolder, '', force, this.withData)\r\n      .subscribe({\r\n        next: () => {\r\n          this.#snackBar.open('Extension deleted successfully', 'OK', { duration: 3000 });\r\n          this.dialog.close(true);\r\n        },\r\n        error: err => {\r\n          const msg = err?.error?.exceptionMessage ?? 'Delete failed.';\r\n          this.showError(msg);\r\n        }\r\n      });\r\n  }\r\n\r\n  private showError(msg: string) {\r\n    this.#snackBar.open(msg, 'OK', { duration: 8000 });\r\n  }\r\n}\r\n","<div class=\"eav-dialog\">\r\n  <div class=\"eav-dialog-header\">\r\n    <div class=\"eav-dialog-header__title\">Delete {{ extensionFolder }}</div>\r\n    <button mat-icon-button tippy=\"Close dialog\" (click)=\"closeDialog()\">\r\n      <mat-icon>close</mat-icon>\r\n    </button>\r\n  </div>\r\n\r\n  <div class=\"eav-dialog-content\">\r\n    <mat-accordion>\r\n      <mat-expansion-panel [expanded]=\"true\">\r\n        <mat-expansion-panel-header>\r\n          <mat-panel-title>Extension Details</mat-panel-title>\r\n        </mat-expansion-panel-header>\r\n        <div class=\"content\">\r\n          <app-inspect-extension-content [data]=\"preflightResult()\"></app-inspect-extension-content>\r\n        </div>\r\n      </mat-expansion-panel>\r\n    </mat-accordion>\r\n    <p>Are you Sure you want to delete this Extension?</p>\r\n    <p>\r\n      <mat-slide-toggle [(ngModel)]=\"withData\">\r\n        Also delete data in the App which the extension created?\r\n      </mat-slide-toggle>\r\n    </p>\r\n  </div>\r\n\r\n  <mat-dialog-actions align=\"end\">\r\n    <button mat-button (click)=\"forceDeleteAndClose(true)\">Force Delete</button>\r\n    <app-save-close-button-fab\r\n      [label]=\"'Delete and close (ctrl + enter)'\"\r\n      (action)=\"deleteAndClose()\"\r\n    />\r\n  </mat-dialog-actions>\r\n</div>\r\n"],"x_google_ignoreList":[]}
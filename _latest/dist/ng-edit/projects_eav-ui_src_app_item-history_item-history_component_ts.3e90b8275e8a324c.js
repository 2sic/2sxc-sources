"use strict";(self.webpackChunkeav_ui=self.webpackChunkeav_ui||[]).push([["projects_eav-ui_src_app_item-history_item-history_component_ts"],{6737:(tt,v,r)=>{r.r(v),r.d(v,{ItemHistoryComponent:()=>X});var u=r(8071),f=r(3839),x=r(9736);function Z(n,o,e){const i=JSON.parse(n.Json).Entity.Attributes,a="live"===e?function w(n){let o=n[0];for(const e of n)e.VersionNumber<=o.VersionNumber||(o=e);return o}(o):o.find(c=>c.VersionNumber===n.VersionNumber-1),s=a?JSON.parse(a.Json).Entity.Attributes:null,_=[];return null!=i&&Object.entries(i).forEach(([c,p])=>{Object.keys(p).forEach(l=>{null==_.find(d=>d.name===l&&d.dataType===c)&&_.push({name:l,dataType:c})})}),null!=s&&Object.entries(s).forEach(([c,p])=>{Object.keys(p).forEach(l=>{null==_.find(d=>d.name===l&&d.dataType===c)&&_.push({name:l,dataType:c})})}),_.map(c=>{const p=i?.[c.dataType]?.[c.name],l=s?.[c.dataType]?.[c.name];return{name:c.name,dataType:c.dataType,change:y(p,l,!0),values:O(p,l)}})}function O(n,o){const e=[];return null!=n&&Object.keys(n).forEach(a=>{e.includes(a)||e.push(a)}),null!=o&&Object.keys(o).forEach(a=>{e.includes(a)||e.push(a)}),e.map(a=>{const s=n?.[a],_=o?.[a];return{langKey:a,value:s,oldValue:_,change:y(s,_)}})}function y(n,o,e=!1){let i;return e&&("object"==typeof n&&(n=I(n)),"object"==typeof o&&(o=I(o))),i=null!=n&&null!=o?JSON.stringify(n)!==JSON.stringify(o)?"changed":"none":null!=n?"new":"deleted",i}function I(n){return"object"!=typeof n?n:Object.keys(n).sort().reduce((o,e)=>({...o,[e]:n[e]}),{})}var A=r(8702),t=r(1699),H=r(6861),N=r(91),$=r(9409),h=r(6575),S=r(9498),C=r(895),J=r(6515),g=r(5787),M=r(6618),P=r(1268),Q=r(6355),z=r(257);function U(n,o){if(1&n){const e=t.EpF();t.TgZ(0,"div",9)(1,"mat-form-field",10)(2,"mat-select",11),t.NdJ("selectionChange",function(a){t.CHM(e);const s=t.oxw(2);return t.KtG(s.compareChange(a.value))}),t.TgZ(3,"mat-option",12),t._uU(4,"Compare with: Previous"),t.qZA(),t.TgZ(5,"mat-option",13),t._uU(6,"Compare with: Live"),t.qZA()()()()}if(2&n){const e=t.oxw().ngIf;t.xp6(2),t.Q6J("value",e.compareWith)}}function E(n,o){1&n&&(t.TgZ(0,"div"),t._uU(1,"Loading..."),t.qZA())}function Y(n,o){1&n&&(t.TgZ(0,"div"),t._uU(1,"No previous versions of this item found"),t.qZA())}function F(n,o){if(1&n&&(t.ynx(0),t._uU(1),t.BQk()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.hij(" ",null==e.values[0]?null:e.values[0].value," ")}}function j(n,o){if(1&n&&(t.TgZ(0,"div"),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.Gre("eav-history-",e.change,""),t.xp6(1),t.hij(" ","deleted"===e.change?e.oldValue:e.value," ")}}function V(n,o){if(1&n&&(t.ynx(0),t.TgZ(1,"div",29),t._uU(2),t.qZA(),t.TgZ(3,"div",30),t._uU(4),t.qZA(),t.BQk()),2&n){const e=t.oxw().$implicit;t.xp6(2),t.Oqu(e.value),t.xp6(2),t.Oqu(e.oldValue)}}function k(n,o){if(1&n&&(t.TgZ(0,"div",26)(1,"div"),t._uU(2),t.qZA(),t.TgZ(3,"div",27),t.YNc(4,j,2,4,"div",28),t.YNc(5,V,5,2,"ng-container",0),t.qZA()()),2&n){const e=o.$implicit;t.xp6(1),t.Gre("eav-detail-row__label eav-history-",e.change,""),t.xp6(1),t.hij("",e.langKey,":"),t.xp6(2),t.Q6J("ngIf","changed"!==e.change),t.xp6(1),t.Q6J("ngIf","changed"===e.change)}}function B(n,o){if(1&n&&(t.TgZ(0,"div",24),t.YNc(1,k,6,6,"div",25),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngForOf",e.values)}}function q(n,o){if(1&n){const e=t.EpF();t.TgZ(0,"div",20)(1,"div",21),t.NdJ("click",function(){const s=t.CHM(e).$implicit,_=t.oxw(2).$implicit,m=t.oxw(3);return t.KtG(m.attributeExpandedToggle(_.versionNumber,s.name))}),t.TgZ(2,"div"),t._uU(3),t.qZA(),t.TgZ(4,"div"),t.YNc(5,F,2,1,"ng-container",0),t.qZA(),t.TgZ(6,"div",22)(7,"i"),t._uU(8),t.qZA()()(),t.YNc(9,B,2,1,"div",23),t.qZA()}if(2&n){const e=o.$implicit,i=t.oxw(2).$implicit,a=t.oxw(3);t.xp6(2),t.Gre("eav-row-main__label eav-history-",e.change,""),t.xp6(1),t.hij(" ",e.name," "),t.xp6(1),t.Gre("eav-row-main__value eav-history-",e.change,""),t.xp6(1),t.Q6J("ngIf",!a.expandedAttributes[i.versionNumber+e.name]),t.xp6(3),t.hij("[",e.dataType,"]"),t.xp6(1),t.Q6J("ngIf",a.expandedAttributes[i.versionNumber+e.name])}}function L(n,o){if(1&n){const e=t.EpF();t.TgZ(0,"button",31),t.NdJ("click",function(){t.CHM(e);const a=t.oxw(2).$implicit,s=t.oxw(3);return t.KtG(s.restore(a.changeSetId))}),t._uU(1," Restore "),t.qZA()}}function G(n,o){if(1&n&&(t.ynx(0),t.YNc(1,q,10,10,"div",17),t.TgZ(2,"div",18),t.YNc(3,L,2,0,"button",19),t.qZA(),t.BQk()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngForOf",e.attributes),t.xp6(2),t.Q6J("ngIf",!e.isLastVersion)}}function K(n,o){if(1&n){const e=t.EpF();t.TgZ(0,"mat-expansion-panel",16),t.NdJ("expandedChange",function(a){const _=t.CHM(e).$implicit,m=t.oxw(3);return t.KtG(m.panelExpandedChange(a,_.versionNumber))}),t.TgZ(1,"mat-expansion-panel-header")(2,"mat-panel-title"),t._uU(3),t.qZA(),t.TgZ(4,"mat-panel-description"),t._uU(5),t.ALo(6,"date"),t.qZA()(),t.YNc(7,G,4,2,"ng-container",0),t.qZA()}if(2&n){const e=o.$implicit,i=t.oxw(3);t.Q6J("expanded",i.expandedPanels[e.versionNumber]),t.xp6(3),t.hij("Version ",e.versionNumber,""),t.xp6(2),t.Oqu(t.xi3(6,4,e.timeStamp,"yyyy-MM-dd hh:mm")),t.xp6(2),t.Q6J("ngIf",i.expandedPanels[e.versionNumber])}}function W(n,o){if(1&n&&(t.TgZ(0,"mat-accordion",14),t.YNc(1,K,8,7,"mat-expansion-panel",15),t.qZA()),2&n){const e=t.oxw().ngIf;t.xp6(1),t.Q6J("ngForOf",e.historyItems)}}function D(n,o){if(1&n){const e=t.EpF();t.TgZ(0,"mat-paginator",32),t.NdJ("page",function(a){t.CHM(e);const s=t.oxw(2);return t.KtG(s.pageChange(a))}),t.qZA()}if(2&n){const e=t.oxw().ngIf,i=t.oxw();t.Q6J("length",e.length)("pageSize",e.pageSize)("pageSizeOptions",i.pageSizeOptions)}}function R(n,o){if(1&n){const e=t.EpF();t.ynx(0),t.TgZ(1,"div",1)(2,"div",2)(3,"div",3),t._uU(4,"Item History"),t.qZA(),t.TgZ(5,"button",4),t.NdJ("click",function(){t.CHM(e);const a=t.oxw();return t.KtG(a.closeDialog())}),t.TgZ(6,"mat-icon"),t._uU(7,"close"),t.qZA()()(),t.TgZ(8,"div",5)(9,"p"),t._uU(10,"Check version history for this item and restore the version you need."),t.qZA(),t.YNc(11,U,7,1,"div",6),t.TgZ(12,"div"),t.YNc(13,E,2,0,"div",0),t.YNc(14,Y,2,0,"div",0),t.YNc(15,W,2,1,"mat-accordion",7),t.qZA(),t.YNc(16,D,1,3,"mat-paginator",8),t.qZA()(),t.BQk()}if(2&n){const e=o.ngIf;t.xp6(11),t.Q6J("ngIf",(null==e.historyItems?null:e.historyItems.length)>0),t.xp6(2),t.Q6J("ngIf",null===e.historyItems),t.xp6(1),t.Q6J("ngIf",0===(null==e.historyItems?null:e.historyItems.length)),t.xp6(1),t.Q6J("ngIf",(null==e.historyItems?null:e.historyItems.length)>0),t.xp6(1),t.Q6J("ngIf",(null==e.historyItems?null:e.historyItems.length)>0)}}let X=(()=>{var n;class o{constructor(i,a,s,_){this.dialogRef=i,this.route=a,this.versionsService=s,this.snackBar=_,this.hostClass="dialog-component",this.pageSizeOptions=[10,20,50],this.expandedPanels={},this.expandedAttributes={},this.itemId=parseInt(this.route.snapshot.paramMap.get("itemId"),10),this.versions$=new u.X(null),this.page$=new u.X(1),this.pageSize$=new u.X(this.pageSizeOptions[0]),this.compareWith$=new u.X("live"),this.historyItems$=(0,f.a)([this.versions$,this.page$,this.pageSize$,this.compareWith$]).pipe((0,x.U)(([m,c,p,l])=>function b(n,o,e,i){return null==n||null==o||null==e||null==i?null:function T(n,o,e){return n.map(i=>({changeSetId:i.ChangeSetId,attributes:Z(i,o,e),historyId:i.HistoryId,timeStamp:i.TimeStamp,user:i.User,versionNumber:i.VersionNumber,isLastVersion:!o.some(s=>s.VersionNumber===i.VersionNumber+1)}))}(n.slice((o-1)*e,o*e),n,i)}(m,c,p,l))),this.viewModel$=(0,f.a)([this.versions$,this.historyItems$,this.pageSize$,this.compareWith$]).pipe((0,x.U)(([m,c,p,l])=>({length:m?.length,historyItems:c,pageSize:p,compareWith:l})))}ngOnInit(){this.versionsService.fetchVersions(this.itemId).subscribe(i=>{this.versions$.next(i)})}ngOnDestroy(){this.versions$.complete(),this.page$.complete(),this.pageSize$.complete(),this.compareWith$.complete()}closeDialog(){this.dialogRef.close()}compareChange(i){this.compareWith$.next(i)}panelExpandedChange(i,a){this.expandedPanels[a]=i}attributeExpandedToggle(i,a){this.expandedAttributes[i+a]=!this.expandedAttributes[i+a]}pageChange(i){const a=i.pageIndex+1;a!==this.page$.value&&(this.expandedPanels={},this.expandedAttributes={},this.page$.next(a));const s=i.pageSize;s!==this.pageSize$.value&&this.pageSize$.next(s)}restore(i){this.snackBar.open("Restoring previous version..."),this.versionsService.restore(this.itemId,i).subscribe(a=>{this.snackBar.open("Previous version restored. Will reload edit dialog",null,{duration:3e3}),this.dialogRef.close({refreshEdit:!0})})}}return(n=o).\u0275fac=function(i){return new(i||n)(t.Y36(H.so),t.Y36(N.gz),t.Y36(A.Z),t.Y36($.ux))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-item-history"]],hostVars:1,hostBindings:function(i,a){2&i&&t.Ikx("className",a.hostClass)},decls:2,vars:3,consts:[[4,"ngIf"],[1,"eav-dialog","eav-no-scrollbar"],[1,"eav-dialog-header"],[1,"eav-dialog-header__title"],["mat-icon-button","","tippy","Close dialog",3,"click"],[1,"eav-dialog-content"],["class","eav-compare-box",4,"ngIf"],["multi","","class","eav-history-tables",4,"ngIf"],["color","accent","showFirstLastButtons","true",3,"length","pageSize","pageSizeOptions","page",4,"ngIf"],[1,"eav-compare-box"],["color","accent",1,"eav-form-field","eav-compare-box__dropdown"],["name","Scope",3,"value","selectionChange"],["value","previous"],["value","live"],["multi","",1,"eav-history-tables"],[3,"expanded","expandedChange",4,"ngFor","ngForOf"],[3,"expanded","expandedChange"],["class","eav-table-row",4,"ngFor","ngForOf"],[1,"eav-row-actions"],["mat-raised-button","","color","accent",3,"click",4,"ngIf"],[1,"eav-table-row"],[1,"eav-table-row__main","eav-row-main",3,"click"],[1,"eav-row-main__type"],["class","eav-table-row__details",4,"ngIf"],[1,"eav-table-row__details"],["class","eav-detail-row",4,"ngFor","ngForOf"],[1,"eav-detail-row"],[1,"eav-detail-row__value"],[3,"class",4,"ngIf"],[1,"eav-history-new"],[1,"eav-history-deleted","eav-history-deleted__value"],["mat-raised-button","","color","accent",3,"click"],["color","accent","showFirstLastButtons","true",3,"length","pageSize","pageSizeOptions","page"]],template:function(i,a){1&i&&(t.YNc(0,R,17,5,"ng-container",0),t.ALo(1,"async")),2&i&&t.Q6J("ngIf",t.lcZ(1,1,a.viewModel$))},dependencies:[h.sg,h.O5,S.$,C.lW,C.RK,J.Hw,g.pp,g.ib,g.yz,g.yK,g.u4,M.NW,P.KE,Q.gD,z.ey,h.Ov,h.uU],styles:[".eav-compare-box[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;align-items:flex-end;height:40px}.eav-compare-box__dropdown[_ngcontent-%COMP%]{width:192px;margin-top:-14px;font-size:14px;height:auto}.eav-accordion[_ngcontent-%COMP%]{display:block;padding:4px 0}.eav-expansion-panel-header[_ngcontent-%COMP%], .eav-table-row[_ngcontent-%COMP%]{font-size:14px}.eav-table-row__main[_ngcontent-%COMP%]{display:flex}.eav-table-row__details[_ngcontent-%COMP%]{display:block}.eav-row-main[_ngcontent-%COMP%]{cursor:pointer;padding:4px 0}.eav-row-main__label[_ngcontent-%COMP%]{width:160px;flex:0 0 auto}.eav-row-main__value[_ngcontent-%COMP%]{flex:1 1 auto}.eav-row-main__type[_ngcontent-%COMP%]{flex:0 0 auto;font-size:12px}.eav-row-main__type[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]:not(:last-of-type){margin-right:2px}.eav-detail-row[_ngcontent-%COMP%]{display:flex;padding-bottom:4px;cursor:default}.eav-detail-row__label[_ngcontent-%COMP%]{width:160px;flex:0 0 auto}.eav-detail-row__value[_ngcontent-%COMP%]{flex:1 1 auto}.eav-row-actions[_ngcontent-%COMP%]{margin-top:16px;display:flex;justify-content:flex-end}"]}),o})()}}]);
//# sourceMappingURL=https://sources.2sxc.org/16.08.00/dist/ng-edit/projects_eav-ui_src_app_item-history_item-history_component_ts.3e90b8275e8a324c.js.map
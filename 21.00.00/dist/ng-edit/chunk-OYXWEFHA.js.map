{
  "version": 3,
  "sources": ["projects/eav-ui/src/app/features/features.service.ts"],
  "sourcesContent": ["import { Injectable, Signal, signal } from '@angular/core';\r\nimport { Of, transient } from '../../../../core';\r\nimport { DialogConfigAppService } from '../app-administration/services/dialog-config-app.service';\r\nimport { EavEditLoadDto, RequiredFeatures } from '../edit/dialog/main/edit-dialog-main.models';\r\nimport { classLog } from '../shared/logging';\r\nimport { DialogContext } from '../shared/models/dialog-settings.model';\r\nimport { ComputedCacheHelper } from '../shared/signals/computed-cache';\r\nimport { computedObj, signalObj } from '../shared/signals/signal.utilities';\r\nimport { FeatureNames } from './feature-names';\r\nimport { FeaturesDisableAutoLoadService } from './features-disable-autoload.service';\r\nimport { FeatureSummary } from './models/feature-summary.model';\r\n\r\nconst logSpecs = {\r\n  all: false,\r\n  constructor: true,\r\n  load: false,\r\n  getAll: false,\r\n  requireFeature: true,\r\n  unlicensedFeatures: true,\r\n};\r\n\r\n/**\r\n * Service to provide information about enabled/disabled features.\r\n */\r\n@Injectable()\r\nexport class FeaturesService {\r\n\r\n  log = classLog({FeaturesService}, logSpecs);\r\n\r\n  #dialogConfigSvc = transient(DialogConfigAppService);\r\n\r\n  constructor(disableAutoLoad: FeaturesDisableAutoLoadService) {\r\n    this.log.fnIf('constructor');\r\n\r\n    // If auto-load is disable (special edge case when opening the dialog directly to the edit-form)\r\n    // then don't do this, because in some cases the person opening the dialog doesn't have the necessary permission.\r\n    if (!disableAutoLoad.disableAutoLoad)\r\n      this.#dialogConfigSvc.getCurrent$().subscribe(ds => this.load(ds.Context));\r\n    else\r\n      this.log.a('auto-load disabled');\r\n  }\r\n\r\n  load(dialogContext: DialogContext, formData?: EavEditLoadDto) {\r\n    this.log.fnIf('load', { formData, dialogContext });\r\n    this.#dialogContext.set(dialogContext);\r\n    this.#reqFeaturesForm.set(formData?.RequiredFeatures ?? {} as RequiredFeatures);\r\n  }\r\n\r\n  // Provide context information and ensure that previously added data is always available\r\n  #dialogContext = signal<DialogContext>(null);\r\n\r\n  /** Required features specified by the entire form */\r\n  #reqFeaturesForm = signalObj('reqFeaturesForm', {} as RequiredFeatures);\r\n\r\n  /** Required features specified by specific fields */\r\n  #reqFeaturesFields = signalObj('reqFeaturesFields', {} as RequiredFeatures);\r\n\r\n  /** All required features merged */\r\n  #reqFeatures = computedObj<RequiredFeatures>('requiredFeatures', () => {\r\n    const req = this.#reqFeaturesForm();\r\n    const fields = this.#reqFeaturesFields();\r\n    return {...req, ...fields};\r\n  });\r\n\r\n  requireFeature(feature: Of<typeof FeatureNames>, reason: string) {\r\n    const l = this.log.fnIf('requireFeature', { feature, reason });\r\n    const current = this.#reqFeaturesFields();\r\n    if (!Object.keys(current).includes(feature))\r\n      this.#reqFeaturesFields.update(current => ({...current, [feature]: [reason]}));\r\n    else if (!current[feature].includes(reason))\r\n      this.#reqFeaturesFields.update(current => ({...current, [feature]: [...current[feature], reason]}));\r\n    l.end('final', this.#reqFeaturesFields());\r\n  }\r\n\r\n\r\n  public unlicensedFeatures = computedObj<string[]>('unlicensedFeatures', () => {\r\n    const req = this.#reqFeatures();\r\n    const allowed = this.getAll()().filter(f => f.allowUse);\r\n    const missing = Object.keys(req).filter(nameId => !allowed.some(f => f.nameId === nameId));\r\n    this.log.aIf('unlicensedFeatures', { req, allowed, missing });\r\n    return missing;\r\n  });\r\n\r\n  public hasUnlicensedFeatures = computedObj('hasUnlicensedFeatures', () => this.unlicensedFeatures().length > 0);\r\n\r\n  getAll(): Signal<FeatureSummary[]> {\r\n    this.log.fnIf('getAll');\r\n    return computedObj('all-features', () => this.#dialogContext()?.Features ?? []);\r\n  }\r\n\r\n  getCurrent(featureNameId: string): FeatureSummary {\r\n    return this.#dialogContext()?.Features.find(f => f.nameId === featureNameId);\r\n  }\r\n\r\n  /**\r\n   * Property providing enabled, which behaves like a Record<string, Signal<boolean>>.\r\n   */\r\n  public isEnabled = new ComputedCacheHelper<Of<typeof FeatureNames>, boolean>('isEnabledCache').buildProxy(nameId => () => {\r\n    return this.#dialogContext()?.Features.find(f => f.nameId === nameId)?.isEnabled ?? false;\r\n  });\r\n\r\n  /**\r\n   * Property providing allowUse, which behaves like a Record<string, Signal<boolean>>.\r\n   * This is primarily meant for the field-wrapper, which\r\n   * - should show warnings etc. if not allowed\r\n   * - but in edge cases it is allowed, eg. when editing data on a system content-type\r\n   */\r\n  public allowUse = new ComputedCacheHelper<Of<typeof FeatureNames>, boolean>('isEnabledCache').buildProxy(nameId => () => {\r\n    return this.#dialogContext()?.Features.find(f => f.nameId === nameId)?.allowUse ?? false;\r\n  });\r\n\r\n}\r\n"],
  "mappings": "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",
  "names": ["logSpecs", "all", "constructor", "load", "getAll", "requireFeature", "unlicensedFeatures", "FeaturesService", "#dialogConfigSvc", "disableAutoLoad", "log", "classLog", "transient", "DialogConfigAppService", "#dialogContext", "signal", "#reqFeaturesForm", "signalObj", "#reqFeaturesFields", "#reqFeatures", "computedObj", "req", "fields", "__spreadValues", "allowed", "filter", "f", "allowUse", "missing", "Object", "keys", "nameId", "some", "aIf", "hasUnlicensedFeatures", "length", "isEnabled", "ComputedCacheHelper", "buildProxy", "Features", "find", "fnIf", "a", "getCurrent$", "subscribe", "ds", "Context", "dialogContext", "formData", "set", "RequiredFeatures", "feature", "reason", "l", "current", "includes", "update", "__spreadProps", "end", "getCurrent", "featureNameId", "\u0275\u0275inject", "FeaturesDisableAutoLoadService", "factory", "\u0275fac"]
}

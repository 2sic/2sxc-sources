import{a as w}from"./chunk-WPH6VOLC.js";import{a as te,b as O}from"./chunk-VHSKZVJN.js";import{a as Ct}from"./chunk-QUYVM733.js";import{c as qt}from"./chunk-HJXR3IL7.js";import{a as G,b as Qt,d as wt,e as F,h as Kt,j as Et,k as H,m as _t}from"./chunk-VT6LNH6I.js";import{a as R}from"./chunk-NVCP7HH3.js";import{a as Yt,b as Zt}from"./chunk-YHKI2L7W.js";import{a as Xt}from"./chunk-R3Y7P2GW.js";import{a as et}from"./chunk-37NMTDTM.js";import{b as Jt}from"./chunk-WAPW5AUJ.js";import{c as zt}from"./chunk-HCPBPEHV.js";import{a as Z,b as S}from"./chunk-RGKBOUPL.js";import{b as Ut}from"./chunk-EZZQWHAZ.js";import{a as Y}from"./chunk-OIHIMR2W.js";import{aa as h,t as Wt,u as Bt}from"./chunk-DX662RXJ.js";import{Aa as Ht,Ca as tt,F as St,Y as Rt,ea as g,g as J,ia as b,o as Mt,u as q,v as Gt}from"./chunk-46QINP2S.js";import{a as u,b as d,d as $t}from"./chunk-BDOJB7O2.js";var ee=(()=>{class o{constructor(t){this.snackBar=t,this.logs$=new J([]),this.logLimit=50,this.lastSnackBarTime=0,this.snackBarDebounce=1e4}ngOnDestroy(){this.logs$.complete()}addLog(t,s,r){let i={error:r,label:s,severity:t,time:Date.now()},n=this.logs$.value,a=[i,...n.slice(0,this.logLimit-2)];this.logs$.next(a)}showMessage(t,s,r){let i=Date.now();!r&&i-this.lastSnackBarTime<=this.snackBarDebounce||(s!=null&&s>0?this.snackBar.open(t,null,{duration:s}):this.snackBar.open(t),this.lastSnackBarTime=i)}getLogs$(){return this.logs$.asObservable()}getLogsSignal(){return Jt(this.logs$)}static{this.\u0275fac=function(s){return new(s||o)(b(zt))}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac})}}return o})(),Q={Error:"error",Log:"log",Warn:"warn"};var se="user-settings",Me=(()=>{class o{constructor(){this.log=h({UserPreferences:o}),this.#s={},this.log.fn("constructor")}get local(){return this.#t??=new Bt(se)}#t;get session(){return this.#e??=new Wt(se)}#e;get(t,s=!1){return(s?this.local:this.session).get(t)}set(t,s,r=!1){(r?this.local:this.session).add(t,s)}part({key:t,data:s}){return this.#r(t,s,!0)}#r(t,s,r=!1){if(this.#s[t])return this.#s[t];let i=new xt(this,t,s,r);return this.#s[t]=i,i}#s;static{this.\u0275fac=function(s){return new(s||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})(),xt=class o{constructor(e,t,s,r=!1){this.userSettings=e,this.storeKey=t,this.longTerm=r,this.log=h({UserPreferencesPart:o});let i=u(u({},s),e.get(t,r));this.log.fn("constructor",i),this.#t=Ht(i)}#t;get snapshot(){return this.#t()}get data(){return this.#t.asReadonly()}get(e){return this.#t()[e]}set(e,t){this.#t.update(s=>d(u({},s),{[e]:t})),this.#e()}toggle(e){this.#t.update(t=>d(u({},t),{[e]:!t[e]})),this.#e()}setAll(e){this.#t.set(e),this.#e()}setMany(e){this.#t.update(t=>u(u({},t),e)),this.#e()}#e(){let e=this.#t();this.log.fn("save",e),this.userSettings.set(this.storeKey,this.#t(),this.longTerm)}};var He={key:"edit-dialog-footer",data:{tab:null,expanded:!1,size:0,pinned:null}};var st=class o{static dtoToEav(e){let t=T.dtoToEavMany(e.Metadata),s=k.mergeSettings(t);return{InputType:e.InputType,IsTitle:e.IsTitle,Metadata:t,Name:e.Name,Settings:s,Type:e.Type}}static dtoToEavMany(e){return e==null?[]:e.map(s=>o.dtoToEav(s))}};var D=class{static create(e){return{dimCode:e}}};var T=class o{static dtoToEav(e){let t=k.dtoToEav(e.Attributes),s=this.dtoToEavMany(e.Metadata);return{Attributes:t,Guid:e.Guid,Id:e.Id,Owner:e.Owner,Type:e.Type,Version:e.Version,For:e.For??null,Metadata:s}}static dtoToEavMany(e){return e==null?null:e.map(s=>o.dtoToEav(s))}};var k=class{static dtoToEav(e){let t={};for(let[s,r]of Object.entries(e))for(let[i,n]of Object.entries(r))t[i]=rt.dtoToEav(n,s);return t}static mergeSettings(e){if(e==null)return{};let t={};for(let s of e)if(s.Type.Id!=="@All")for(let[r,i]of Object.entries(s.Attributes)){let n=u({},i);t[r]=n}for(let s of e)if(s.Type.Id==="@All")for(let[r,i]of Object.entries(s.Attributes)){let n=t[r]!=null,a=i.Values[0].value==="";if(n&&a)continue;let l=u({},i);t[r]=l}return t}};var rt=class{static dtoToEav(e,t){return{Values:E.dtoToEav(e),Type:t}}};var E=class{static create(e,t){return{value:e,dimensions:t}}static dtoToEav(e){return Object.entries(e).map(([s,r])=>{let i=s.split(",").map(n=>D.create(n));return this.create(r,i)})}static createEavFieldValue(e){return[{value:e,dimensions:[{dimCode:"*"}]}]}};var it=class o{static anyToEav(e){let t=e.Header.ClientData?.overrideContents;return t?o.objToEav(t,e.Header,e.Entity):o.dtoToEav(e)}static dtoToEav(e){return{Entity:T.dtoToEav(e.Entity),Header:e.Header}}static objToEav(e,t,s){let r={};for(let n in e){let a=e[n],l=this.getType(a);r[n]={Values:E.createEavFieldValue(a),Type:l}}let i=T.dtoToEav(s);return i.Attributes=r,{Entity:i,Header:t}}static eavToObj(e){let t=e.Entity.Attributes,s={};for(let r in t){let i=t[r];!i.Values||i.Values.length===0||(s[r]=i.Values[0].value)}return s}static getType(e){switch(typeof e){case"string":return"String";case"number":return"Number";case"boolean":return"Boolean";default:return"Unknown"}}};var nt=class o{static dtoToEav(e){let t=st.dtoToEavMany(e.Attributes),s=T.dtoToEavMany(e.Metadata),r=k.mergeSettings(s);return{Attributes:t,Id:e.Id,Metadata:s,Name:e.Name,Scope:e.Scope,Settings:r,Title:e.Title}}static dtoToEavMany(e){return e==null?null:e.map(s=>o.dtoToEav(s))}};var re=(()=>{class o extends G{constructor(){super(h({ContentTypeItemService:o})),this.getId=t=>t.Guid}addContentTypeItems(t){let s=T.dtoToEavMany(t);this.addMany(s)}static{this.\u0275fac=function(s){return new(s||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var ot=class{static getContentTypeNameId(e){return e.Entity.Type?.Id??e.Header.ContentTypeName}};var at=(()=>{class o extends G{constructor(){super(h({ContentTypeService:o})),this.getId=t=>t.Id}addContentTypes(t){let s=nt.dtoToEavMany(t);this.addMany(s)}getContentTypeOfItem(t){let s=ot.getContentTypeNameId(t);return this.get(s)}getAttribute(t,s){return this.get(t).Attributes.find(r=>r.Name===s)}getAttributeOfItem(t,s){return this.getContentTypeOfItem(t).Attributes.find(r=>r.Name===s)}static{this.\u0275fac=function(s){return new(s||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var ne=(()=>{class o extends G{constructor(){super(h({InputTypeService:o},null)),this.getId=t=>t.Type}getAttributeInputTypes(t){let s=this.getAll();return t.map(r=>{let i=this.#t(r.InputType,s);return{name:r.Name,inputType:i.inputType}})}getSpecs(t){return this.#t(t.InputType,this.getAll())}#t(t,s){let r=s.find(a=>a.Type===t),i=t.toString();return{inputType:t,isExternal:!!r?.UiAssets?.default,mustUseGuid:!i.startsWith("string")&&!i.startsWith("number"),componentTagName:`field-${t}`,componentTagDialogName:`field-${t}-dialog`,metadata:r,isNewPicker:w.isNewPicker(t)}}static{this.\u0275fac=function(s){return new(s||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var j=class o{constructor(){this.log=h({FieldWriter:o})}#t(e,t,s){let r={};if(Object.keys(e).length===0){let i=u({},s);return r[t]=i,r}for(let i of Object.keys(e))if(i===t){let n=u({},s);r[i]=n}else{let n=u({},e[i]);r[i]=n}if(e[t]==null){let i=u({},s);r[t]=i}return r}updateAttributesValues(e,t,s){let r=this.log.fn("updateAttributesValues",{allFields:e,updateValues:t,language:s}),i={};return Object.keys(e).forEach(n=>{let a=t[n];if(a!==void 0)if(new F(e[n],s).isEditableOrReadonlyTranslationExist()){let c=d(u({},e[n]),{Values:e[n].Values.map(p=>new wt(p.dimensions,s).hasCurrent?d(u({},p),{value:a}):p)});i[n]=c}else{r.a("saveAttributeValues add values ",{newItemValue:a});let c=E.create(a,[D.create(s.current)]);i[n]=d(u({},e[n]),{Values:[...e[n].Values,c]})}else i[n]=u({},e[n])}),i}updateAttributeValue(e,t,s,r,i){let n={},a=r.current;i&&(a=`~${r.current}`);let l=d(u({},e[t]),{Values:e[t].Values.map(m=>new wt(m.dimensions,r).hasCurrent?d(u({},m),{value:s,dimensions:m.dimensions.map(f=>f.dimCode===r.current||f.dimCode===`~${r.current}`||r.current===r.primary&&f.dimCode==="*"?{dimCode:a}:f)}):m)});return n=this.#t(e,t,l),n}addAttributeValue(e,t,s,r){let i={},n=Object.keys(e).length===0||!e[s]?d(u({},e[s]),{Values:[t],Type:r}):d(u({},e[s]),{Values:[...e[s].Values,t],Type:r});return i=this.#t(e,s,n),i}addAttributeDimension(e,t,s,r,i,n){let a={},l=s;n&&(l=`~${s}`);let m=d(u({},e[t]),{Values:e[t].Values.map(c=>c.dimensions.find(f=>f.dimCode===r||r===i&&f.dimCode==="*")?d(u({},c),{dimensions:c.dimensions.concat({dimCode:l})}):c)});return a=this.#t(e,t,m),a}removeAttributeDimension(e,t,s){let r=e,i=[s,`~${s}`],n=r[t].Values.find(m=>m.dimensions.some(p=>i.includes(p.dimCode)));if(!n)return u({},r);let a;return n.dimensions.length>1?a=d(u({},r[t]),{Values:r[t].Values.map(m=>m.dimensions.some(p=>i.includes(p.dimCode))?d(u({},m),{dimensions:m.dimensions.filter(p=>!i.includes(p.dimCode))}):m)}):n.dimensions.length===1&&(a=d(u({},r[t]),{Values:r[t].Values.filter(m=>!m.dimensions.some(p=>i.includes(p.dimCode)))})),this.#t(r,t,a)}};var Ie={all:!0,updateItemId:!1,updateItemHeader:!1,addItemAttributeValue:!1,updateItemAttributeValue:!1,setDefaultValue:!1,updateItemAttributesValues:!1,addItemAttributeDimension:!1,removeItemAttributeDimension:!1,updateItemMetadata:!1},lt=class o{constructor(e){this.itemSvc=e,this.log=h({ItemUpdateHelper:o},Ie)}updateItemId(e){let t=this.log.fnIf("updateItemId",{saveResult:e}),s=Object.keys(e)[0],r=e[s],i=this.itemSvc.get(s);if(!i||i.Header.EntityId!==0&&i.Entity.Id!==0)return;let n=d(u({},i),{Header:d(u({},i.Header),{EntityId:r}),Entity:d(u({},i.Entity),{Id:r})});this.itemSvc.add(n)}updateItemHeader(e,t){let s=this.log.fnIf("updateItemHeader",{entityGuid:e,header:t}),r=this.itemSvc.get(e);if(!r)return;let i=d(u({},r),{Header:u({},t)});this.itemSvc.add(i),s.end()}addItemAttributeValue(e,t,s,r,i,n,a=!1,l){let m=this.log.fnIf("addItemAttributeValue",{entityGuid:e,attributeKey:t,newValue:s,currentLanguage:r,isReadOnly:i,attributeType:n,isTransaction:a,transactionItem:l}),c=i?`~${r}`:r,p=E.create(s,[D.create(c)]),f=l??this.itemSvc.get(e),y=d(u({},f),{Entity:d(u({},f.Entity),{Attributes:new j().addAttributeValue(f.Entity.Attributes,p,t,n)})});return a||this.itemSvc.add(y),y}updateItemAttributeValue(e,t,s,r,i){let n=this.log.fnIf("updateItemAttributeValue",{entityGuid:e,attributeKey:t,newValue:s,language:r,isReadOnly:i}),a=this.itemSvc.get(e);if(!a)return;let l=d(u({},a),{Entity:d(u({},a.Entity),{Attributes:new j().updateAttributeValue(a.Entity.Attributes,t,s,r,i)})});this.itemSvc.add(l)}setDefaultValue(e,t,s,r,i,n){let a=this.log.fnIf("setDefaultValue",{item:e,ctAttribute:t,inputType:s,settings:r,languages:i,defaultLanguage:n},`Name: ${t.Name}`),l=new _t(t.Name,s?.Type,r,e.Header).getDefaultOrPrefillValue(),m=new F(e.Entity.Attributes[t.Name],n).currentOrDefault?.value,c=i.length===0||s?.DisableI18n?"*":n;return m===void 0?this.addItemAttributeValue(e.Entity.Guid,t.Name,l,c,!1,t.Type):this.updateItemAttributeValue(e.Entity.Guid,t.Name,l,{current:c,primary:n},!1),a.r(l)}updateItemAttributesValues(e,t,s){let r=this.log.fnIf("updateItemAttributesValues",{entityGuid:e,newValues:t,language:s}),i=this.itemSvc.get(e);if(!i)return r.end("Item not found");let n=new H(s),a={},l=Object.entries(i.Entity.Attributes).filter(([f])=>t.hasOwnProperty(f));for(let[f,y]of l)a[f]=n.getBestValue(y);let m=te.getItemValuesChanges(a,t);if(m==null)return r.end("No changes");let c=new j().updateAttributesValues(i.Entity.Attributes,m,s),p=d(u({},i),{Entity:d(u({},i.Entity),{Attributes:c})});this.itemSvc.add(p)}addItemAttributeDimension(e,t,s,r,i,n,a){let l=this.log.fnIf("addItemAttributeDimension",{entityGuid:e,attributeKey:t,currentLanguage:s,shareWithLanguage:r,defaultLanguage:i,isReadOnly:n,transactionItem:a}),m=a??this.itemSvc.get(e),c=d(u({},m),{Entity:d(u({},m.Entity),{Attributes:new j().addAttributeDimension(m.Entity.Attributes,t,s,r,i,n)})});this.itemSvc.add(c)}removeItemAttributeDimension(e,t,s,r=!1,i){let n=this.log.fnIf("removeItemAttributeDimension",{entityGuid:e,attributeKey:t,currentLanguage:s,isTransaction:r,transactionItem:i}),a=i??this.itemSvc.get(e),l=d(u({},a),{Entity:d(u({},a.Entity),{Attributes:new j().removeAttributeDimension(a.Entity.Attributes,t,s)})});return r||this.itemSvc.add(l),n.r(l)}updateItemMetadata(e,t){let s=this.log.fnIf("updateItemMetadata",{entityGuid:e,metadata:t}),r=this.itemSvc.get(e),i=d(u({},r),{Entity:d(u({},r.Entity),{Metadata:t})});this.itemSvc.add(i),s.end("ok",{newItem:i})}};var W=(()=>{class o extends Qt{constructor(){super(h({ItemService:o})),this.getId=t=>t.Entity.Guid,this.updater=new lt(this),this.#t=new et("itemAttributes"),this.#e=new et("itemHeader"),this.#r=new et("slotIsEmpty")}loadItems(t){let s=t.map(r=>it.anyToEav(r));this.addMany(s)}itemAttributesSignal(t){let s=this.log.fn("itemAttributes",{entityGuid:t}),r=this.#t.getOrCreate(t,()=>this.getSignal(t)()?.Entity.Attributes);return s.r(r)}#t;getItemAttributes(t){let s=this.log.fn("getItemAttributes",{entityGuid:t}),r=this.get(t)?.Entity.Attributes;return s.r(r)}getItemAttributes$(t){return this.list$.pipe(q(s=>s.find(r=>r.Entity.Guid===t)?.Entity.Attributes),Yt(s=>s))}getItemHeader(t){return this.get(t)?.Header}getItemHeader$(t){return this.list$.pipe(q(s=>s.find(r=>r.Entity.Guid===t)?.Header),Zt(s=>s))}getItemHeaderSignal(t){return this.#e.getOrCreate(t,()=>this.getSignal(t)()?.Header)}#e;slotIsEmpty(t){return this.#r.getOrCreate(t,()=>{let s=this.getSignal(t)()?.Header;return s==null?!0:s.IsEmptyAllowed&&s.IsEmpty})}#r;getItemFor(t){return this.get(t)?.Entity.For}getItemNote(t){return this.get(t)?.Entity.Metadata?.find(s=>s.Type.Name===qt.contentTypes.notes)}static{this.\u0275fac=function(s){return new(s||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var C="Field.Settings.",P={Disabled:`${C}Disabled`,Name:`${C}Name`,Notes:`${C}Notes`,Required:`${C}Required`,Value:"Field.Value",Visible:`${C}Visible`,Validation:"Field.Validation"},oe=Object.values(P),N={Options:"Field.Options",Selected:"Field.Selected"},ae=Object.values(N),Vt=[N.Options,N.Selected],Qs=[N.Options,N.Selected],X={Collapsed:`${C}Collapsed`,DropdownValues:`${C}DropdownValues`},le=Object.values(X),ue=u(u(u({},P),X),N);var K="function ",ve=`v2((data, context) => {
  return data.value;
});`,_s=ve,Te=`v2((data, context, item) => {
  return data.value;
});`,tr=Te,I={V1:"v1",V2:"v2"};var ce={all:!1,constructor:!0,update:!0,fields:[...O,"Icon"]},ut=class o{get log(){return this.#t??=h({FieldLogicBase:o},ce).extendName(`[${this.name}]`)}#t;constructor(e,t){this.canAutoTranslate=!1,this.#t=h(e??{FieldLogicBase:o},ce,null,t),this.name??=this.#t.name,this.log.fnIf("constructor")}static add(e){let t=new e;B.singleton().add(t)}static importMe(){}isValueEmpty(e,t){let s=this.log.fn("isValueEmpty",{value:e,isCreateMode:t}),r=Array.isArray(e)&&e.length===0&&t;return s.r(e===void 0||r)}findAndMergeAdvanced(e,t,s){if(!t)return s;let r=e.eavConfig.settings.Entities.find(n=>n.Guid===t);if(!r)return s;let i=e.reader.flatten(r);return u(u({},s),i)}};var ct=class o extends ut{constructor(){super({UnknownLogic:o}),this.name=R.Unknown,this.canAutoTranslate=!1}update({settings:e}){return e}};var Se={all:!1,get:!0},B=class o{constructor(){this.logics={},this.log=h({FieldLogicManager:o},Se),this.add(new ct)}static singleton(){return window.eavFieldLogicManager??=new o}add(e){this.logics[e.name]=e}get(e){let t=this.log.fnIf("get",{inputTypeName:e}),s=this.logics[e]??null;return t.r(s)}getOrUnknown(e){return this.get(e)??this.get(R.Unknown)}};var v={Translate:"Translate",DontTranslate:"DontTranslate",MissingDefaultLangValue:"MissingDefaultLangValue",LinkReadOnly:"LinkReadOnly",LinkReadWrite:"LinkReadWrite",LinkCopyFrom:"LinkCopyFrom"};var mt=class o{static getTranslationStateClass(e){switch(e){case v.MissingDefaultLangValue:return"localization-missing-default-lang-value";case v.Translate:case v.LinkCopyFrom:return"localization-translate";case v.DontTranslate:return"";case v.LinkReadOnly:return"localization-link-read-only";case v.LinkReadWrite:return"localization-link-read-write";default:return""}}static calculateSharedInfoMessage(e,t){e=o.calculateShortDimensions(e,t);let s=o.calculateEditAndReadDimensions(e),r=s.editableDimensions,i=s.readOnlyDimensions,n="",a=r.length>0,l=i.length>0;return a&&l?n=`${r.join(", ")}, (${i.join(", ")})`:a?n=r.join(", "):l&&(n=`(${i.join(", ")})`),n}static calculateShortDimensions(e,t){let s={},r=t.slice(0,t.indexOf("-"));return s[r]=[r],e.forEach(i=>{let a=i.slice(0,i.indexOf("-")).replace("~","");s[a]?s[a].push(i):s[a]=[i]}),e=e.map(i=>{let n=i.slice(0,i.indexOf("-")),a=n.replace("~","");return s[a].length>1?i:n}),e}static calculateEditAndReadDimensions(e){return{editableDimensions:[],readOnlyDimensions:e.map(t=>t.replace("~",""))}}};var we={all:!1,mergeGenericSettings:!0,getDefaultSettings:!1,fields:[...O,"GroupPreview"]},dt=class o{constructor(e){this.log=h({FieldsSettingsHelpers:o},we)}mergeGenericSettings(e,t){let s=this.log.fnIfInList("mergeGenericSettings","fields",e,{fieldName:e,settings:t}),r=t;if(r.SettingsGeneric==null)return s.r(t,"No generic settings");try{let i=JSON.parse(r.SettingsGeneric);return s.r(u(u({},t),i),"Merged generic settings")}catch(i){return console.error("mergeGenericSettings",i),s.r(t,"Error parsing generic settings")}}getDefaultSettings(e){let t=Ft.moveDeprecatedSettings(u({},e));t.Name??="",t.Placeholder??="",t.Notes??="",t.Required??=!1,t.Disabled??=!1,t.DisableTranslation??=!1,t.Visible??=!0,t.DefaultCollapsed!=null&&(t.Collapsed=t.DefaultCollapsed,delete t.DefaultCollapsed),t.Formulas??=[];let s=B.singleton().get(e.InputType);return t.DisableAutoTranslation??=!s?.canAutoTranslate,t}isLastInGroup(e,t){let s=e.Attributes.indexOf(t);if(e.Attributes[s+1]==null)return!0;let r=e.Attributes.findIndex(i=>w.isGroupStart(i.InputType));return s<r?!1:!!(w.isGroupEnd(t.InputType)||w.endsPreviousGroup(e.Attributes[s+1].InputType))}getDisabledBecauseTranslations(e,t,s){let r=new F(e,s);return s.current===s.primary?!1:!r.hasPrimary||t?!0:r.hasEditableValues?!1:(r.hasCurrentReadonly,!0)}getTranslationState(e,t,s,r){r&&this.log.fn("getTranslationState",{attributeValues:e,disableTranslation:t,language:s});let i,n,a=new F(e,s);if(t)i="LangMenu.InAllLanguages",n="";else if(!a.hasPrimary)i="LangMenu.MissingDefaultLangValue",n=s.primary;else{let c=a.hasEditableValues,p=a.hasCurrentReadonly;if(c||p){let f=a.current.dimensions.map(L=>L.dimCode).filter(L=>!L.includes(s.current));f.length>0?(c?i="LangMenu.In":p&&(i="LangMenu.From"),n=mt.calculateSharedInfoMessage(f,s.current)):(i="",n="")}else i="LangMenu.UseDefault",n=""}let l=this.#t(e,t,s);return{infoLabel:i,infoMessage:n,language:l.language,linkType:l.linkType}}#t(e,t,s){let r=new F(e,s);if(!r.hasPrimary)return{language:"",linkType:v.MissingDefaultLangValue};if(t)return{language:"",linkType:v.DontTranslate};if(r.hasEditableValues){let i=r.current.dimensions.filter(n=>n.dimCode!==s.current);return i.length>0?{language:i[0].dimCode,linkType:v.LinkReadWrite}:{language:"",linkType:v.Translate}}return r.hasCurrentReadonly?{language:r.current.dimensions.filter(n=>n.dimCode!==s.current)[0].dimCode,linkType:v.LinkReadOnly}:{language:"",linkType:v.DontTranslate}}},Ft=class{static moveDeprecatedSettings(e){var t=e;return t.VisibleInEditUI==null||(e.Visible=t.VisibleInEditUI,delete t.VisibleInEditUI),e}};var $=class{static#t(e){if(!e)return e;let t=e.trim();return t.startsWith("//")&&(t=t.replace(/^\/\/.*\n/gm,"").trim()),t.startsWith(I.V1)?`${K}${t}`:t.startsWith(`${K}${I.V1}`)?t:t.startsWith("v2(")?(t=t.substring(3,t.lastIndexOf("}")+1),t=t.replace("=>",""),`${K}v2 ${t}`):t}static findFormulaVersion(e){let t=this.#t(e),s=t.substring(K.length,t.indexOf("(")).trim();return Object.values(I).includes(s)?s:void 0}static buildFormulaFunction(e){let t=this.#t(e);return new Function(`return ${t}`)()}};var Ee={all:!1,buildFormulaCache:!1,updateFormulaFromEditor:!1,createPromisedParts:!1,getSharedParts:!1},me=(()=>{class o extends Xt{constructor(t,s,r,i,n,a,l){super(),this.formConfig=t,this.itemService=s,this.contentTypeService=r,this.contentTypeItemService=i,this.loggingService=n,this.translate=a,this.inputTypes=l,this.log=h({FormulaCacheBuilder:o},Ee),this.#s={}}buildFormulaCache(t){let s=this.log.fnIf("buildFormulaCache"),r=[],i=this.formConfig.language(),n=new H(i),a=new dt(this.log.name);for(let l of this.formConfig.config.itemGuids){let m=this.itemService.get(l),c=this.#r(l,m),p=this.contentTypeService.getContentTypeOfItem(m);for(let f of p.Attributes){let y=a.getDefaultSettings(n.flatten(f.Metadata)),L=this.inputTypes.getSpecs(f),It=this.contentTypeItemService.getMany(y.Formulas).filter(x=>n.getBestValue(x.Attributes.Enabled));for(let x of It){let M=n.getBestValue(x.Attributes.Formula);if(!M)continue;let A=n.getBestValue(x.Attributes.Target),z;try{z=$.buildFormulaFunction(M)}catch(Tt){t.cacheResults({entityGuid:l,fieldName:f.Name,target:A},void 0,!0,!1);let Lt=Et.getTitle(p,i);this.loggingService.addLog(Q.Error,`Error building formula for Entity: "${Lt}", Field: "${f.Name}", Target: "${A}"`,Tt),this.loggingService.showMessage(this.translate.instant("Errors.FormulaConfiguration"),2e3)}let vt=u(u(d(u(d(u({cache:{},entityGuid:l,fieldName:f.Name,fn:z?.bind({}),isDraft:z==null,sourceCode:M,sourceCodeSaved:M,sourceCodeGuid:x.Guid,sourceCodeId:x.Id,target:A},this.#t(A,L)),{version:$.findFormulaVersion(M)}),c),{stop:!1,sleep:!1,fieldIsSpecialPicker:Vt.includes(A)}),this.#i()),this.#e(A));r.push(vt)}}}return s.r(r)}#t(t,s){return{inputType:s,isNewPicker:s.isNewPicker,disabled:!1,disabledReason:""}}#e(t){return t.startsWith(C)?{isSetting:!0,settingName:t.substring(C.length),isValue:!1,isValidation:!1}:{isSetting:!1,settingName:"",isValue:t===P.Value,isValidation:t===P.Validation}}#r(t,s=null){if(this.log.fnIf("getSharedParts",{item:s,entityGuid:t}),this.#s[t])return this.#s[t];s=s??this.itemService.get(t);let r=s.Entity,i=r.For,n={guid:r.Guid,id:r.Id,type:{guid:r.Type.Id,name:r.Type.Name},for:{targetType:i?.TargetType??0,guid:i?.Guid,number:i?.Number,string:i?.String},isNew:r.Id===0,isCopy:this.formConfig.config.isCopy},a=this.formConfig.config,l=a.dialogContext.User??{},m={targetEntity:n,user:{email:l.Email,guid:l.Guid,id:l.Id,isAnonymous:l.IsAnonymous,isSiteAdmin:l.IsSiteAdmin,isContentEditor:l.isContentEditor,isContentAdmin:l.IsContentAdmin,isSystemAdmin:l.IsSystemAdmin,name:l.Name,username:l.Username,roles:l.roles},app:{appId:a.appId,zoneId:a.zoneId,isGlobal:a.dialogContext.App.IsGlobalApp,isSite:a.dialogContext.App.IsSiteApp,isContent:a.dialogContext.App.IsContentApp,getSetting:c=>{}},sxc:window.$2sxc({zoneId:a.zoneId,appId:a.appId,pageId:a.tabId,moduleId:a.moduleId,_noContextInHttpHeaders:!0,_autoAppIdsInUrl:!0})};return this.#s[t]=m,m}#s;#i(){this.log.fnIf("createPromisedParts");let t=new J(null),s=new J(null),r=t.pipe(St(i=>!!i),Rt(i=>Mt(i.promise).pipe(q(n=>({set:i,result:n})))));return this.subscriptions.add(Gt([r,s.pipe(St(i=>!!i))]).subscribe(([i,n])=>(i.set.completed=!0,i.set.sleep=!1,n(i.result)))),{promises$:t,updateCallback$:s}}updateFormulaFromEditor(t,s,r,i){this.log.fnIf("updateFormulaFromEditor",{id:s,sourceCode:r,run:i});let n;if(i)try{n=$.buildFormulaFunction(r)}catch(A){t.cacheResults(s,void 0,!0,!1);let z=this.itemService.get(s.entityGuid),vt=this.contentTypeService.getContentTypeOfItem(z),Tt=this.formConfig.language(),Pt=`Error building formula for Entity: "${Et.getTitle(vt,Tt)}", Field: "${s.fieldName}", Target: "${s.target}"`;this.loggingService.addLog(Q.Error,Pt,A),console.error(Pt,A)}let a=this.itemService.get(s.entityGuid),l=this.contentTypeService.getAttributeOfItem(a,s.fieldName),m=this.inputTypes.getSpecs(l),{list:c,index:p,value:f}=t.formulaListIndexAndOriginal(s),y=f??{},L=this.#r(s.entityGuid),It=y.promises$&&y.updateCallback$?{promises$:f.promises$,updateCallback$:f.updateCallback$}:this.#i(),x=u(u(d(u(u(d(u({},s),{cache:y.cache??{},fn:n?.bind({}),isDraft:i?n==null:!0,sourceCode:r,sourceCodeSaved:y.sourceCodeSaved,sourceCodeGuid:y.sourceCodeGuid,sourceCodeId:y.sourceCodeId,version:$.findFormulaVersion(r)}),this.#t(s.target,m)),L),{stop:!1,sleep:!1,fieldIsSpecialPicker:Vt.includes(s.target)}),It),this.#e(s.target));return p>=0?[...c.slice(0,p),x,...c.slice(p+1)]:[x,...c]}static{this.\u0275fac=function(s){return new(s||o)(b(Kt),b(W),b(at),b(re),b(ee),b(Ut),b(ne))}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac})}}return o})();var Ce={all:!0,getActive:!0,fields:[...O]},de=(()=>{class o{#t;constructor(){this.log=h({FormulaCacheService:o},Ce),this.#t=Y(me),this.formulas=Z("formulas",[]),this.#e=Z("formula-results",[])}#e;init(){let t=this.#t.buildFormulaCache(this);this.formulas.set(t)}#r(t,s,r,i){return this.formulas().filter(n=>(t?n.entityGuid===t:!0)&&(s?n.fieldName===s:!0)&&(r?r?.find(a=>n.target==a):!0)&&(i?!0:!n.isDraft))}getActive(t,s,r){let i=this.log.fnIfInList("getActive","fields",s,()=>({name:s,forNewPicker:r,formulas:this.formulas()})),n=oe.concat(r?ae:le),a=this.#r(t,s,n,!1),l=a.filter(m=>!m.stop);return i.r(l,`all: ${a.length}, unstopped: ${l.length}`)}formulaListIndexAndOriginal(t){let s=this.formulas(),r=s.findIndex(n=>n.entityGuid===t.entityGuid&&n.fieldName===t.fieldName&&n.target===t.target),i=s[r];return{list:s,index:r,value:i}}updateSaved(t,s,r){let{list:i,index:n,value:a}=this.formulaListIndexAndOriginal(t);if(a==null)return;let l=d(u({},a),{sourceCodeSaved:t.sourceCode,sourceCodeGuid:s,sourceCodeId:r}),m=[...i.slice(0,n),l,...i.slice(n+1)];this.formulas.set(m)}updateFormulaFromEditor(t,s,r){let i=this.#t.updateFormulaFromEditor(this,t,s,r);this.formulas.set(i)}delete(t){let{list:s,index:r}=this.formulaListIndexAndOriginal(t);if(r<0)return;let i=[...s.slice(0,r),...s.slice(r+1)];this.formulas.set(i)}resetFormula(t){this.#s(t);let s=this.formulaListIndexAndOriginal(t).value?.sourceCodeSaved;s!=null?this.updateFormulaFromEditor(t,s,!0):this.delete(t)}cacheResults(t,s,r,i){let n={entityGuid:t.entityGuid,fieldName:t.fieldName,target:t.target,value:s,isError:r,isOnlyPromise:i},a=this.log.fn("cacheResults",{newResult:n});tt(()=>{let{list:l,index:m}=this.resultListIndexAndOriginal(t),c=m>=0?[...l.slice(0,m),n,...l.slice(m+1)]:[n,...l];a.a("set results",{list:l,index:m,newResults:c}),this.#e.set(c)}),a.end("ok")}resultListIndexAndOriginal(t){let s=this.#e(),r=s.findIndex(n=>n.entityGuid===t.entityGuid&&n.fieldName===t.fieldName&&n.target===t.target),i=s[r];return{list:s,index:r,value:i}}#s(t){let{list:s,index:r}=this.resultListIndexAndOriginal(t);if(r<0)return;let i=[...s.slice(0,r),...s.slice(r+1)];this.#e.set(i)}static{this.\u0275fac=function(s){return new(s||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac})}}return o})();var fe=(()=>{class o{constructor(t,s){this.itemService=t,this.contentTypeService=s}getTargetOptions(t,s){let r=[];if(t.entityGuid==null||t.fieldName==null)return r;let i=s.filter(c=>c.entityGuid===t.entityGuid&&c.fieldName===t.fieldName);for(let c of Object.values(P)){let p={hasFormula:i.some(f=>f.target===c),label:c.substring(c.lastIndexOf(".")+1),target:c};r.push(p)}let n=this.itemService.get(t.entityGuid),l=this.contentTypeService.getAttributeOfItem(n,t.fieldName).InputType;if(w.isGroupStart(l))for(let c of[X.Collapsed]){let p={hasFormula:i.some(f=>f.target===c),label:c.substring(c.lastIndexOf(".")+1),target:c};r.push(p)}if(w.isOldValuePicker(l))for(let c of[X.DropdownValues]){let p={hasFormula:i.some(f=>f.target===c),label:c.substring(c.lastIndexOf(".")+1),target:c};r.push(p)}if(w.isNewPicker(l))for(let c of Object.values(N)){let p={hasFormula:i.some(f=>f.target===c),label:"Picker "+c.substring(c.lastIndexOf(".")+1),target:c};r.push(p)}for(let c of i){if(r.some(y=>y.target===c.target))continue;let f={hasFormula:!0,label:c.target.substring(c.target.lastIndexOf(".")+1),target:c.target};r.push(f)}if(!r.some(c=>c.target===t.target)){let c={hasFormula:i.some(p=>p.target===t.target),label:t.target.substring(t.target.lastIndexOf(".")+1),target:t.target};r.push(c)}return r}static{this.\u0275fac=function(s){return new(s||o)(b(W),b(at))}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac})}}return o})();var ft=class{constructor(e,t,s,r,i,n){this.designerSvc=e,this.translate=t,this.logSvc=s,this.formula=r,this.ctTitle=i,this.formulaProps=n,this.isOpen=!1,this.isOpen=this.#t(r)}showStart(){if(!this.isOpen)return;let e=this.formula;console.log(`Running formula${e.version?.toLocaleUpperCase()} for Entity: "${this.ctTitle}", Field: "${e.fieldName}", Target: "${e.target}", arguments:`,this.formulaProps)}showResult(e,t,s){this.designerSvc.cache.cacheResults(this.formula,e,!1,!1),this.isOpen&&console.log("Formula result:",e)}showError(e){let t=this.formula,s=`Error in formula calculation for Entity: "${this.ctTitle}", Field: "${t.fieldName}", Target: "${t.target}"`;this.designerSvc.cache.cacheResults(t,void 0,!0,!1),this.logSvc.addLog(Q.Error,s,e),this.isOpen?console.error(s,e):this.logSvc.showMessage(this.translate.instant("Errors.FormulaCalculation"),2e3)}#t(e){return tt(()=>{let t=this.designerSvc.designerState();return t.isOpen&&t.entityGuid===e.entityGuid&&t.fieldName===e.fieldName&&t.target===e.target})}};var xe={all:!1,v1:!1,v2:!1,allValues:!0,oneValue:!0,fields:[...O]},pt=class o{constructor(e,t,s,r,i,n,a){this.contentType=e,this.entityGuid=t,this.fieldName=s,this.isValue=r,this.inputType=i,this.isOpen=n,this.valueMapper=a,this.log=h({FormulaValueCorrections:o},xe)}v1(e){let t=e&&Array.isArray(e)&&e.every(i=>typeof i=="string");if(!(["string","number","boolean"].includes(typeof e)||e instanceof Date||t||!e))return{ok:!1,v1Result:this.toFormulaResult(void 0)};let r=this.isValue?this.#t(e):e;return{ok:!0,v1Result:this.toFormulaResult(r)}}v2(e){let t=this.allValues(e);return d(u({},t),{openInDesigner:this.isOpen})}allValues(e){let t=this.log.fnIfInList("allValues","fields",this.fieldName,{result:e}),s={value:void 0,fields:[],stop:null,sleep:null};if(e==null)return t.r(d(u({},s),{value:e}),"null/empty");let r=this.isValue;if(Array.isArray(e))return console.warn("Formula result was an array - this is not allowed. Please return an object containing the array instead: { value: [...] }.",e),t.r(s,"array");if(typeof e=="object"){if(e instanceof Date&&r)return t.r(d(u({},s),{value:this.#t(e)}),"date");if(e instanceof Promise)return t.r(d(u({},s),{value:void 0,promise:e}),"promise");let n=e;return n.stop??=null,n.sleep??=null,n.value&&r&&(n.value=Array.isArray(n.value)?this.valueMapper?.toState(n.value)??n.value:this.#t(n.value)),n.fields&&(n.fields=n.fields?.map(a=>(a.value=this.#t(a.value,a.name),a))),n.options&&(Array.isArray(n.options)?n.options.length>0&&(n.options.find(a=>!a||a.value==null)&&(console.error("some options are missing value",n.options),n.options=[]),Ae(n.options)&&(console.error("duplicate values in options",n.options),n.options=[])):(console.error("options is not an array",n.options),n.options=[])),t.r(n,"object")}let i={value:e};return r?t.r(d(u({},s),{value:this.#t(i.value)}),"non-object, value"):t.r(i,"non-object, non-value")}#t(e,t=null){let s=this.log.fnIf("oneValue",{fieldName:this.fieldName,otherFieldName:t,value:e,type:typeof e});if(e==null)return s.r(e,"null");let r=this.inputType.inputType;if(t){let i=this.contentType.Attributes.find(n=>n.Name===t);if(!i?.InputType)return s.r(e,`other field ${t}; value not changed as target field not found`);r=i.InputType,s.a(`other field ${t} found, inputType: ${r}`)}if(r===R.DateTimeDefault||e instanceof Date){let i=new Date(e);return!(typeof e=="string"&&e.endsWith("Z"))&&i.getTime()!==e&&i.setTime(i.getTime()-i.getTimezoneOffset()*6e4),i.setMilliseconds(0),s.r(i.toJSON(),"date")}return typeof e!="string"&&(r?.startsWith(Ct.String.toLocaleLowerCase())||r?.startsWith(Ct.Hyperlink.toLocaleLowerCase()))?s.r(e.toString(),"not string, but input is string or hyperlink"):s.r(e,"unchanged")}toFormulaResult(e){return{value:e,fields:[],stop:null,sleep:null,openInDesigner:this.isOpen}}};function Ae(o){var e=o.map(s=>s.value),t=new Set(e);return e.length!==t.size?(console.error("Duplicate values in options",o,e,t),!0):!1}var Ve='A formula in this dialog is using an experimental feature: "{0}" - this will be removed soon.',ht=class{#t;constructor(e){this.#t=e}getEntities(){return this.#e("getEntities"),this.#t.itemService.getMany(this.#t.formConfig.config.itemGuids).map(t=>({guid:t.Entity.Guid,id:t.Entity.Id,type:{guid:t.Entity.Type.Id,name:t.Entity.Type.Name}}))}getSettings(e){return this.#e("getSettings"),this.#t.fieldsSettingsSvc.settings[e]()}getValues(e){this.#e("getValues");let t=this.#t.itemService.get(e);return new H(this.#t.language).currentValues(t.Entity.Attributes)}#e(e){let t=Ve.replace("{0}",e);console.error(t),!this.#t.warningsObsolete[e]&&(this.#t.warningsObsolete[e]=!0,alert(t))}};var gt=class{constructor(e,t){let s=e.runParameters.formula;this.cache=s.cache,this.debug=e.debugEnabled,this.sxc=s.sxc,this.user=s.user;let l=e.runParameters.formula.app,{getSetting:r}=l,i=$t(l,["getSetting"]);this.app=Object.assign(new jt(e),i),this.target=new Nt(e);let n=e.language,a=e.languages;this.culture={code:n.current,name:a.find(m=>m.NameId===n.current)?.Culture},this.features=new kt(e),this.form=new Dt(e),this.entities=new Ot(e),this.xp=t}},Ot=class{#t;constructor(e){this.#t=e}getAll(){return this.#t.itemService.getMany(this.#t.formConfig.config.itemGuids).map(t=>({guid:t.Entity.Guid,id:t.Entity.Id,type:{guid:t.Entity.Type.Id,name:t.Entity.Type.Name}}))}getOfType(e){return this.getAll().find(t=>t.type.guid==e||t.type.name==e)}},kt=class{#t;constructor(e){this.#t=e}isEnabled(e){return this.#t.features().find(t=>t.nameId===e)?.isEnabled??!1}},Dt=class{#t;constructor(e){this.#t=e}runFormulas(){console.error("A formula uses form.runFormulas(). This is deprecated since v18.. It is now disabled. Change formula to V2 and return a promise to achieve the same effect.")}},jt=class{#t;constructor(e){this.#t=e}getSetting(e){if(this.#t.runParameters.formula.version===I.V1)return console.warn("app.getSetting() is not available in v1 formulas, please use v2."),"\u26A0\uFE0F error - see console";let t=this.#t.formConfig.config.settings.Values[e];return t??(console.warn(`Error: Setting '${e}' not found. Did you configure it in the ContentType to be included? See https://go.2sxc.org/formulas`),"\u26A0\uFE0F error - see console")}},Nt=class{#t;constructor(e){this.#t=e;let t=e.runParameters.formula;this.entity=t.targetEntity;let s=t.isValue||t.isValidation;this.name=s?t.fieldName:t.target.substring(t.target.lastIndexOf(".")+1),this.type=s?t.target:t.target.substring(0,t.target.lastIndexOf("."))}};var yt=class{#t;#e;#r;#s;constructor(e){this.#t=e,this.#e=e.runParameters,this.#s=this.#e.pickerHelper.infos,this.#r=this.#e.pickerHelper.infos.mapper}get default(){let{formula:e}=this.#e;if(e.isValue)return this.#n(this.#e.defaultValueHelper().getDefaultOrPrefillValue());if(e.isSetting)return this.#e.settingsInitial[e.settingName];if(e.isNewPicker)return this.#s.options.list}get initial(){let e=this.#e.formula;return e.isValue?this.#n(this.#t.initialFormValues[e.fieldName]):null}get parameters(){return this.#t.parameters.all()}get prefill(){let{formula:e}=this.#e;return e.isValue?this.#n(this.#e.defaultValueHelper().getDefaultOrPrefillValue(!0)):null}get value(){let e=this.#e.formula;if(e.isValue)return this.#n(this.#e.currentValues[e.fieldName]);if(e.isSetting)return this.#e.settingsCurrent[e.settingName];if(e.isValidation)return{severity:"",message:""}}get selected(){return this.#i("list")}get selectedRaw(){return this.#i("listRaw")}#i(e){let t=this.#s.selected[e];return this.#s.picker.selectedCopy(t)}get options(){return this.#o("list")}get optionsRaw(){return this.#o("listRaw")}#o(e){return this.#s.options[e]}#n(e){return this.#r?.toUi(e)??e}};var pe=class{constructor(e,t,s,r,i,n){this.designerSvc=e,this.translate=t,this.logSvc=s,this.contentType=r,this.entityGuid=i,this.ctTitle=n}getPartsFor(e){let t=e.runParameters.formula,s=this.#t(e),r=new ft(this.designerSvc,this.translate,this.logSvc,t,this.ctTitle,s),i=e.runParameters.pickerHelper.infos.mapper;return{formula:t,fieldName:t.fieldName,params:s,title:this.ctTitle,devHelper:r,valHelper:new pt(this.contentType,this.entityGuid,t.fieldName,t.isValue,t.inputType,r.isOpen,i)}}#t(e){let{formula:t,currentValues:s}=e.runParameters;switch(t.version){case I.V1:case I.V2:let r=Object.assign(new yt(e),s),i=new ht(e),n=new gt(e,i);return{data:r,context:n};default:throw new Error(`Formula version '${t.version}' unknown not supported`)}}},U=class{constructor(e){this.prefill=e}all(){return this.#t||(this.#t=this.prefill?JSON.parse(JSON.stringify(this.prefill)):{}),this.#t}#t};var _=class{static buildDesignerSnippetsContext(e){switch(e.version){case I.V1:return["app.appId","app.zoneId","app.isGlobal","app.isSite","app.isContent","cache.ChangeThis","culture.code","culture.name","debug","features.isEnabled('nameId')","form.runFormulas()","sxc.ChangeThis","target.entity.id","target.entity.guid","target.name","target.type","user.id","user.isAnonymous","user.isSiteAdmin","user.isSystemAdmin"].map(s=>{let r=`context.${s}`;return{code:r,label:r}});default:return}}static getSnippets(e,t,s){switch(e.version){case I.V1:let r=new U(s).all;return["value","default","prefill","initial",...t.map(n=>n.fieldName),"parameters.ChangeThis",...Object.keys(r).map(n=>`parameters.${n}`)].map(n=>{let a=`data.${n}`;return{code:a,label:a}});default:return}}};var he=`/*\r
  This is a special file which is not compiled as a normal TypeScript.\r
  Instead it's loaded as raw text, to hand over to Monaco.\r
  It ensures that v2 functions have intellisense.\r
\r
  TIP: To edit this file, briefly rename it to ...raw.ts, then back to ...rawts\r
       This will make VSCode load it as a normal TypeScript file, so you can edit it.\r
\r
  - Try to keep in sync with the real code in the 2sxc project.\r
  - The comments are _documentation_ for the user, so they can see what's available\r
  - If you need any "internal" comments, use // instead\r
  - Note that the [inject:...] comments are replaced by the build process\r
*/\r
\r
/**\r
 * The data object is the main object for figuring out what the field or setting contained and what other fields currently store.\r
 * It has properties such as \`.value\` etc.\r
 * Just start typing to see the intellisense.\r
 */\r
// Note that the type must be explicitly like \`string | boolean | number | string[]\`\r
// Otherwise it won't show the details to the user\r
declare interface FormulaData {\r
  /**\r
   * The value of the current field/setting when the formula runs.\r
   *\r
   * _It's exact type depends on the underlying type._\r
   */\r
  value: string | boolean | number | string[];\r
  /**\r
   * The _default_ value of the current field/setting as defined in the field settings.\r
   *\r
   * _It's exact type depends on the underlying type._\r
   */\r
  default: string | boolean | number | string[];\r
  /**\r
   * A prefill value that was passed into the form when it was loaded.\r
   *\r
   * _It's exact type depends on the underlying type._\r
   */\r
  prefill: string | boolean | number | string[];\r
  /**\r
   * The value of the current field/setting when the form initially loaded.\r
   *\r
   * _It's exact type depends on the underlying type._\r
   */\r
  initial: string | boolean | number | string[];\r
  /* [inject:AllFields] */\r
  /**\r
   * All parameters which were passed to the form when it was loaded\r
   *\r
   * _It's exact type depends on the parameter, but it's usually a string._\r
   */\r
  parameters: {\r
    /* [inject:AllParameters] */\r
  };\r
}\r
\r
declare interface FormulaContext {\r
  /**\r
   * Information about the current App\r
   */\r
  app: {\r
    /** The current App ID */\r
    appId: number;\r
    /** The current Zone ID */\r
    zoneId: number;\r
    /** Determines if the current App is the global App */\r
    isGlobal: boolean;\r
    /** Determines if the current App is the primary (main) App on the site */\r
    isSite: boolean;\r
    /** Determines if the current App is a content App */\r
    isContent: boolean;\r
    /**\r
     * Retrieve a setting like an App setting.\r
     * You need the full path like \`Settings.ShowCategories\`.\r
     * \r
     * Important: For security reasons formulas will only get settings which where configured in the ContentType for use in Formulas.\r
     */\r
    getSetting(settingPath: string): string;\r
  };\r
  /**\r
   * Cache for this formula. You can store any data here and it will be available in the next run.\r
   */\r
  cache: Record<string, any>;\r
  /**\r
   * Information about the current language\r
   */\r
  culture: {\r
    code: string;\r
    name: string;\r
  };\r
  debug: boolean;\r
  /**\r
   * API to detect what features are currently enabled/available\r
   */\r
  features: {\r
    // /**\r
    //  * Get internal information about a feature if it's available. This is rarely used.\r
    //  * @param nameId The name of the feature, eg. \`PasteImageFromClipboard\`\r
    //  */\r
    // get(nameId: string): Record<string, any>;\r
    /** Find out if the feature is enabled. Eg. \`...isEnabled('PasteImageFromClipboard')\` */\r
    isEnabled(nameId: string): boolean;\r
  };\r
  /**\r
   * Work with the current form\r
   */\r
  form: {\r
    // v16 Deprecated for v2\r
    // /** Re-trigger all formulas. Usually used inside promises when they complete. */\r
    // runFormulas(): void;\r
  };\r
  /**\r
   * The standard sxc object for the current App.\r
   * It's the same as the sxc-instance in the page.\r
   *\r
   * You can use it to make API calls to the server.\r
   */\r
  sxc: {\r
    /** The module ID */\r
    id: number;\r
    /** The Content-Block ID - matches the module ID unless it's an inner-content block inside another module */\r
    cbid: number;\r
    /** The sxc WebAPI object. Check the docs: https://docs.2sxc.org/api/js/SxcWebApi.html */\r
    webApi: {\r
      /**\r
       * Get data from a url and return the json-object\r
       * @param url Url to call. It's usually a virtual url such as \`app/auto/api/basic/hello\`\r
       * @param data Optional data. If provided, it will use a POST\r
       * @param method Optional method, default is \`GET\` unless you specify data, then it's \`POST\`\r
       */\r
      fetchJson<TData>(url: string, data?: string | Record<string, any>, method?: string): Promise<TData>;\r
      /**\r
       * Get data from a url and return the response (not a nice object)\r
       * @param url Url to call. It's usually a virtual url such as \`app/auto/api/basic/hello\`\r
       * @param data Optional data. If provided, it will use a POST\r
       * @param method Optional method, default is \`GET\` unless you specify data, then it's \`POST\`\r
       */\r
      fetchRaw<TData>(url: string, data?: string | Record<string, any>, method?: string): Promise<TData>;\r
    };\r
    // turn off for now v16.00 - confusing\r
    // [key: string]: any;\r
  };\r
  /**\r
   * Information about the item this formula targets.\r
   */\r
  target: {\r
    /** The entity the current formula affects */\r
    entity: {\r
      /** The entity ID */\r
      id: number;\r
      /** The entity GUID */\r
      guid: string;\r
      /** Metadata For information */\r
      for: {\r
        /** The target type like \`4\` (Entity). \`0\` if it's not metadata  */\r
        targetType: number;\r
        /** The int-key if it uses number keys, otherwise null */\r
        number?: number;\r
        /** The string-key if it uses string keys, otherwise null */\r
        string?: string;\r
        /** The GUID-key if it uses GUIDs, otherwise null */\r
        guid?: string;\r
      },\r
      /** this is a new entity */\r
      isNew: boolean;\r
      /** this is a copy, note that isNew will also be true */\r
      isCopy: boolean;\r
    };\r
    name: string;\r
    /** The entity type name */\r
    type: string;\r
  };\r
  /**\r
   * Information about the current user\r
   */\r
  user: {\r
    /** The current user ID */\r
    id: number;\r
    /** Check if the current user is anonymous eg. not logged in */\r
    isAnonymous: boolean;\r
    /** Check if the current user is a content admin */\r
    isContentAdmin: boolean;\r
    /** Check if the current user is a content editor (but maybe not admin) - new v20.01 */\r
    isContentEditor: boolean;\r
    /** Check if the current user is a site admin */\r
    isSiteAdmin: boolean;\r
    /** Check if the current user is a system admin */\r
    isSystemAdmin: boolean;\r
    /** current user e-mail */\r
    email: string;\r
    /** The user GUID */\r
    guid: string;\r
    /** the name usually shown in greetings */\r
    name: string;\r
    /** The user name used for login */\r
    username: string;\r
    /** The names of user roles of the current user is in - new v20.01 */\r
    roles: string[];\r
  };\r
}\r
\r
// /**\r
//  * Test docs\r
//  * @param data The data object\r
//  */\r
// declare function callbackV2(data: FormulaData): string | string[];\r
\r
// /**\r
//  * test docs 3\r
//  * @param callback The real code of the formula\r
//  */\r
// declare function v3(callback: typeof callbackV2);\r
\r
/**\r
 * This \`v2\` wrapper is required for the intellisense to work.\r
 * @param callback The real code of the formula\r
 * @returns A string, boolean, number, date or an advanced object\r
 */\r
declare function v2(\r
  // The main function - adding comments here does not show up, so we don't have them ATM\r
  callback: (\r
    data: FormulaData,\r
    context: FormulaContext,\r
  ) => string | boolean | number | Date | {\r
    value?: string | boolean | number | Date | { severity: 'warning' | 'error', message: string },\r
    fields?: {\r
      name: string,\r
      value: string | boolean | number | Date\r
    }[],\r
    promise?: Promise<any>,\r
    stop?: boolean,\r
  },\r
): void;\r
`;var bt=class{static getTypings(e,t,s){switch(e.version){case I.V2:{let r=new U(s).all,i=t.map(l=>`${l.fieldName}: ${this.#t(l.inputType)};`).join(`
`),n=Object.keys(r).map(l=>`${l}: any;`).join(`
`);return he.replace("/* [inject:AllFields] */",i).replace("/* [inject:AllParameters] */",n)}default:return}}static#t(e){let t=e.toLowerCase();return t.startsWith("string")?"string":t.startsWith("number")?"number":t.startsWith("date")?"Date":t.startsWith("boolean")?"boolean":"any"}};var Oe={all:!1,constructor:!1,setDesignerOpen:!1},tn=(()=>{class o{#t;constructor(t){this.itemService=t,this.log=h({FormulaDesignerService:o},Oe),this.cache=Y(de),this.#t=Y(fe),this.itemSettingsServices={},this.designerState=Z("designerState",{editMode:!1,entityGuid:void 0,fieldName:void 0,isOpen:!1,target:void 0}),this.formulaResult=S("formulaResult",()=>{let s=this.designerState();return this.cache.resultListIndexAndOriginal(s).value}),this.currentTargetOptions=S("currentTargetOptions",()=>{let s=this.designerState(),r=this.cache.formulas();return this.#t.getTargetOptions(s,r)}),this.entityOptions=S("entityOptions",()=>{let s=this.cache.formulas();return Object.entries(this.itemSettingsServices).map(([r,i])=>{let n=s.filter(a=>a.entityGuid===r);return{entityGuid:r,formulas:n,hasFormula:n.length>0,label:i.contentTypeSettings()._itemTitle}})}),this.fieldsOptions=S("fieldsOptions",()=>{let s=this.designerState().entityGuid;if(s==null)return[];let r=this.entityOptions().find(l=>l.entityGuid==s).formulas,n=this.itemSettingsServices[s].allProps();return Object.keys(n).map(l=>{let m=r.filter(c=>c.fieldName===l);return{fieldName:l,formulas:m,hasFormula:m.length>0,inputType:n[l].settings.InputType,label:l}})}),this.currentFormula=S("currentFormula",()=>{let s=this.designerState(),{value:r}=this.cache.formulaListIndexAndOriginal(s);return r}),this.v1ContextSnippets=S("v1ContextSnippets",()=>{let s=this.currentFormula();return s!=null?_.buildDesignerSnippetsContext(s):[]}),this.#e=S("currentItemHeader",()=>{let s=this.designerState().entityGuid;return s==null?null:this.itemService.getItemHeader(s)}),this.v2JsTypings=S("v2JsTypings",()=>{let s=this.currentFormula(),r=this.#e();return s!=null&&r!=null?bt.getTypings(s,this.fieldsOptions(),r.Prefill):""}),this.v1DataSnippets=S("v1DataSnippets",()=>{let s=this.currentFormula(),r=this.#e();return s!=null&&r!=null?_.getSnippets(s,this.fieldsOptions(),r.Prefill):[]}),this.log.fnIf("constructor")}initAfterItemSettingsAreReady(){let t=this.designerState(),[s,r]=Object.entries(this.itemSettingsServices)[0],i=r.allProps(),n=Object.keys(i)[0],a=n!=null?ue.Value:null,l=d(u({},t),{entityGuid:s,fieldName:n,target:a});this.designerState.set(l)}#e;setDesignerOpen(t){this.log.fnIf("setDesignerOpen",{isOpen:t}),this.designerState.set(d(u({},this.designerState()),{isOpen:t}))}static{this.\u0275fac=function(s){return new(s||o)(b(W))}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac})}}return o})();export{nt as a,T as b,it as c,re as d,ot as e,at as f,ne as g,W as h,ut as i,B as j,v as k,mt as l,dt as m,ee as n,Q as o,Me as p,C as q,N as r,Qs as s,_s as t,tr as u,I as v,pt as w,pe as x,U as y,tn as z,He as A};
//# sourceMappingURL=https://sources.2sxc.org/21.00.00/dist/ng-edit/chunk-OUDKTNXF.js.map

{
  "version": 3,
  "sources": ["projects/eav-ui/src/app/code-editor/services/source.service.ts"],
  "sourcesContent": ["import { httpResource } from '@angular/common/http';\r\nimport { computed, Injectable, Signal } from '@angular/core';\r\nimport { map, Observable } from 'rxjs';\r\nimport { WebApi, WebApiDetails } from '../../app-administration/models';\r\nimport { ViewOrFileIdentifier } from '../../shared/models/edit-form.model';\r\nimport { HttpServiceBase } from '../../shared/services/http-service-base';\r\nimport { FileAsset } from '../models/file-asset.model';\r\nimport { PredefinedTemplatesResponse } from '../models/predefined-template.model';\r\nimport { Preview } from '../models/preview.models';\r\nimport { SourceView } from '../models/source-view.model';\r\n\r\nconst appFilesAll = 'admin/AppFiles/AppFiles';\r\nconst appFilesAsset = 'admin/AppFiles/asset';\r\nconst appFilesCreate = 'admin/AppFiles/create';\r\nconst apiExplorerInspect = 'admin/ApiExplorer/inspect';\r\nconst apiExplorerAppApiFiles = 'admin/ApiExplorer/AppApiFiles';\r\nconst appFilesPredefinedTemplates = 'admin/AppFiles/GetTemplates';\r\nconst appFilesPreview = 'admin/AppFiles/preview';\r\n\r\n@Injectable()\r\nexport class SourceService extends HttpServiceBase {\r\n\r\n  // TODO: @2dg, ask 2dm \r\n  /** ViewKey is templateId or path */\r\n  get(viewKey: string, global: boolean, urlItems: ViewOrFileIdentifier[]): Observable<SourceView> {\r\n    return this.getHttpApiUrl<SourceView>(appFilesAsset, {\r\n      params: {\r\n        appId: this.appId,\r\n        global,\r\n        ...this.templateIdOrPath(viewKey, global, urlItems),\r\n      },\r\n    }).pipe(\r\n      map(view => {\r\n        if (view.Type.toLocaleLowerCase() === 'auto') {\r\n          switch (view.Extension.toLocaleLowerCase()) {\r\n            case '.cs':\r\n            case '.cshtml':\r\n              view.Type = 'Razor';\r\n              break;\r\n            case '.html':\r\n            case '.css':\r\n            case '.js':\r\n              view.Type = 'Token';\r\n              break;\r\n          }\r\n        }\r\n        return view;\r\n      })\r\n    );\r\n  }\r\n\r\n  // TODO: @2dg, ask 2dm \r\n  // getSig(viewKey: string, global: boolean, urlItems: ViewOrFileIdentifier[], initial: undefined): Signal<SourceView> {\r\n  //   // Signal f√ºr die SourceView erstellen\r\n  //   const temp = this.getSignal<SourceView>(appFilesAsset, {\r\n  //     params: {\r\n  //       appId: this.appId,\r\n  //       global,\r\n  //       ...this.templateIdOrPath(viewKey, global, urlItems),\r\n  //     },\r\n  //   }, initial);\r\n  //   return computed(() => {\r\n  //     const result = temp();\r\n\r\n  //     if (result && result.Type.toLocaleLowerCase() === 'auto') {\r\n  //       switch (result.Extension.toLocaleLowerCase()) {\r\n  //         case '.cs':\r\n  //         case '.cshtml':\r\n  //           result.Type = 'Razor';\r\n  //           break;\r\n  //         case '.html':\r\n  //         case '.css':\r\n  //         case '.js':\r\n  //           result.Type = 'Token';\r\n  //           break;\r\n  //       }\r\n  //     }\r\n\r\n  //     return result;\r\n  //   });\r\n  // }\r\n\r\n\r\n  /** ViewKey is templateId or path */\r\n  save(viewKey: string, global: boolean, view: SourceView, urlItems: ViewOrFileIdentifier[]): Observable<boolean> {\r\n    return this.http.post<boolean>(this.apiUrl(appFilesAsset), view, {\r\n      params: {\r\n        appId: this.appId,\r\n        global,\r\n        ...this.templateIdOrPath(viewKey, global, urlItems),\r\n      },\r\n    });\r\n  }\r\n\r\n  getAllPromise(mask?: string): Promise<FileAsset[]> {\r\n    return this.fetchPromise<{ Files: FileAsset[] }>(appFilesAll, {\r\n      params: {\r\n        appId: this.appId,\r\n        ...(mask && { mask }),\r\n      },\r\n    }).then(({ Files }) => {\r\n      Files.forEach(file => {\r\n        file.Shared ??= false;\r\n      });\r\n      return Files;\r\n    });\r\n  }\r\n\r\n  // TODO: @2dg, ask 2dm\r\n  getWebApis(): Observable<WebApi[]> {\r\n    return this.getHttpApiUrl<{ files: WebApi[] }>(apiExplorerAppApiFiles, {\r\n      params: {\r\n        appId: this.appId,\r\n      },\r\n    }).pipe(\r\n      map(({ files }) => {\r\n        files.forEach(file => {\r\n          file.isShared ??= false;\r\n          file.isCompiled ??= false;\r\n        });\r\n        return files;\r\n      }),\r\n    ).pipe(\r\n      map(files => {\r\n        const webApis: WebApi[] = files.map(file => {\r\n          const splitIndex = file.path.lastIndexOf('/');\r\n          const fileExtIndex = file.path.lastIndexOf('.');\r\n          const folder = file.path.substring(0, splitIndex);\r\n          const name = file.path.substring(splitIndex + 1, fileExtIndex);\r\n          const webApi: WebApi = { path: file.path, folder, name, isShared: file.isShared, endpointPath: file.endpointPath, isCompiled: file.isCompiled, edition: file.edition };\r\n          return webApi;\r\n        });\r\n        return webApis;\r\n      }),\r\n    );\r\n  }\r\n\r\n\r\n  getWebApisLive(refresh: Signal<unknown>) {\r\n    const apiResource = httpResource<{ files: WebApi[] }>(() => {\r\n      refresh();\r\n      return {\r\n        url: this.apiUrl(apiExplorerAppApiFiles),\r\n        params: { appId: this.appId },\r\n      };\r\n    });\r\n\r\n    // Return a computed signal that transforms the data\r\n    return computed(() => {\r\n      const response = apiResource.value();\r\n      const files = response?.files;\r\n\r\n      if (!files) return [];\r\n\r\n      // Set default values for isShared and isCompiled if they are undefined\r\n      files.forEach(file => {\r\n        file.isShared ??= false;\r\n        file.isCompiled ??= false;\r\n      });\r\n\r\n      // Transform the raw files into the desired WebApi format\r\n      return files.map(file => {\r\n        const splitIndex = file.path.lastIndexOf('/');\r\n        const fileExtIndex = file.path.lastIndexOf('.');\r\n        const folder = file.path.substring(0, splitIndex);\r\n        const name = file.path.substring(splitIndex + 1, fileExtIndex);\r\n\r\n        return {\r\n          path: file.path,\r\n          folder,\r\n          name,\r\n          isShared: file.isShared,\r\n          endpointPath: file.endpointPath,\r\n          isCompiled: file.isCompiled,\r\n          edition: file.edition,\r\n        } as WebApi;\r\n      });\r\n    });\r\n  }\r\n\r\n\r\n  // TODO: @2dg, ask 2dm \r\n  getWebApiDetails(apiPath: string): Observable<WebApiDetails> {\r\n    return this.getHttpApiUrl<WebApiDetails>(apiExplorerInspect, {\r\n      params: { appId: this.appId, zoneId: this.zoneId, path: apiPath },\r\n    });\r\n  }\r\n\r\n  getPredefinedTemplates(purpose?: 'Template' | 'Search' | 'Api', type?: 'Token' | 'Razor'): Promise<PredefinedTemplatesResponse> {\r\n    return this.fetchPromise<PredefinedTemplatesResponse>(appFilesPredefinedTemplates, {\r\n      params: {\r\n        ...(purpose && { purpose }),\r\n        ...(type && { type }),\r\n      },\r\n    });\r\n  }\r\n\r\n  // TODO: @2dg, ask 2dm \r\n  getPreview(path: string, global: boolean, templateKey: string): Observable<Preview> {\r\n    return this.getHttpApiUrl<Preview>(appFilesPreview, {\r\n      params: {\r\n        appId: this.appId,\r\n        path,\r\n        templateKey,\r\n        global,\r\n      },\r\n    });\r\n  }\r\n\r\n  create(path: string, global: boolean, templateKey: string): Observable<boolean> {\r\n    return this.http.post<boolean>(this.apiUrl(appFilesCreate), {}, {\r\n      params: {\r\n        appId: this.appId,\r\n        global,\r\n        purpose: 'auto',\r\n        path,\r\n        templateKey,\r\n      },\r\n    });\r\n  }\r\n\r\n  private templateIdOrPath(viewKey: string, global: boolean, urlItems: ViewOrFileIdentifier[]) {\r\n    if (/^[0-9]*$/g.test(viewKey)) {\r\n      const path = urlItems.find(i => i.EntityId?.toString() === viewKey && i.IsShared === global)?.Path;\r\n      return {\r\n        templateId: viewKey,\r\n        ...(path != null && { path }),\r\n      };\r\n    } else {\r\n      return { path: viewKey };\r\n    }\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["appFilesAll", "appFilesAsset", "appFilesCreate", "apiExplorerInspect", "apiExplorerAppApiFiles", "appFilesPredefinedTemplates", "appFilesPreview", "SourceService", "HttpServiceBase", "get", "viewKey", "global", "urlItems", "getHttpApiUrl", "params", "__spreadValues", "appId", "templateIdOrPath", "pipe", "map", "view", "Type", "toLocaleLowerCase", "Extension", "save", "http", "post", "apiUrl", "getAllPromise", "mask", "fetchPromise", "then", "Files", "forEach", "file", "Shared", "getWebApis", "files", "isShared", "isCompiled", "splitIndex", "path", "lastIndexOf", "fileExtIndex", "folder", "substring", "name", "endpointPath", "edition", "getWebApisLive", "refresh", "apiResource", "httpResource", "url", "computed", "value", "getWebApiDetails", "apiPath", "zoneId", "getPredefinedTemplates", "purpose", "type", "getPreview", "templateKey", "create", "test", "find", "i", "EntityId", "toString", "IsShared", "Path", "templateId", "__ngFactoryType__", "factory", "\u0275fac"]
}

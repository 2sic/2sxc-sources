{
  "version": 3,
  "sources": ["projects/eav-ui/src/app/edit/shared/services/logging.service.ts", "projects/eav-ui/src/app/shared/user/user-preferences.service.ts", "projects/eav-ui/src/app/edit/dialog/footer/footer-preferences.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-content-type-attribute.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-dimension.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-entity.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-entity-attributes.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-field.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-field-value.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-item.ts", "projects/eav-ui/src/app/edit/shared/models/eav/eav-content-type.ts", "projects/eav-ui/src/app/edit/shared/content-types/content-type-item.service.ts", "projects/eav-ui/src/app/edit/shared/helpers/item.helper.ts", "projects/eav-ui/src/app/edit/shared/content-types/content-type.service.ts", "projects/eav-ui/src/app/edit/shared/input-types/input-type.service.ts", "projects/eav-ui/src/app/edit/localization/field-writer.ts", "projects/eav-ui/src/app/edit/state/item-updater.helper.ts", "projects/eav-ui/src/app/edit/state/item.service.ts", "projects/eav-ui/src/app/edit/formulas/targets/formula-targets.ts", "projects/eav-ui/src/app/edit/formulas/formula-definitions.ts", "projects/eav-ui/src/app/edit/fields/logic/field-logic-base.ts", "projects/eav-ui/src/app/edit/fields/logic/field-logic-unknown.ts", "projects/eav-ui/src/app/edit/fields/logic/field-logic-manager.ts", "projects/eav-ui/src/app/edit/localization/translation-link.constants.ts", "projects/eav-ui/src/app/edit/fields/wrappers/localization/translate-menu/translate-menu.helpers.ts", "projects/eav-ui/src/app/edit/state/field-settings.helper.ts", "projects/eav-ui/src/app/edit/formulas/cache/source-code-helper.ts", "projects/eav-ui/src/app/edit/formulas/cache/formula-cache.builder.ts", "projects/eav-ui/src/app/edit/formulas/cache/formula-cache.service.ts", "projects/eav-ui/src/app/edit/formulas/targets/formula-targets.service.ts", "projects/eav-ui/src/app/edit/formulas/formula-developer-helper.ts", "projects/eav-ui/src/app/edit/formulas/results/formula-value-corrections.helper.ts", "projects/eav-ui/src/app/edit/formulas/run/formula-experimental-object.ts", "projects/eav-ui/src/app/edit/formulas/run/formula-run-context.ts", "projects/eav-ui/src/app/edit/formulas/run/formula-run-data.ts", "projects/eav-ui/src/app/edit/formulas/formula-run-one-helpers.factory.ts", "projects/eav-ui/src/app/edit/formulas/designer/formula-v1-snippets.ts", "projects/eav-ui/src/app/edit/formulas/designer/editor-intellisense-function-v2.rawts", "projects/eav-ui/src/app/edit/formulas/designer/intellisense-v2.ts", "projects/eav-ui/src/app/edit/formulas/designer/formula-designer.service.ts"],
  "sourcesContent": ["import { Injectable, OnDestroy, Signal } from '@angular/core';\r\nimport { toSignal } from '@angular/core/rxjs-interop';\r\nimport { MatSnackBar } from '@angular/material/snack-bar';\r\nimport { BehaviorSubject, Observable } from 'rxjs';\r\nimport { Of } from '../../../../../../core';\r\n\r\n/**\r\n * Logging service - ATM not really used, but would be great\r\n * to show logs in the debug-panel.\r\n * So don't delete - reconsider how to use.\r\n */\r\n@Injectable()\r\nexport class LoggingService implements OnDestroy {\r\n  private logs$ = new BehaviorSubject<LogEntry[]>([]);\r\n  private logLimit = 50;\r\n  private lastSnackBarTime = 0;\r\n  private snackBarDebounce = 10000;\r\n\r\n  constructor(private snackBar: MatSnackBar) { }\r\n\r\n  ngOnDestroy(): void {\r\n    this.logs$.complete();\r\n  }\r\n\r\n  addLog(severity: Of<typeof LogSeverities>, label: string, error: any): void {\r\n    const newLogEntry: LogEntry = {\r\n      error,\r\n      label,\r\n      severity,\r\n      time: Date.now(),\r\n    };\r\n    const oldLogs = this.logs$.value;\r\n    const newLogs = [newLogEntry, ...oldLogs.slice(0, this.logLimit - 2)];\r\n    this.logs$.next(newLogs);\r\n  }\r\n\r\n  /** Show snackBar to the user. By default snackBars have debounce timer, but you can force snackBar to show instantly */\r\n  showMessage(message: string, duration: number, force?: boolean): void {\r\n    const nowTime = Date.now();\r\n    if (!force && (nowTime - this.lastSnackBarTime) <= this.snackBarDebounce) {\r\n      return;\r\n    }\r\n\r\n    if (duration != null && duration > 0) {\r\n      this.snackBar.open(message, null, { duration });\r\n    } else {\r\n      this.snackBar.open(message);\r\n    }\r\n    this.lastSnackBarTime = nowTime;\r\n  }\r\n\r\n  getLogs$(): Observable<LogEntry[]> {\r\n    return this.logs$.asObservable();\r\n  }\r\n\r\n  getLogsSignal(): Signal<LogEntry[]> {\r\n    return toSignal(this.logs$);\r\n  }\r\n\r\n}\r\n\r\n\r\nexport interface LogEntry {\r\n  error: any;\r\n  label: string;\r\n  severity: Of<typeof LogSeverities>;\r\n  time: number;\r\n}\r\n\r\nexport const LogSeverities = {\r\n  Error: 'error',\r\n  Log: 'log',\r\n  Warn: 'warn',\r\n} as const /* the as const ensures that the keys/values can be strictly checked */;\r\n", "import { Injectable, signal, WritableSignal } from '@angular/core';\r\nimport { classLog } from '../logging';\r\nimport { StateManagerLocal, StateManagerSession } from './state-manager';\r\n\r\nconst storeKey = 'user-settings';\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class UserPreferences {\r\n\r\n  log = classLog({UserPreferences});\r\n\r\n  constructor() {\r\n    this.log.fn('constructor');\r\n  }\r\n\r\n  get local() { return this.#local ??= new StateManagerLocal(storeKey); }\r\n  #local: StateManagerLocal;\r\n\r\n  get session() { return this.#session ??= new StateManagerSession(storeKey); }\r\n  #session: StateManagerSession;\r\n\r\n  get<T>(key: string, longTerm = false): T {\r\n    return (longTerm ? this.local : this.session).get(key);\r\n  }\r\n\r\n  set<T>(key: string, value: T, longTerm = false) {\r\n    (longTerm ? this.local : this.session).add(key, value);\r\n  }\r\n\r\n  part<T extends Record<string, unknown>>({ key, data }: { key: string; data: T; }): UserPreferencesPart<T> {\r\n    return this.#getPart(key, data, true);\r\n  }\r\n\r\n  #getPart<T extends Record<string, unknown>>(key: string, data: T, longTerm = false): UserPreferencesPart<T> {\r\n    if (this.#partCache[key]) return this.#partCache[key] as unknown as UserPreferencesPart<T>;\r\n    const created = new UserPreferencesPart(this, key, data, longTerm);\r\n    this.#partCache[key] = created;\r\n    return created as unknown as UserPreferencesPart<T>;\r\n  }\r\n  #partCache: Record<string, UserPreferencesPart<Record<string, unknown>>> = {};\r\n}\r\n\r\nclass UserPreferencesPart<T extends Record<string, unknown>> {\r\n\r\n  log = classLog({UserPreferencesPart});\r\n  \r\n  constructor(private userSettings: UserPreferences, private storeKey: string, data: T, private longTerm = false) {\r\n    const merged = { ...data, ...userSettings.get<T>(storeKey, longTerm) };\r\n    this.log.fn('constructor', merged);\r\n    this.#data = signal<T>(merged);\r\n  }\r\n  #data: WritableSignal<T>;\r\n\r\n  get snapshot() { return this.#data(); }\r\n\r\n  get data() { return this.#data.asReadonly(); }\r\n\r\n  get<K extends keyof T>(key: K): T[K] {\r\n    return this.#data()[key];\r\n  }\r\n\r\n  set<K extends keyof T>(key: K, value: T[K]) {\r\n    this.#data.update(data => ({ ...data, [key]: value }));\r\n    this.#save();\r\n  }\r\n\r\n  toggle<K extends keyof T>(key: K) {\r\n    this.#data.update(data => ({ ...data, [key]: !data[key] }));\r\n    this.#save();\r\n  }\r\n\r\n  setAll(data: T) {\r\n    this.#data.set(data);\r\n    this.#save();\r\n  }\r\n\r\n  setMany(data: Partial<T>) {\r\n    this.#data.update(old => ({ ...old, ...data }));\r\n    this.#save();\r\n  }\r\n\r\n  #save() {\r\n    const data = this.#data();\r\n    this.log.fn('save', data);\r\n    this.userSettings.set(this.storeKey, this.#data(), this.longTerm);\r\n  }\r\n}", "import { Of } from '../../../../../../core/type-utilities';\r\nimport { DebugTypes } from './edit-dialog-footer.models';\r\n\r\n/**\r\n * User preferences how the footer should be displayed.\r\n */\r\nexport const footerPreferences = {\r\n  key: 'edit-dialog-footer',\r\n  data: {\r\n    /** Which tab is expanded (or none) */\r\n    tab: null as Of<typeof DebugTypes>,\r\n    /**  */\r\n    expanded: false,\r\n    /** Expansion size, as it can be larger (2) */\r\n    size: 0,\r\n    /** If the footer is pinned, e.g. visible on load. If null, will be prefilled with user-host-status */\r\n    pinned: null as boolean,\r\n  }\r\n};\r\n", "import { EavEntity, EavEntityAttributes } from '.';\r\nimport { Of } from '../../../../../../../core';\r\nimport { InputTypeCatalog } from '../../../../shared/fields/input-type-catalog';\r\nimport { EavContentTypeAttributesDto } from '../json-format-v1';\r\n\r\nexport class EavContentTypeAttribute {\r\n  InputType: Of<typeof InputTypeCatalog>;\r\n  IsTitle: boolean;\r\n  Metadata: EavEntity[];\r\n  Name: string;\r\n  Settings: EavEntityAttributes;\r\n  Type: string;\r\n\r\n  private static dtoToEav(ctAttributeDto: EavContentTypeAttributesDto): EavContentTypeAttribute {\r\n    const metadata = EavEntity.dtoToEavMany(ctAttributeDto.Metadata);\r\n    const settings = EavEntityAttributes.mergeSettings(metadata);\r\n\r\n    const attribute: EavContentTypeAttribute = {\r\n      InputType: ctAttributeDto.InputType,\r\n      IsTitle: ctAttributeDto.IsTitle,\r\n      Metadata: metadata,\r\n      Name: ctAttributeDto.Name,\r\n      Settings: settings,\r\n      Type: ctAttributeDto.Type,\r\n    };\r\n    return attribute;\r\n  }\r\n\r\n  static dtoToEavMany(ctAttributesDto: EavContentTypeAttributesDto[]): EavContentTypeAttribute[] {\r\n    if (ctAttributesDto == null)\r\n      return [];\r\n\r\n    const attributes = ctAttributesDto.map(a => EavContentTypeAttribute.dtoToEav(a));\r\n    return attributes;\r\n  }\r\n}\r\n", "export class EavDimension {\r\n  /** A dimension reference, such as `*` or `en-us`.\r\n   * Usually all in lower case.\r\n   */\r\n  dimCode: string;\r\n\r\n  static create(dimCode: string): EavDimension {\r\n    return { dimCode } satisfies EavDimension;\r\n  }\r\n}\r\n", "import { EavEntityAttributes, EavFor, EavType } from '.';\r\nimport { EavEntityDto } from '../json-format-v1';\r\n\r\nexport class EavEntity {\r\n  Attributes: EavEntityAttributes;\r\n  Guid: string;\r\n  Id: number;\r\n  Owner: string;\r\n  Type: EavType;\r\n  Version: number;\r\n  For?: EavFor;\r\n  Metadata?: EavEntity[];\r\n\r\n  static dtoToEav(entityDto: EavEntityDto): EavEntity {\r\n    const attributes = EavEntityAttributes.dtoToEav(entityDto.Attributes);\r\n    const metadata = this.dtoToEavMany(entityDto.Metadata);\r\n\r\n    const entity: EavEntity = {\r\n      Attributes: attributes,\r\n      Guid: entityDto.Guid,\r\n      Id: entityDto.Id,\r\n      Owner: entityDto.Owner,\r\n      Type: entityDto.Type,\r\n      Version: entityDto.Version,\r\n      For: entityDto.For ?? null,\r\n      Metadata: metadata,\r\n    };\r\n    return entity;\r\n  }\r\n\r\n  static dtoToEavMany(entitiesDto: EavEntityDto[]): EavEntity[] {\r\n    if (entitiesDto == null)\r\n      return null;\r\n\r\n    const entities = entitiesDto.map(e => EavEntity.dtoToEav(e));\r\n    return entities;\r\n  }\r\n}\r\n", "import { EavEntity, EavField } from '.';\r\nimport { EavAttributesDto } from '../json-format-v1';\r\n\r\nexport class EavEntityAttributes {\r\n  [attributeName: string]: EavField<any>;\r\n\r\n  static dtoToEav(attributesDto: EavAttributesDto): EavEntityAttributes {\r\n    const attributes: EavEntityAttributes = {};\r\n\r\n    // loop attribute types - String, Boolean, ...\r\n    for (const [typeName, attributeDto] of Object.entries(attributesDto)) {\r\n      // loop attribute names - Description, Name, ...\r\n      for (const [attributeName, valueDto] of Object.entries(attributeDto)) {\r\n        attributes[attributeName] = EavField.dtoToEav(valueDto, typeName);\r\n      }\r\n    }\r\n    return attributes;\r\n  }\r\n\r\n  static mergeSettings(metadataItems: EavEntity[]): EavEntityAttributes {\r\n    if (metadataItems == null)\r\n      return {};\r\n\r\n    const merged: EavEntityAttributes = {};\r\n    // copy metadata settings which are not @All\r\n    for (const item of metadataItems) {\r\n      if (item.Type.Id === '@All')\r\n        continue;\r\n\r\n      for (const [name, value] of Object.entries(item.Attributes)) {\r\n        const copy: EavField<any> = { ...value };\r\n        merged[name] = copy;\r\n      }\r\n    }\r\n\r\n    // copy @All metadata settings, overwriting previous settings\r\n    for (const item of metadataItems) {\r\n      if (item.Type.Id !== '@All')\r\n        continue;\r\n\r\n      for (const [name, value] of Object.entries(item.Attributes)) {\r\n        // do not overwrite previous settings if @All is empty\r\n        const exists = merged[name] != null;\r\n        const emptyAll = value.Values[0].value === '';\r\n        if (exists && emptyAll) \r\n          continue;\r\n\r\n        const copy: EavField<any> = { ...value };\r\n        merged[name] = copy;\r\n      }\r\n    }\r\n    return merged;\r\n  }\r\n}\r\n", "import { EavFieldValue } from '.';\r\nimport { EavValuesDto } from '../json-format-v1';\r\n\r\nexport class EavField<T> {\r\n  Values: EavFieldValue<T>[];\r\n  Type: string;\r\n\r\n  static dtoToEav<T>(valueDto: EavValuesDto<T>, type: string): EavField<T> {\r\n    const values = EavFieldValue.dtoToEav(valueDto);\r\n    return {\r\n      Values: values,\r\n      Type: type,\r\n    } satisfies EavField<T>;\r\n  }\r\n}\r\n", "import { EavDimension, EavTypeMap, EavTypeName } from '.';\r\nimport { EavValuesDto } from '../json-format-v1';\r\n\r\nexport class EavFieldValue<T> {\r\n  value: T;\r\n  dimensions: EavDimension[];\r\n\r\n  static create<T>(value: T, dimensions: EavDimension[]): EavFieldValue<T> {\r\n    return { value, dimensions } satisfies EavFieldValue<T>;\r\n  }\r\n\r\n  static dtoToEav<T>(valuesDto: EavValuesDto<T>): EavFieldValue<T>[] {\r\n    const values = Object.entries(valuesDto)\r\n      .map(([langs, value]) => {\r\n        const dimensions = langs.split(',').map(lang => EavDimension.create(lang));\r\n        return this.create(value, dimensions);\r\n      });\r\n    return values;\r\n  }\r\n\r\n\r\n  static createEavFieldValue<K extends EavTypeName>(\r\n    value: EavTypeMap[K],\r\n  ): EavFieldValue<EavTypeMap[K]>[] {\r\n    return [\r\n      {\r\n        value,\r\n        dimensions: [{ dimCode: '*' }],\r\n      },\r\n    ];\r\n  }\r\n\r\n}\r\n", "import { EavEntity, EavEntityAttributes, EavFieldValue } from '.';\r\nimport { ItemIdentifierHeader } from '../../../../shared/models/edit-form.model';\r\nimport { EavEntityBundleDto, EavEntityDto } from '../json-format-v1';\r\n\r\nexport type EavTypeMap = {\r\n  String: string;\r\n  Number: number;\r\n  Boolean: boolean;\r\n  Object: Record<string, unknown>;\r\n  Unknown: unknown;\r\n};\r\n\r\nexport type EavTypeName = keyof EavTypeMap;\r\n\r\nexport class EavItem {\r\n  Entity: EavEntity;\r\n  Header: ItemIdentifierHeader;\r\n\r\n  static anyToEav(entityBundleDto: EavEntityBundleDto): EavItem {\r\n    const override = entityBundleDto.Header.ClientData?.overrideContents;\r\n\r\n    return override\r\n      ? EavItem.objToEav(override, entityBundleDto.Header, entityBundleDto.Entity)\r\n      : EavItem.dtoToEav(entityBundleDto);\r\n  }\r\n\r\n  static dtoToEav(entityBundleDto: EavEntityBundleDto): EavItem {\r\n    const entity = EavEntity.dtoToEav(entityBundleDto.Entity);\r\n\r\n    const item: EavItem = {\r\n      Entity: entity,\r\n      Header: entityBundleDto.Header,\r\n    };\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n * Converts a raw override object and DTOs into a complete EavItem.\r\n */\r\n  static objToEav(\r\n    override: Record<string, unknown>,\r\n    header: ItemIdentifierHeader,\r\n    entityDto: EavEntityDto\r\n  ): EavItem {\r\n    const attributes: EavEntityAttributes = {};\r\n\r\n    // Build attributes by converting each override key-value pair\r\n    for (const key in override) {\r\n      const value = override[key];\r\n      const type = this.getType(value);\r\n\r\n      attributes[key] = {\r\n        Values: EavFieldValue.createEavFieldValue(\r\n          value as EavTypeMap[EavTypeName], // TS braucht Hilfe hier\r\n        ),\r\n        Type: type,\r\n      };\r\n    }\r\n\r\n    // Convert DTO to entity and assign new attributes\r\n    const entity = EavEntity.dtoToEav(entityDto);\r\n    entity.Attributes = attributes;\r\n\r\n    // Combine entity and header into EavItem\r\n    return {\r\n      Entity: entity,\r\n      Header: header,\r\n    };\r\n  }\r\n\r\n\r\n\r\n  static eavToObj(eavItem: EavItem): Record<string, unknown> {\r\n    const attributes = eavItem.Entity.Attributes;\r\n    const result: Record<string, unknown> = {};\r\n\r\n    for (const key in attributes) {\r\n      const attr = attributes[key];\r\n      if (!attr.Values || attr.Values.length === 0)\r\n        continue;\r\n\r\n      // to map to object, just take the first value\r\n      result[key] = attr.Values[0].value;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n\r\n  /**\r\n   * Determines the EAV data type based on the JS type of the value.\r\n   */\r\n  static getType(value: unknown): string {\r\n    switch (typeof value) {\r\n      case 'string':\r\n        return 'String';\r\n      case 'number':\r\n        return 'Number';\r\n      case 'boolean':\r\n        return 'Boolean';\r\n      default:\r\n        return 'Unknown';\r\n    }\r\n  }\r\n\r\n\r\n\r\n\r\n\r\n}\r\n", "import { EavContentTypeAttribute, EavEntity, EavEntityAttributes } from '.';\r\nimport { EavContentTypeDto } from '../json-format-v1';\r\n\r\nexport class EavContentType {\r\n  Attributes: EavContentTypeAttribute[];\r\n  /** The NameId / Guid of this Content-Type */\r\n  Id: string;\r\n  Metadata: EavEntity[];\r\n  Name: string;\r\n  Scope: string;\r\n  Settings: EavEntityAttributes;\r\n\r\n  /** WIP v18.02 */\r\n  Title: string;\r\n\r\n  static dtoToEav(contentTypeDto: EavContentTypeDto): EavContentType {\r\n    const attributes = EavContentTypeAttribute.dtoToEavMany(contentTypeDto.Attributes);\r\n    const metadata = EavEntity.dtoToEavMany(contentTypeDto.Metadata);\r\n    const settings = EavEntityAttributes.mergeSettings(metadata);\r\n\r\n    const contentType: EavContentType = {\r\n      Attributes: attributes,\r\n      Id: contentTypeDto.Id,\r\n      Metadata: metadata,\r\n      Name: contentTypeDto.Name,\r\n      Scope: contentTypeDto.Scope,\r\n      Settings: settings,\r\n      Title: contentTypeDto.Title,\r\n    };\r\n    return contentType;\r\n  }\r\n\r\n  static dtoToEavMany(contentTypesDto: EavContentTypeDto[]): EavContentType[] {\r\n    if (contentTypesDto == null)\r\n      return null;\r\n\r\n    const result = contentTypesDto.map(ct => EavContentType.dtoToEav(ct));\r\n    return result;\r\n  }\r\n}\r\n", "import { Injectable } from '@angular/core';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { EavEntity } from '../models/eav';\r\nimport { EavEntityDto } from '../models/json-format-v1';\r\nimport { SignalStoreBase } from '../store/signal-store-base';\r\n\r\n/**\r\n * Content-Type Items are additional entities which the ContentType info needs.\r\n * For example, external formulas.\r\n * \r\n * This service stores / retrieves these.\r\n */\r\n@Injectable({ providedIn: 'root' })\r\nexport class ContentTypeItemService extends SignalStoreBase<string, EavEntity> {\r\n\r\n  constructor() {\r\n    super(classLog({ContentTypeItemService}));\r\n  }\r\n\r\n  override getId = (item: EavEntity) => item.Guid;\r\n\r\n  addContentTypeItems(contentTypeItems: EavEntityDto[]): void {\r\n    const converted = EavEntity.dtoToEavMany(contentTypeItems);\r\n    this.addMany(converted);\r\n  }\r\n\r\n}\r\n", "import { ItemAddIdentifier } from '../../../shared/models/edit-form.model';\r\nimport { EavItem } from '../models/eav';\r\n\r\nexport class ItemHelper {\r\n  static getContentTypeNameId(item: EavItem): string {\r\n    return item.Entity.Type?.Id\r\n      ?? (item.Header as ItemAddIdentifier).ContentTypeName;\r\n  }\r\n}", "import { Injectable } from '@angular/core';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { ItemHelper } from '../helpers/item.helper';\r\nimport { EavContentType, EavContentTypeAttribute, EavItem } from '../models/eav';\r\nimport { EavContentTypeDto } from '../models/json-format-v1';\r\nimport { SignalStoreBase } from '../store/signal-store-base';\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class ContentTypeService extends SignalStoreBase<string, EavContentType> {\r\n\r\n  constructor() {\r\n    super(classLog({ContentTypeService}));\r\n  }\r\n  \r\n  override getId = (item: EavContentType) => item.Id;\r\n\r\n  addContentTypes(contentTypes: EavContentTypeDto[]): void {\r\n    const converted = EavContentType.dtoToEavMany(contentTypes);\r\n    this.addMany(converted);\r\n  }\r\n\r\n  getContentTypeOfItem(item: EavItem): EavContentType {\r\n    const nameId = ItemHelper.getContentTypeNameId(item);\r\n    return this.get(nameId);\r\n  }\r\n\r\n  getAttribute(guid: string, name: string): EavContentTypeAttribute {\r\n    return this.get(guid).Attributes.find(a => a.Name === name);\r\n  }\r\n\r\n  getAttributeOfItem(item: EavItem, name: string): EavContentTypeAttribute {\r\n    return this.getContentTypeOfItem(item).Attributes.find(a => a.Name === name);\r\n  }\r\n}\r\n", "import { Injectable } from '@angular/core';\r\nimport { Of } from '../../../../../../core';\r\nimport { AttributeInputType } from '../../../../../../edit-types/src/InputTypeName';\r\nimport { InputTypeCatalog } from '../../../shared/fields/input-type-catalog';\r\nimport { InputTypeHelpers } from '../../../shared/fields/input-type-helpers';\r\nimport { InputTypeMetadata } from '../../../shared/fields/input-type-metadata.model';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { EavContentTypeAttribute } from '../models/eav';\r\nimport { SignalStoreBase } from '../store/signal-store-base';\r\nimport { InputTypeSpecs } from './input-type-specs.model';\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class InputTypeService extends SignalStoreBase<string, InputTypeMetadata> {\r\n\r\n  constructor() {\r\n    super(classLog({InputTypeService}, null));\r\n  }\r\n\r\n  override getId = (item: InputTypeMetadata) => item.Type;\r\n\r\n  /**\r\n   * Get Name specs with a nice name and a longer name\r\n   * Note: ATM only used in the external connector, not sure why it's even here.\r\n   */\r\n  getAttributeInputTypes(attributes: EavContentTypeAttribute[]): AttributeInputType[] {\r\n    const inputTypes = this.getAll();\r\n    return attributes.map(attribute => {\r\n      const specs = this.#getSpecsInternal(attribute.InputType, inputTypes);\r\n      return {\r\n        name: attribute.Name,\r\n        inputType: specs.inputType,\r\n      } satisfies AttributeInputType;\r\n    });\r\n  }\r\n\r\n  getSpecs(attribute: EavContentTypeAttribute): InputTypeSpecs {\r\n    return this.#getSpecsInternal(attribute.InputType, this.getAll());\r\n  }\r\n\r\n  #getSpecsInternal(inputType: Of<typeof InputTypeCatalog>, inputTypes: InputTypeMetadata[]): InputTypeSpecs {\r\n    const inputTypeMetadata = inputTypes.find(i => i.Type === inputType);\r\n    const name = inputType.toString();\r\n    const calculated: InputTypeSpecs = {\r\n      inputType,\r\n      isExternal: !!inputTypeMetadata?.UiAssets?.default,\r\n      mustUseGuid: !name.startsWith('string') && !name.startsWith('number'),\r\n      componentTagName: `field-${inputType}`,\r\n      componentTagDialogName: `field-${inputType}-dialog`,\r\n      metadata: inputTypeMetadata,\r\n      isNewPicker: InputTypeHelpers.isNewPicker(inputType),\r\n    };\r\n    return calculated;\r\n  }\r\n\r\n}\r\n", "import { FieldValue } from '../../../../../edit-types/src/FieldValue';\r\nimport { classLog } from '../../shared/logging';\r\nimport { FormLanguage } from '../form/form-languages.model';\r\nimport { EavDimension } from '../shared/models/eav/eav-dimension';\r\nimport { EavEntityAttributes } from '../shared/models/eav/eav-entity-attributes';\r\nimport { EavField } from '../shared/models/eav/eav-field';\r\nimport { EavFieldValue } from '../shared/models/eav/eav-field-value';\r\nimport { ItemValuesOfLanguage } from '../state/item-values-of-language.model';\r\nimport { DimensionReader } from './dimension-reader';\r\nimport { FieldReader } from './field-reader';\r\n\r\nexport class FieldWriter {\r\n\r\n  log = classLog({FieldWriter});\r\n\r\n  /** Copy attributes from item */\r\n  #updateAttribute(\r\n    oldAttributes: EavEntityAttributes,\r\n    attributeKey: string,\r\n    attribute: EavField<any>,\r\n  ): EavEntityAttributes {\r\n    const newAttributes: EavEntityAttributes = {};\r\n    if (Object.keys(oldAttributes).length === 0) {\r\n      const attributeCopy: EavField<any> = { ...attribute };\r\n      newAttributes[attributeKey] = attributeCopy;\r\n      return newAttributes;\r\n    }\r\n\r\n    for (const key of Object.keys(oldAttributes)) {\r\n      if (key === attributeKey) {\r\n        const attributeCopy: EavField<any> = { ...attribute };\r\n        newAttributes[key] = attributeCopy;\r\n      } else {\r\n        const attributeCopy: EavField<any> = { ...oldAttributes[key] };\r\n        newAttributes[key] = attributeCopy;\r\n      }\r\n    }\r\n\r\n    if (oldAttributes[attributeKey] == null) {\r\n      const attributeCopy: EavField<any> = { ...attribute };\r\n      newAttributes[attributeKey] = attributeCopy;\r\n    }\r\n    return newAttributes;\r\n  }\r\n\r\n  /** Update values for languageKey */\r\n  updateAttributesValues(\r\n    allFields: EavEntityAttributes,\r\n    updateValues: ItemValuesOfLanguage,\r\n    language: FormLanguage,\r\n  ): EavEntityAttributes {\r\n    const l = this.log.fn('updateAttributesValues', { allFields, updateValues, language });\r\n    // copy attributes from item\r\n    const eavAttributes: EavEntityAttributes = {};\r\n    Object.keys(allFields).forEach(attributeKey => {\r\n      const newItemValue = updateValues[attributeKey];\r\n      // if new value exist update attribute for languageKey   \r\n      // it's important to check for undefined, because empty string and sometimes null (bool-tristate) are valid values\r\n      if (newItemValue !== undefined) {\r\n        const fr = new FieldReader(allFields[attributeKey], language);\r\n        const valueWithLanguageExist = fr.isEditableOrReadonlyTranslationExist();\r\n\r\n        // if valueWithLanguageExist update value for languageKey\r\n        if (valueWithLanguageExist) {\r\n          const newValues: EavField<any> = {\r\n            ...allFields[attributeKey],\r\n            Values: allFields[attributeKey].Values.map(val => {\r\n              const hasLanguage = new DimensionReader(val.dimensions, language).hasCurrent;\r\n              const newValue: EavFieldValue<any> = hasLanguage\r\n                // Update value for languageKey\r\n                ? {\r\n                    ...val,\r\n                    value: newItemValue,\r\n                  }\r\n                  : val;\r\n              return newValue;\r\n            })\r\n          };\r\n          eavAttributes[attributeKey] = newValues;\r\n        } else { // else add new value with dimension languageKey\r\n          l.a('saveAttributeValues add values ', { newItemValue });\r\n          const newEavValue = EavFieldValue.create(newItemValue, [EavDimension.create(language.current)]);\r\n          eavAttributes[attributeKey] = {\r\n            ...allFields[attributeKey],\r\n            Values: [...allFields[attributeKey].Values, newEavValue]\r\n          } satisfies EavField<any>;\r\n        }\r\n      } else { // else copy item attributes\r\n        eavAttributes[attributeKey] = { ...allFields[attributeKey] };\r\n      }\r\n    });\r\n    return eavAttributes;\r\n  }\r\n\r\n  /** update attribute value, and change language readonly state if needed */\r\n  updateAttributeValue(\r\n    allAttributes: EavEntityAttributes,\r\n    attributeKey: string,\r\n    updateValue: FieldValue,\r\n    language: FormLanguage,\r\n    isReadOnly: boolean,\r\n  ): EavEntityAttributes {\r\n    // copy attributes from item\r\n    let eavAttributes: EavEntityAttributes = {};\r\n    let newLanguageValue = language.current;\r\n\r\n    if (isReadOnly)\r\n      newLanguageValue = `~${language.current}`;\r\n\r\n    const attribute: EavField<any> = {\r\n      ...allAttributes[attributeKey], Values: allAttributes[attributeKey].Values.map(val => {\r\n        const hasLanguage = new DimensionReader(val.dimensions, language).hasCurrent;\r\n        const newValue: EavFieldValue<any> = hasLanguage\r\n          // Update value and dimension\r\n          ? {\r\n            ...val,\r\n            // update value\r\n            value: updateValue,\r\n            // update languageKey with newLanguageValue\r\n            dimensions: val.dimensions.map(d => {\r\n              const dimensionIsForLanguage = (d.dimCode === language.current\r\n                || d.dimCode === `~${language.current}`\r\n                || (language.current === language.primary && d.dimCode === '*'));\r\n              return dimensionIsForLanguage\r\n                ? { dimCode: newLanguageValue } satisfies EavDimension\r\n                : d;\r\n            })\r\n          }\r\n          : val;\r\n        return newValue;\r\n      })\r\n    };\r\n    eavAttributes = this.#updateAttribute(allAttributes, attributeKey, attribute);\r\n    return eavAttributes;\r\n  }\r\n\r\n  addAttributeValue(\r\n    allAttributes: EavEntityAttributes,\r\n    attributeValue: EavFieldValue<any>,\r\n    attributeKey: string,\r\n    attributeType: string,\r\n  ): EavEntityAttributes {\r\n    // copy attributes from item\r\n    let eavAttributes: EavEntityAttributes = {};\r\n    const attribute: EavField<any> =\r\n      Object.keys(allAttributes).length === 0 || !allAttributes[attributeKey]\r\n        ? {\r\n          ...allAttributes[attributeKey],\r\n          Values: [attributeValue],\r\n          Type: attributeType\r\n        }\r\n        : {\r\n          ...allAttributes[attributeKey],\r\n          Values: [...allAttributes[attributeKey].Values, attributeValue],\r\n          Type: attributeType\r\n        };\r\n    eavAttributes = this.#updateAttribute(allAttributes, attributeKey, attribute);\r\n    return eavAttributes;\r\n  }\r\n\r\n  /** Add dimension to value with existing dimension */\r\n  addAttributeDimension(\r\n    allAttributes: EavEntityAttributes,\r\n    attributeKey: string,\r\n    newDimensionValue: string,\r\n    existingDimensionValue: string,\r\n    defaultLanguage: string,\r\n    isReadOnly: boolean,\r\n  ): EavEntityAttributes {\r\n    // copy attributes from item\r\n    let eavAttributes: EavEntityAttributes = {};\r\n    let newLanguageValue = newDimensionValue;\r\n\r\n    if (isReadOnly) {\r\n      newLanguageValue = `~${newDimensionValue}`;\r\n    }\r\n\r\n    const attribute: EavField<any> = {\r\n      ...allAttributes[attributeKey], Values: allAttributes[attributeKey].Values.map(eavValue => {\r\n        const newValue: EavFieldValue<any> = eavValue.dimensions.find(d => d.dimCode === existingDimensionValue\r\n          || (existingDimensionValue === defaultLanguage && d.dimCode === '*'))\r\n          // Update dimension for current language\r\n          ? {\r\n            ...eavValue,\r\n            // if languageKey already exist\r\n            dimensions: eavValue.dimensions.concat({ dimCode: newLanguageValue })\r\n          }\r\n          : eavValue;\r\n        return newValue;\r\n      })\r\n    };\r\n    eavAttributes = this.#updateAttribute(allAttributes, attributeKey, attribute);\r\n    return eavAttributes;\r\n  }\r\n\r\n  /** Removes dimension (language) from attribute. If multiple dimensions exist, delete only dimension, else delete value and dimension */\r\n  removeAttributeDimension(attributes: EavEntityAttributes, attributeKey: string, language: string): EavEntityAttributes {\r\n    const oldAttributes = attributes;\r\n    const validDimensions = [language, `~${language}`];\r\n\r\n    const value = oldAttributes[attributeKey].Values.find(eavValue => {\r\n      const dimensionExists = eavValue.dimensions.some(d => validDimensions.includes(d.dimCode));\r\n      return dimensionExists;\r\n    });\r\n\r\n    // given dimension doesn't exist for this attribute so no change is needed\r\n    if (!value) {\r\n      const attributesCopy: EavEntityAttributes = { ...oldAttributes };\r\n      return attributesCopy;\r\n    }\r\n\r\n    let newAttribute: EavField<any>;\r\n    if (value.dimensions.length > 1) {\r\n      // if multiple dimensions exist delete only dimension\r\n      newAttribute = {\r\n        ...oldAttributes[attributeKey],\r\n        Values: oldAttributes[attributeKey].Values.map(eavValue => {\r\n          const dimensionExists = eavValue.dimensions.some(d => validDimensions.includes(d.dimCode));\r\n          return (!dimensionExists)\r\n            ? eavValue\r\n            : {\r\n                ...eavValue,\r\n                dimensions: eavValue.dimensions.filter(d => !validDimensions.includes(d.dimCode)),\r\n              } satisfies EavFieldValue<any>;\r\n        })\r\n      };\r\n    } else if (value.dimensions.length === 1) {\r\n      // if only one dimension exists delete value and dimension\r\n      newAttribute = {\r\n        ...oldAttributes[attributeKey],\r\n        Values: oldAttributes[attributeKey].Values.filter(eavValue => {\r\n          const dimensionExists = eavValue.dimensions.some(d => validDimensions.includes(d.dimCode));\r\n          return !dimensionExists;\r\n        })\r\n      };\r\n    }\r\n\r\n    const newAttributes = this.#updateAttribute(oldAttributes, attributeKey, newAttribute);\r\n    return newAttributes;\r\n  }\r\n\r\n}", "import { FieldSettings } from '../../../../../edit-types/src/FieldSettings';\r\nimport { FieldValue } from '../../../../../edit-types/src/FieldValue';\r\nimport { InputTypeMetadata } from '../../shared/fields/input-type-metadata.model';\r\nimport { classLog } from '../../shared/logging';\r\nimport { ItemEditIdentifier, ItemIdentifierHeader } from '../../shared/models/edit-form.model';\r\nimport { FormLanguage, Language } from '../form/form-languages.model';\r\nimport { FieldReader } from '../localization/field-reader';\r\nimport { FieldWriter } from '../localization/field-writer';\r\nimport { EntityReader, FieldDefaults } from '../shared/helpers';\r\nimport { FieldValueHelpers } from '../shared/helpers/field-value.helpers';\r\nimport { EavContentTypeAttribute, EavDimension, EavEntity, EavFieldValue, EavItem } from '../shared/models/eav';\r\nimport { ItemValuesOfLanguage } from './item-values-of-language.model';\r\nimport { ItemService } from './item.service';\r\nimport { SaveResult } from './save-result.model';\r\n\r\nconst logSpecs = {\r\n  all: true,\r\n  updateItemId: false,\r\n  updateItemHeader: false,\r\n  addItemAttributeValue: false,\r\n  updateItemAttributeValue: false,\r\n  setDefaultValue: false,\r\n  updateItemAttributesValues: false,\r\n  addItemAttributeDimension: false,\r\n  removeItemAttributeDimension: false,\r\n  updateItemMetadata: false,\r\n};\r\n\r\nexport class ItemUpdateHelper {\r\n\r\n  log = classLog({ItemUpdateHelper}, logSpecs);\r\n  \r\n  constructor(private itemSvc: ItemService) { }\r\n\r\n  updateItemId(saveResult: SaveResult): void {\r\n    const l = this.log.fnIf('updateItemId', { saveResult });\r\n    const entityGuid = Object.keys(saveResult)[0];\r\n    const entityId = saveResult[entityGuid];\r\n    const oldItem = this.itemSvc.get(entityGuid);\r\n    if (!oldItem || ((oldItem.Header as ItemEditIdentifier).EntityId !== 0 && oldItem.Entity.Id !== 0))\r\n      return;\r\n\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Header: {\r\n        ...oldItem.Header,\r\n        EntityId: entityId,\r\n      },\r\n      Entity: {\r\n        ...oldItem.Entity,\r\n        Id: entityId,\r\n      }\r\n    };\r\n    this.itemSvc.add(newItem);\r\n  }\r\n\r\n\r\n  /** Update parts of the header; ATM just to tell us about the slot being empty */\r\n  updateItemHeader(entityGuid: string, header: ItemIdentifierHeader): void {\r\n    const l = this.log.fnIf('updateItemHeader', { entityGuid, header });\r\n    const oldItem = this.itemSvc.get(entityGuid);\r\n    if (!oldItem) return;\r\n\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Header: {\r\n        ...header\r\n      }\r\n    };\r\n    this.itemSvc.add(newItem);\r\n    l.end();\r\n  }\r\n\r\n  //#region Item Attribute - Single Value\r\n\r\n  addItemAttributeValue(\r\n    entityGuid: string,\r\n    attributeKey: string,\r\n    newValue: FieldValue,\r\n    currentLanguage: string,\r\n    isReadOnly: boolean,\r\n    attributeType: string,\r\n    isTransaction = false,\r\n    transactionItem?: EavItem,\r\n  ): EavItem {\r\n    const l = this.log.fnIf('addItemAttributeValue', { entityGuid, attributeKey, newValue, currentLanguage, isReadOnly, attributeType, isTransaction, transactionItem });\r\n    const newValueDimension = isReadOnly ? `~${currentLanguage}` : currentLanguage;\r\n    const newEavValue = EavFieldValue.create(newValue, [EavDimension.create(newValueDimension)]);\r\n    const oldItem = transactionItem ?? this.itemSvc.get(entityGuid);\r\n\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Entity: {\r\n        ...oldItem.Entity,\r\n        Attributes: new FieldWriter().addAttributeValue(oldItem.Entity.Attributes, newEavValue, attributeKey, attributeType),\r\n      }\r\n    };\r\n\r\n    // if we're in a transaction, then save/update will happen later on, so don't trigger state changes yet\r\n    if (!isTransaction) \r\n      this.itemSvc.add(newItem);\r\n\r\n    return newItem;\r\n  }\r\n\r\n  updateItemAttributeValue(\r\n    entityGuid: string,\r\n    attributeKey: string,\r\n    newValue: FieldValue,\r\n    language: FormLanguage,\r\n    isReadOnly: boolean,\r\n  ): void {\r\n    const l = this.log.fnIf('updateItemAttributeValue', { entityGuid, attributeKey, newValue, language, isReadOnly });\r\n    const oldItem = this.itemSvc.get(entityGuid);\r\n    if (!oldItem) return;\r\n\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Entity: {\r\n        ...oldItem.Entity,\r\n        Attributes: new FieldWriter().updateAttributeValue(\r\n          oldItem.Entity.Attributes, attributeKey, newValue, language, isReadOnly,\r\n        ),\r\n      }\r\n    };\r\n    this.itemSvc.add(newItem);\r\n  }\r\n\r\n  setDefaultValue(\r\n    item: EavItem,\r\n    ctAttribute: EavContentTypeAttribute,\r\n    inputType: InputTypeMetadata,\r\n    settings: FieldSettings,\r\n    languages: Language[],\r\n    defaultLanguage: string,\r\n  ): FieldValue {\r\n    const l = this.log.fnIf('setDefaultValue', { item, ctAttribute, inputType, settings, languages, defaultLanguage }, `Name: ${ctAttribute.Name}`);\r\n    const defaultValue = new FieldDefaults(ctAttribute.Name, inputType?.Type, settings, item.Header).getDefaultOrPrefillValue();\r\n\r\n    // const defaultLanguageValue = LocalizationHelpers.getBestValue(\r\n    //   item.Entity.Attributes[ctAttribute.Name],\r\n    //   defaultLanguage,\r\n    //   // defaultLanguage,\r\n    //   BestValueModes.Strict,\r\n    // );\r\n    const defaultLanguageValue = new FieldReader(item.Entity.Attributes[ctAttribute.Name], defaultLanguage).currentOrDefault?.value;\r\n\r\n    // 2023-08-31 2dm simplified; leave comments in till EOY in case I broke something\r\n    const languageCode = (languages.length === 0 || inputType?.DisableI18n) ? '*' : defaultLanguage;\r\n    if (defaultLanguageValue === undefined) {\r\n      this.addItemAttributeValue(item.Entity.Guid, ctAttribute.Name, defaultValue, languageCode, false, ctAttribute.Type);\r\n    } else {\r\n      // most likely used only for entity fields because we can never know if they were cleaned out or brand new\r\n      this.updateItemAttributeValue(item.Entity.Guid, ctAttribute.Name, defaultValue, { current: languageCode, primary: defaultLanguage }, false);\r\n    }\r\n\r\n    // return what was used, so it can be checked on form-init\r\n    return l.r(defaultValue);\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Item Attribute - Multi Value\r\n\r\n  updateItemAttributesValues(entityGuid: string, newValues: ItemValuesOfLanguage, language: FormLanguage): void {\r\n    const l = this.log.fnIf('updateItemAttributesValues', { entityGuid, newValues, language });\r\n    const oldItem = this.itemSvc.get(entityGuid);\r\n    if (!oldItem) return l.end('Item not found');\r\n\r\n    const reader = new EntityReader(language);\r\n    const oldValues: ItemValuesOfLanguage = {};\r\n    const relevantValues = Object.entries(oldItem.Entity.Attributes)\r\n      .filter(([name]) => newValues.hasOwnProperty(name));\r\n    for (const [name, values] of relevantValues)\r\n      oldValues[name] = reader.getBestValue(values);\r\n\r\n    const changes = FieldValueHelpers.getItemValuesChanges(oldValues, newValues);\r\n    if (changes == null)\r\n      return l.end('No changes');\r\n\r\n    const newAttributes = new FieldWriter().updateAttributesValues(oldItem.Entity.Attributes, changes, language);\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Entity: {\r\n        ...oldItem.Entity,\r\n        Attributes: newAttributes,\r\n      }\r\n    };\r\n    this.itemSvc.add(newItem);\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Item Value Dimensions\r\n\r\n  /**\r\n   * Update entity attribute dimension. Add readonly languageKey to existing useFromLanguageKey.\r\n   * Example to useFrom en-us add fr-fr = \"en-us,-fr-fr\"\r\n   */\r\n  addItemAttributeDimension(\r\n    entityGuid: string,\r\n    attributeKey: string,\r\n    currentLanguage: string,\r\n    shareWithLanguage: string,\r\n    defaultLanguage: string,\r\n    isReadOnly: boolean,\r\n    transactionItem?: EavItem,\r\n  ): void {\r\n    const l = this.log.fnIf('addItemAttributeDimension', { entityGuid, attributeKey, currentLanguage, shareWithLanguage, defaultLanguage, isReadOnly, transactionItem });\r\n    const oldItem = transactionItem ?? this.itemSvc.get(entityGuid);\r\n\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Entity: {\r\n        ...oldItem.Entity,\r\n        Attributes: new FieldWriter().addAttributeDimension(\r\n          oldItem.Entity.Attributes, attributeKey, currentLanguage, shareWithLanguage, defaultLanguage, isReadOnly,\r\n        ),\r\n      }\r\n    };\r\n    this.itemSvc.add(newItem);\r\n  }\r\n\r\n  // TODO:: Old Code, remove after testing ist done\r\n  removeItemAttributeDimension(\r\n    entityGuid: string,\r\n    fieldName: string,\r\n    current: string,\r\n    delayUpsert = false,\r\n    transactionItem?: EavItem,\r\n  ): EavItem {\r\n    const l = this.log.fnIf('removeItemAttributeDimension', { entityGuid, attributeKey: fieldName, currentLanguage: current, isTransaction: delayUpsert, transactionItem });\r\n    const oldItem = transactionItem ?? this.itemSvc.get(entityGuid);\r\n\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Entity: {\r\n        ...oldItem.Entity,\r\n        Attributes: new FieldWriter().removeAttributeDimension(oldItem.Entity.Attributes, fieldName, current),\r\n      }\r\n    };\r\n\r\n    if (!delayUpsert)\r\n      this.itemSvc.add(newItem);\r\n    return l.r(newItem);\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Metadata\r\n\r\n  updateItemMetadata(entityGuid: string, metadata: EavEntity[]): void {\r\n    const l = this.log.fnIf('updateItemMetadata', { entityGuid, metadata });\r\n    const oldItem = this.itemSvc.get(entityGuid);\r\n    const newItem: EavItem = {\r\n      ...oldItem,\r\n      Entity: {\r\n        ...oldItem.Entity,\r\n        Metadata: metadata,\r\n      }\r\n    };\r\n    this.itemSvc.add(newItem);\r\n    l.end('ok', { newItem });\r\n  }\r\n\r\n  //#endregion\r\n\r\n}", "import { Injectable, Signal } from '@angular/core';\r\nimport { map, Observable } from 'rxjs';\r\nimport { eavConstants } from '../../shared/constants/eav.constants';\r\nimport { classLog } from '../../shared/logging';\r\nimport { ItemIdentifierHeader } from '../../shared/models/edit-form.model';\r\nimport { mapUntilChanged, mapUntilObjChanged } from '../../shared/rxJs/mapUntilChanged';\r\nimport { ComputedCacheHelper } from '../../shared/signals/computed-cache';\r\nimport { EavEntity, EavFor, EavItem } from '../shared/models/eav';\r\nimport { EavEntityAttributes } from '../shared/models/eav/eav-entity-attributes';\r\nimport { EavEntityBundleDto } from '../shared/models/json-format-v1';\r\nimport { SignalStoreObservableBase } from '../shared/store/signal-store-observable-base';\r\nimport { ItemUpdateHelper } from './item-updater.helper';\r\n\r\n/**\r\n * This class provides access to the items / entities cache which are being edited in the UI.\r\n * \r\n * It's undergoing a lot of refactoring to get rid of observables, so ATM it's a bit confusing.\r\n */\r\n@Injectable({ providedIn: 'root' })\r\nexport class ItemService extends SignalStoreObservableBase<string, EavItem> {\r\n\r\n  constructor() {\r\n    super(classLog({ItemService}));\r\n  }\r\n\r\n  override getId = (item: EavItem) => item.Entity.Guid;\r\n\r\n  public updater = new ItemUpdateHelper(this);\r\n\r\n  //#region Loaders and Updaters\r\n\r\n  loadItems(dtoItems: EavEntityBundleDto[]): void {\r\n    const items = dtoItems.map(item => EavItem.anyToEav(item));\r\n    this.addMany(items);\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Item Attributes\r\n\r\n  itemAttributesSignal(entityGuid: string): Signal<EavEntityAttributes> {\r\n    const l = this.log.fn('itemAttributes', { entityGuid });\r\n    const result = this.#itemAttributesCache.getOrCreate(entityGuid, () => this.getSignal(entityGuid)()?.Entity.Attributes);\r\n    return l.r(result);\r\n  }\r\n  #itemAttributesCache = new ComputedCacheHelper<string, EavEntityAttributes>('itemAttributes');\r\n\r\n  getItemAttributes(entityGuid: string): EavEntityAttributes {\r\n    const l = this.log.fn('getItemAttributes', { entityGuid });\r\n    const result = this.get(entityGuid)?.Entity.Attributes;\r\n    return l.r(result);\r\n  }\r\n\r\n  getItemAttributes$(entityGuid: string): Observable<EavEntityAttributes> {\r\n    return this.list$.pipe(\r\n      map(items => items.find(item => item.Entity.Guid === entityGuid)?.Entity.Attributes),\r\n      mapUntilChanged(m => m),\r\n    );\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Item Headers\r\n\r\n  getItemHeader(entityGuid: string): ItemIdentifierHeader {\r\n    return this.get(entityGuid)?.Header;\r\n  };\r\n\r\n  getItemHeader$(entityGuid: string): Observable<ItemIdentifierHeader> {\r\n    return this.list$.pipe(\r\n      map(items => items.find(item => item.Entity.Guid === entityGuid)?.Header),\r\n      mapUntilObjChanged(m => m),\r\n    );\r\n  }\r\n\r\n  getItemHeaderSignal(entityGuid: string): Signal<ItemIdentifierHeader> {\r\n    return this.#itemHeaderCache.getOrCreate(entityGuid, () => this.getSignal(entityGuid)()?.Header);\r\n  }\r\n  #itemHeaderCache = new ComputedCacheHelper<string, ItemIdentifierHeader>('itemHeader');\r\n\r\n  //#endregion\r\n\r\n  //#region Item Header Properties\r\n\r\n  slotIsEmpty(entityGuid: string): Signal<boolean> {\r\n    return this.#slotIsEmptyCache.getOrCreate(entityGuid, () => {\r\n      const header = this.getSignal(entityGuid)()?.Header;\r\n      return header == null ? true : header.IsEmptyAllowed && header.IsEmpty;\r\n    });\r\n  }\r\n  #slotIsEmptyCache = new ComputedCacheHelper<string, boolean>('slotIsEmpty');\r\n\r\n  //#endregion\r\n\r\n  //#region Item Metadata & For (Metadata Target)\r\n\r\n  /** Sync get-item-for info to show metadata-target info on an entity in the UI */\r\n  getItemFor(entityGuid: string): EavFor {\r\n    return this.get(entityGuid)?.Entity.For;\r\n  }\r\n\r\n\r\n  getItemNote(entityGuid: string): EavEntity | undefined {\r\n    return this.get(entityGuid)?.Entity.Metadata\r\n      ?.find(metadata => metadata.Type.Name === eavConstants.contentTypes.notes);\r\n  }\r\n\r\n  //#endregion\r\n\r\n}\r\n", "/** Prefix for any kind of field settings */\r\nexport const SettingsFormulaPrefix = 'Field.Settings.';\r\n\r\n\r\n\r\n/** Default targets for formulas */\r\nexport const FormulaDefaultTargets = {\r\n  Disabled: `${SettingsFormulaPrefix}Disabled`,\r\n  Name: `${SettingsFormulaPrefix}Name`,\r\n  Notes: `${SettingsFormulaPrefix}Notes`,\r\n  Required: `${SettingsFormulaPrefix}Required`,\r\n  Value: 'Field.Value',\r\n  Visible: `${SettingsFormulaPrefix}Visible`,\r\n  Validation: 'Field.Validation',\r\n};\r\n\r\n/** Values of the Default Targets (used often, so precalculated) */\r\nexport const FormulaDefaultTargetValues = Object.values(FormulaDefaultTargets);\r\n\r\n\r\n\r\n/** Targets for new Pickers only */\r\nexport const FormulaNewPickerTargets = {\r\n  Options: 'Field.Options',\r\n  Selected: 'Field.Selected',\r\n};\r\n\r\n/** Values of the NewPicker Targets (used often, so precalculated) */\r\nexport const FormulaNewPickerTargetValues = Object.values(FormulaNewPickerTargets);\r\n\r\nexport const FormulaSpecialPickerTargets = [\r\n  FormulaNewPickerTargets.Options,\r\n  // FormulaDefaultTargets.Value,\r\n  FormulaNewPickerTargets.Selected,\r\n];\r\n\r\n/** These formulas should auto-sleep unless specified otherwise */\r\nexport const FormulaSpecialPickerAutoSleep = [\r\n  FormulaNewPickerTargets.Options,\r\n  FormulaNewPickerTargets.Selected,\r\n];\r\n\r\n\r\n\r\nexport const FormulaOptionalTargets = {\r\n  Collapsed: `${SettingsFormulaPrefix}Collapsed`,\r\n  DropdownValues: `${SettingsFormulaPrefix}DropdownValues`,\r\n};\r\n\r\nexport const FormulaOptionalTargetValues = Object.values(FormulaOptionalTargets);\r\n\r\n\r\n\r\n/** All possible targets for formulas (merged) */\r\nexport const FormulaTargets = {\r\n  ...FormulaDefaultTargets,\r\n  ...FormulaOptionalTargets,\r\n  ...FormulaNewPickerTargets,\r\n} as const /* the as const ensures that the keys/values can be strictly checked */;\r\n\r\n/** Validation object interface */\r\nexport interface FormulaFieldValidation {\r\n  severity: '' | 'error' | 'warning';\r\n  message?: string;\r\n}\r\n\r\n", "import { FieldValueOrResultRaw } from './results/formula-results.models';\r\nimport { FormulaV1Context } from './run/formula-run-context.model';\r\nimport { FormulaV1Data } from './run/formula-run-data.model';\r\n\r\n//#region Formula strings / parts to process and show templates\r\n\r\n/**\r\n * This must be in front of every formula so that JavaScript will run it.\r\n * Normally it's not there, so it's added before running the code.\r\n */\r\nexport const runFormulaPrefix = 'function ';\r\n\r\n// V1 sample, just for reference\r\n// const defaultFormulaV1 = `${requiredFormulaPrefix}v1 (data, context) {\r\n//   return data.value;\r\n// }`;\r\n\r\n// new\r\nconst defaultFormulaV2 = `v2((data, context) => {\r\n  return data.value;\r\n});`;\r\n\r\nexport const defaultFormula = defaultFormulaV2;\r\n\r\nconst listItemFormulaV2 = `v2((data, context, item) => {\r\n  return data.value;\r\n});`;\r\n\r\nexport const defaultListItemFormula = listItemFormulaV2;\r\n\r\n//#endregion\r\n\r\n//#region Formula Function Types\r\n\r\nexport type FormulaFunction = FormulaFunctionDefault | FormulaFunctionV1;\r\n\r\nexport type FormulaFunctionDefault = () => FieldValueOrResultRaw;\r\n\r\nexport type FormulaFunctionV1 = (\r\n  data: FormulaV1Data,\r\n  context: FormulaV1Context,\r\n  // 2025-04-22 #DropFormulaParamExperimental - remove this comment and warnings ca. 2026-Q2\r\n  // experimental: FormulaV1Experimental\r\n) => FieldValueOrResultRaw;\r\n\r\n//#endregion\r\n\r\n//#region Formula Versions\r\n\r\nexport const FormulaVersions = {\r\n  V1: 'v1',\r\n  V2: 'v2',\r\n} as const /* the as const ensures that the keys/values can be strictly checked */;\r\n\r\n//#endregion", "import { FieldSettings } from '../../../../../../edit-types/src/FieldSettings';\r\nimport { FieldValue } from '../../../../../../edit-types/src/FieldValue';\r\nimport { classLog, ClassLogger } from '../../../shared/logging';\r\nimport { DebugFields } from '../../edit-debug';\r\nimport { FieldLogicManager } from './field-logic-manager';\r\nimport { FieldLogicTools } from './field-logic-tools';\r\n\r\nconst logSpecs = {\r\n  all: false,\r\n  constructor: true,\r\n  update: true,\r\n  fields: [...DebugFields, 'Icon'],\r\n}\r\n\r\nexport abstract class FieldLogicBase {\r\n\r\n  /** Logger - lazy created on first access if not yet created */\r\n  get log() { return this.#log ??= classLog({FieldLogicBase}, logSpecs).extendName(`[${this.name}]`) };\r\n  \r\n  #log: ClassLogger<typeof logSpecs>;\r\n\r\n  constructor(inheritingClass: Record<string, unknown> | string, logThis?: boolean) {\r\n    this.#log = classLog(inheritingClass ?? {FieldLogicBase}, logSpecs, null, logThis);\r\n    this.name ??= this.#log.name;\r\n    this.log.fnIf('constructor');\r\n  }\r\n\r\n  /** Input type name */\r\n  name: string;\r\n\r\n  /** If this field supports AutoTranslate (new v15.x) */\r\n  public canAutoTranslate = false;\r\n\r\n  /** Adds Logic to FieldLogicManager */\r\n  static add(logic: LogicConstructor) {\r\n    const logicInstance = new logic();\r\n    FieldLogicManager.singleton().add(logicInstance);\r\n  }\r\n\r\n  /** Run this dummy method from component to make sure Logic files are not tree shaken */\r\n  static importMe(): void { }\r\n\r\n  /**\r\n   * Entity fields for empty items are prefilled on the backend with []\r\n   * so I can never know if entity field is brand new, or just emptied out by the user\r\n   * \r\n   * Note: 2dm 2023-08-31 moved from InputFieldHelpers; in future, each logic can override this\r\n   */\r\n  isValueEmpty(value: FieldValue, isCreateMode: boolean): boolean {\r\n    const l = this.log.fn('isValueEmpty', { value, isCreateMode });\r\n    const emptyEntityField = Array.isArray(value) && value.length === 0 && isCreateMode;\r\n    return l.r(value === undefined || emptyEntityField);\r\n  }\r\n\r\n  /** \r\n   * Update field settings - typically used on init and in every formula cycle\r\n   */\r\n  abstract update(updateSpecs: FieldLogicUpdate): FieldSettings;\r\n\r\n  /**\r\n   * Lookup advanced (external) configuration.\r\n   * These are usually stored in the eavConfig.settings.\r\n   * Needs defaults to merge for anything that is not defined in the external config.\r\n   * @param possibleGuid - guid of the external config, if empty, return defaults\r\n   * @param defaults - defaults to merge with external config\r\n   */\r\n  findAndMergeAdvanced<T>(tools: FieldLogicTools, possibleGuid: string, defaults: T): T {\r\n    if (!possibleGuid) return defaults;\r\n\r\n    const wysiwygConfig = tools.eavConfig.settings.Entities.find(e => e.Guid === possibleGuid);\r\n    if (!wysiwygConfig) return defaults;\r\n\r\n    const advanced = tools.reader.flatten(wysiwygConfig) as T;\r\n    return { ...defaults, ...advanced };\r\n  }\r\n}\r\n\r\nexport interface FieldLogicUpdate<T = FieldValue> {\r\n  /** The field name, to better debug */\r\n  fieldName: string;\r\n\r\n  /** Settings before logic update */\r\n  settings: FieldSettings;\r\n\r\n  /** Tools for doing various kind of work in the logic, which is singleton and may need context-specific tools */\r\n  tools: FieldLogicTools;\r\n\r\n  /** The field value which the settings-update sometimes needs to know, eg. to indicated selected option in a dropdown */\r\n  value?: T;\r\n}\r\n\r\ntype LogicConstructor = new (...args: any[]) => FieldLogicBase;", "import { InputTypeCatalog } from '../../../shared/fields/input-type-catalog';\r\nimport { FieldLogicBase, FieldLogicUpdate } from './field-logic-base';\r\nimport { FieldSettings } from '../../../../../../edit-types/src/FieldSettings';\r\n\r\nexport class UnknownLogic extends FieldLogicBase {\r\n  name = InputTypeCatalog.Unknown;\r\n  \r\n  constructor() { super({UnknownLogic}); }\r\n\r\n  canAutoTranslate = false;\r\n\r\n  update({ settings }: FieldLogicUpdate): FieldSettings {\r\n    return settings;\r\n  }\r\n}\r\n\r\n// Don't register here, the manager will register it as a fallback\r\n// FieldLogicBase.add(UnknownLogic);\r\n\r\n", "import { InputTypeCatalog } from '../../../shared/fields/input-type-catalog';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { FieldLogicBase } from './field-logic-base';\r\nimport { UnknownLogic } from './field-logic-unknown';\r\n\r\nconst logSpecs = {\r\n  all: false,\r\n  get: true,\r\n}\r\n\r\n// declare const window; //: EavWindow;\r\n\r\ndeclare global {\r\n  interface Window {\r\n    eavFieldLogicManager: FieldLogicManager;\r\n  }\r\n}\r\n\r\nexport class FieldLogicManager {\r\n  private logics: Record<string, FieldLogicBase> = {};\r\n\r\n  log = classLog({FieldLogicManager}, logSpecs);\r\n\r\n  private constructor() {\r\n    // add unknown as a fallback for all scenarios\r\n    this.add(new UnknownLogic());\r\n  }\r\n\r\n  static singleton(): FieldLogicManager {\r\n    return window.eavFieldLogicManager ??= new FieldLogicManager();\r\n  }\r\n\r\n  /** Add settings logic */\r\n  add(logic: FieldLogicBase): void {\r\n    this.logics[logic.name] = logic;\r\n  }\r\n\r\n  /** Get settings logic for input type */\r\n  get(inputTypeName: string): FieldLogicBase {\r\n    const l = this.log.fnIf('get', { inputTypeName });\r\n    const r = this.logics[inputTypeName] ?? null;\r\n    return l.r(r);\r\n  }\r\n\r\n  /** Get or use unknown - temporary solution v16.04 to prevent any scenario where there is none */\r\n  getOrUnknown(inputTypeName: string): FieldLogicBase {\r\n    return this.get(inputTypeName) ?? this.get(InputTypeCatalog.Unknown);\r\n  }\r\n}\r\n", "export const TranslationLinks = {\r\n  Translate: 'Translate',\r\n  DontTranslate: 'DontTranslate',\r\n  MissingDefaultLangValue: 'MissingDefaultLangValue',\r\n  LinkReadOnly: 'LinkReadOnly',\r\n  LinkReadWrite: 'LinkReadWrite',\r\n  LinkCopyFrom: 'LinkCopyFrom',\r\n} as const /* the as const ensures that the keys/values can be strictly checked */;\r\n", "import { Of } from '../../../../../../../../core';\r\nimport { TranslationLinks } from '../../../../localization/translation-link.constants';\r\n\r\nexport class TranslateMenuHelpers {\r\n\r\n  static getTranslationStateClass(linkType: Of<typeof TranslationLinks>) {\r\n    switch (linkType) {\r\n      case TranslationLinks.MissingDefaultLangValue:\r\n        return 'localization-missing-default-lang-value';\r\n      case TranslationLinks.Translate:\r\n      case TranslationLinks.LinkCopyFrom:\r\n        return 'localization-translate';\r\n      case TranslationLinks.DontTranslate:\r\n        return '';\r\n      case TranslationLinks.LinkReadOnly:\r\n        return 'localization-link-read-only';\r\n      case TranslationLinks.LinkReadWrite:\r\n        return 'localization-link-read-write';\r\n      default:\r\n        return '';\r\n    }\r\n  }\r\n\r\n  static calculateSharedInfoMessage(dimensions: string[], currentLanguage: string): string {\r\n    dimensions = TranslateMenuHelpers.calculateShortDimensions(dimensions, currentLanguage);\r\n    const result = TranslateMenuHelpers.calculateEditAndReadDimensions(dimensions);\r\n    const editableDimensions = result.editableDimensions;\r\n    const readOnlyDimensions = result.readOnlyDimensions;\r\n    let infoMessage = '';\r\n\r\n    const editableExist = editableDimensions.length > 0;\r\n    const readOnlyExist = readOnlyDimensions.length > 0;\r\n    if (editableExist && readOnlyExist) {\r\n      infoMessage = `${editableDimensions.join(', ')}, (${readOnlyDimensions.join(', ')})`;\r\n    } else if (editableExist) {\r\n      infoMessage = editableDimensions.join(', ');\r\n    } else if (readOnlyExist) {\r\n      infoMessage = `(${readOnlyDimensions.join(', ')})`;\r\n    }\r\n\r\n    return infoMessage;\r\n  }\r\n\r\n  private static calculateShortDimensions(dimensions: string[], currentLanguage: string): string[] {\r\n    const dimMap: Record<string, string[]> = {};\r\n    const langCode = currentLanguage.slice(0, currentLanguage.indexOf('-'));\r\n\r\n    dimMap[langCode] = [langCode];\r\n\r\n    dimensions.forEach(dimension => {\r\n      const shortDimension = dimension.slice(0, dimension.indexOf('-'));\r\n      const shortNoReadOnly = shortDimension.replace('~', '');\r\n\r\n      if (!dimMap[shortNoReadOnly]) {\r\n        dimMap[shortNoReadOnly] = [dimension];\r\n      } else {\r\n        dimMap[shortNoReadOnly].push(dimension);\r\n      }\r\n    });\r\n\r\n    dimensions = dimensions.map(dimension => {\r\n      const shortDimension = dimension.slice(0, dimension.indexOf('-'));\r\n      const shortNoReadOnly = shortDimension.replace('~', '');\r\n\r\n      if (dimMap[shortNoReadOnly].length > 1) {\r\n        return dimension;\r\n      } else {\r\n        return shortDimension;\r\n      }\r\n    });\r\n\r\n    return dimensions;\r\n  }\r\n\r\n  private static calculateEditAndReadDimensions(dimensions: string[]) {\r\n    return {\r\n      editableDimensions: [] as string[],\r\n      readOnlyDimensions: dimensions.map(d => d.replace('~', '')),\r\n    };\r\n  }\r\n}\r\n", "import { EmptyDefault } from 'projects/edit-types/src/FieldSettings-EmptyDefault';\r\nimport { FieldSettings } from '../../../../../edit-types/src/FieldSettings';\r\nimport { InputTypeHelpers } from '../../shared/fields/input-type-helpers';\r\nimport { classLog } from '../../shared/logging';\r\nimport { DebugFields } from '../edit-debug';\r\nimport { FieldLogicManager } from '../fields/logic/field-logic-manager';\r\nimport { TranslateMenuHelpers } from '../fields/wrappers/localization/translate-menu/translate-menu.helpers';\r\nimport { FormLanguage } from '../form/form-languages.model';\r\nimport { FieldReader } from '../localization/field-reader';\r\nimport { TranslationState, TranslationStateCore } from '../localization/translate-state.model';\r\nimport { TranslationLinks } from '../localization/translation-link.constants';\r\nimport { EavContentType, EavContentTypeAttribute, EavField } from '../shared/models/eav';\r\n\r\nconst logSpecs = {\r\n  all: false,\r\n  mergeGenericSettings: true,\r\n  getDefaultSettings: false,\r\n  fields: [...DebugFields, 'GroupPreview'],\r\n};\r\n\r\n/**\r\n * Helper to figure out / initialize field settings.\r\n * \r\n * It is, and must be, stateless.\r\n */\r\nexport class FieldsSettingsHelpers {\r\n\r\n  // TODO: conditionally create logger based on source name\r\n  log = classLog({FieldsSettingsHelpers}, logSpecs);\r\n\r\n  constructor(source: string) { }\r\n\r\n  /**\r\n   * Special feature in 18.02\r\n   * Generic settings are metadata which contain a JSON to basically set anything for which there is no Content-Type metadata.\r\n   * @param settings \r\n   * @param genericSettings \r\n   */\r\n  mergeGenericSettings(fieldName: string, settings: FieldSettings): FieldSettings {\r\n    const l = this.log.fnIfInList('mergeGenericSettings', 'fields', fieldName, { fieldName, settings });\r\n    const asWithGenericSettings = settings as unknown as { SettingsGeneric: string };\r\n    if (asWithGenericSettings.SettingsGeneric == null)\r\n      return l.r(settings, 'No generic settings');\r\n\r\n    try {\r\n      const genericSettings = JSON.parse(asWithGenericSettings.SettingsGeneric);\r\n      return l.r({ ...settings, ...genericSettings }, 'Merged generic settings');\r\n    } catch (error) {\r\n      console.error('mergeGenericSettings', error);\r\n      return l.r(settings, 'Error parsing generic settings');\r\n    }\r\n  }\r\n\r\n  getDefaultSettings(settings: FieldSettings): FieldSettings {\r\n    const defSettings = AllDeprecated.moveDeprecatedSettings({ ...settings }) as FieldSettings & EmptyDefault;\r\n    // update @All settings\r\n    defSettings.Name ??= '';\r\n    defSettings.Placeholder ??= '';\r\n    defSettings.Notes ??= '';\r\n    defSettings.Required ??= false;\r\n    defSettings.Disabled ??= false;\r\n    defSettings.DisableTranslation ??= false;\r\n    defSettings.Visible ??= true;\r\n    if (defSettings.DefaultCollapsed != null) {\r\n      defSettings.Collapsed = defSettings.DefaultCollapsed;\r\n      delete defSettings.DefaultCollapsed;\r\n    }\r\n    defSettings.Formulas ??= [];\r\n    let logic = FieldLogicManager.singleton().get(settings.InputType);\r\n    defSettings.DisableAutoTranslation ??= !logic?.canAutoTranslate;\r\n    return defSettings;\r\n  }\r\n\r\n  isLastInGroup(contentType: EavContentType, attribute: EavContentTypeAttribute): boolean {\r\n    const index = contentType.Attributes.indexOf(attribute);\r\n    if (contentType.Attributes[index + 1] == null) return true;\r\n\r\n    const indexOfFirstEmpty = contentType.Attributes.findIndex(a => InputTypeHelpers.isGroupStart(a.InputType));\r\n    if (index < indexOfFirstEmpty) return false;\r\n\r\n    if (InputTypeHelpers.isGroupEnd(attribute.InputType)) return true;\r\n\r\n    if (InputTypeHelpers.endsPreviousGroup(contentType.Attributes[index + 1].InputType)) return true;\r\n\r\n    return false;\r\n  }\r\n\r\n  getDisabledBecauseTranslations(\r\n    attributeValues: EavField<any>,\r\n    disableTranslation: boolean,\r\n    language: FormLanguage\r\n  ): boolean {\r\n    const fieldReader = new FieldReader(attributeValues, language);\r\n    if (language.current === language.primary) return false;\r\n    if (!fieldReader.hasPrimary) return true;\r\n    if (disableTranslation) return true;\r\n    if (fieldReader.hasEditableValues) return false;\r\n    if (fieldReader.hasCurrentReadonly) return true;\r\n    return true;\r\n  }\r\n\r\n  getTranslationState(attributeValues: EavField<any>, disableTranslation: boolean, language: FormLanguage, debug: boolean): TranslationState {\r\n    if (debug)\r\n      this.log.fn('getTranslationState', { attributeValues, disableTranslation, language });\r\n\r\n    let infoLabel: string;\r\n    let infoMessage: string;\r\n\r\n    const fieldReader = new FieldReader(attributeValues, language);\r\n\r\n    if (disableTranslation) {\r\n      infoLabel = 'LangMenu.InAllLanguages';\r\n      infoMessage = '';\r\n    } else if (!fieldReader.hasPrimary) {\r\n      infoLabel = 'LangMenu.MissingDefaultLangValue';\r\n      infoMessage = language.primary;\r\n    } else {\r\n      const hasEditable = fieldReader.hasEditableValues;\r\n      const hasReadonly = fieldReader.hasCurrentReadonly;\r\n\r\n      if (hasEditable || hasReadonly) {\r\n        const dimensions = fieldReader.current\r\n          .dimensions.map(dimension => dimension.dimCode)\r\n          .filter(dimension => !dimension.includes(language.current));\r\n\r\n        const isShared = dimensions.length > 0;\r\n        if (isShared) {\r\n          if (hasEditable)\r\n            infoLabel = 'LangMenu.In';\r\n          else if (hasReadonly)\r\n            infoLabel = 'LangMenu.From';\r\n\r\n          infoMessage = TranslateMenuHelpers.calculateSharedInfoMessage(dimensions, language.current);\r\n        } else {\r\n          infoLabel = '';\r\n          infoMessage = '';\r\n        }\r\n      } else {\r\n        infoLabel = 'LangMenu.UseDefault';\r\n        infoMessage = '';\r\n      }\r\n    }\r\n    const state = this.#getTranslationStateCore(attributeValues, disableTranslation, language);\r\n    const translationState: TranslationState = {\r\n      infoLabel,\r\n      infoMessage,\r\n      language: state.language,\r\n      linkType: state.linkType,\r\n    };\r\n    return translationState;\r\n  }\r\n\r\n  #getTranslationStateCore(\r\n    attributeValues: EavField<any>,\r\n    disableTranslation: boolean,\r\n    language: FormLanguage\r\n  ): TranslationStateCore {\r\n    const fieldReader = new FieldReader(attributeValues, language);\r\n    // Determine is control disabled or enabled and info message\r\n    if (!fieldReader.hasPrimary)\r\n      return { language: '', linkType: TranslationLinks.MissingDefaultLangValue };\r\n\r\n    if (disableTranslation)\r\n      return { language: '', linkType: TranslationLinks.DontTranslate };\r\n\r\n    if (fieldReader.hasEditableValues) {\r\n      const editableElements = fieldReader.current\r\n        .dimensions.filter(d => d.dimCode !== language.current);\r\n\r\n      return (editableElements.length > 0)\r\n        ? { language: editableElements[0].dimCode, linkType: TranslationLinks.LinkReadWrite }\r\n        : { language: '', linkType: TranslationLinks.Translate };\r\n    }\r\n\r\n    if (fieldReader.hasCurrentReadonly) {\r\n      const readOnlyElements = fieldReader.current\r\n        .dimensions.filter(d => d.dimCode !== language.current);\r\n\r\n      return { language: readOnlyElements[0].dimCode, linkType: TranslationLinks.LinkReadOnly, };\r\n    }\r\n\r\n    return { language: '', linkType: TranslationLinks.DontTranslate, };\r\n  }\r\n}\r\nclass AllDeprecated {\r\n  /** @deprecated */\r\n  VisibleInEditUI: boolean;\r\n  /** VisibleInEditUi is copied Visible and then deleted */\r\n  static moveDeprecatedSettings(settings: FieldSettings): FieldSettings {\r\n    var asDeprecated = settings as unknown as AllDeprecated;\r\n    if (asDeprecated.VisibleInEditUI == null) return settings;\r\n    settings.Visible = asDeprecated.VisibleInEditUI;\r\n    delete asDeprecated.VisibleInEditUI;\r\n    return settings;\r\n  }\r\n}\r\n", "import { Of } from '../../../../../../core';\r\nimport { FormulaFunction, FormulaVersions, runFormulaPrefix } from '../formula-definitions';\r\n\r\n/**\r\n * Contains methods for building formulas.\r\n */\r\n\r\nexport class FormulaSourceCodeHelper {\r\n  /**\r\n   * Used to clean formula text.\r\n   * @param formula Formula text to clean\r\n   * @returns Cleaned formula text\r\n   */\r\n  static #cleanFormula(formula: string): string {\r\n    if (!formula)\r\n      return formula;\r\n\r\n    // Clean and remove any leading single-line comments\r\n    let cleanFormula = formula.trim();\r\n    if (cleanFormula.startsWith('//'))\r\n      cleanFormula = cleanFormula.replace(/^\\/\\/.*\\n/gm, '').trim();\r\n\r\n    /*\r\n      Valid function string:\r\n      function NAME (...ARGS) { BODY }\r\n \r\n      Must build function string for these inputs:\r\n      v1 (...ARGS) { BODY }\r\n      function v1 (...ARGS) { BODY }\r\n      v2((...ARGS) => { BODY });\r\n \r\n      Everything else is ignored.\r\n      TODO: do this properly with regex if it's not too slow\r\n    */\r\n    if (cleanFormula.startsWith(FormulaVersions.V1))\r\n      return `${runFormulaPrefix}${cleanFormula}`;\r\n\r\n    if (cleanFormula.startsWith(`${runFormulaPrefix}${FormulaVersions.V1}`))\r\n      return cleanFormula;\r\n\r\n    if (cleanFormula.startsWith('v2(')) {\r\n      cleanFormula = cleanFormula.substring(3, cleanFormula.lastIndexOf('}') + 1);\r\n      cleanFormula = cleanFormula.replace('=>', '');\r\n      return `${runFormulaPrefix}v2 ${cleanFormula}`;\r\n    }\r\n\r\n    return cleanFormula;\r\n  }\r\n\r\n  /**\r\n   * Used to find formula version.\r\n   * @param formula Formula text\r\n   * @returns If formula is V1 or V2\r\n   */\r\n  static findFormulaVersion(formula: string): Of<typeof FormulaVersions> {\r\n    const cleanFormula = this.#cleanFormula(formula);\r\n    const versionPart = cleanFormula.substring(runFormulaPrefix.length, cleanFormula.indexOf('(')).trim();\r\n    const validVersions = Object.values(FormulaVersions);\r\n\r\n    return (validVersions).includes(versionPart as Of<typeof FormulaVersions>)\r\n      ? versionPart as Of<typeof FormulaVersions>\r\n      : undefined;\r\n  }\r\n\r\n  /**\r\n   * Used to build executable formula function from formula text.\r\n   * @param formula Formula text\r\n   * @returns Executable formula function\r\n   */\r\n  static buildFormulaFunction(formula: string): FormulaFunction {\r\n    const cleanFormula = this.#cleanFormula(formula);\r\n    const fn: FormulaFunction = new Function(`return ${cleanFormula}`)();\r\n    return fn;\r\n  }\r\n}\r\n", "import { Sxc } from '@2sic.com/2sxc-typings';\r\nimport { Injectable } from '@angular/core';\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { BehaviorSubject, combineLatest, filter, from, map, switchMap } from 'rxjs';\r\nimport { Of } from '../../../../../../core';\r\nimport { FieldSettings } from '../../../../../../edit-types/src/FieldSettings';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { DialogContextUser } from '../../../shared/models/dialog-context.models';\r\nimport { ServiceBase } from '../../../shared/services/service-base';\r\nimport { FormConfigService } from '../../form/form-config.service';\r\nimport { ContentTypeItemService } from '../../shared/content-types/content-type-item.service';\r\nimport { ContentTypeService } from '../../shared/content-types/content-type.service';\r\nimport { ContentTypeSettingsHelpers, EntityReader } from '../../shared/helpers';\r\nimport { InputTypeSpecs } from '../../shared/input-types/input-type-specs.model';\r\nimport { InputTypeService } from '../../shared/input-types/input-type.service';\r\nimport { EavItem } from '../../shared/models/eav/eav-item';\r\nimport { LoggingService, LogSeverities } from '../../shared/services/logging.service';\r\nimport { FieldsSettingsHelpers } from '../../state/field-settings.helper';\r\nimport { ItemService } from '../../state/item.service';\r\nimport { FormulaFunction } from '../formula-definitions';\r\nimport { FormulaPromise } from '../promise/formula-promise-result.model';\r\nimport { FieldValueOrResultRaw, FormulaIdentifier } from '../results/formula-results.models';\r\nimport { FormulaV1CtxApp, FormulaV1CtxTargetEntity, FormulaV1CtxUser } from '../run/formula-run-context.model';\r\nimport { FormulaDefaultTargets, FormulaSpecialPickerTargets, FormulaTargets, SettingsFormulaPrefix } from '../targets/formula-targets';\r\nimport { FormulaCacheItem, FormulaCacheItemConstants } from './formula-cache.model';\r\nimport { FormulaCacheService } from './formula-cache.service';\r\nimport { FormulaSourceCodeHelper } from './source-code-helper';\r\n\r\nconst logSpecs = {\r\n  all: false,\r\n  buildFormulaCache: false,\r\n  updateFormulaFromEditor: false,\r\n  createPromisedParts: false,\r\n  getSharedParts: false,\r\n};\r\n\r\n/**\r\n * Service just to cache formulas for execution and use in the designer.\r\n */\r\n@Injectable()\r\nexport class FormulaCacheBuilder extends ServiceBase {\r\n  log = classLog({FormulaCacheBuilder}, logSpecs);\r\n  constructor(\r\n    private formConfig: FormConfigService,\r\n    private itemService: ItemService,\r\n    private contentTypeService: ContentTypeService,\r\n    private contentTypeItemService: ContentTypeItemService,\r\n    private loggingService: LoggingService,\r\n    private translate: TranslateService,\r\n    private inputTypes: InputTypeService,\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Used for building the initial formula cache.\r\n   * @returns\r\n   */\r\n  public buildFormulaCache(cacheSvc: FormulaCacheService): FormulaCacheItem[] {\r\n    const l = this.log.fnIf('buildFormulaCache');\r\n    const formulaCache: FormulaCacheItem[] = [];\r\n    const language = this.formConfig.language();\r\n    const reader = new EntityReader(language);\r\n\r\n    const fss = new FieldsSettingsHelpers(this.log.name);\r\n\r\n    for (const entityGuid of this.formConfig.config.itemGuids) {\r\n      const item = this.itemService.get(entityGuid);\r\n\r\n      const shared = this.#getSharedParts(entityGuid, item);\r\n\r\n      const contentType = this.contentTypeService.getContentTypeOfItem(item);\r\n      for (const attribute of contentType.Attributes) {\r\n        // Get field settings\r\n        const settings = fss.getDefaultSettings(reader.flatten<FieldSettings>(attribute.Metadata));\r\n\r\n        // get input type specs\r\n        const inputType = this.inputTypes.getSpecs(attribute);\r\n\r\n        // Get all formulas for the field\r\n        const formulaEntities = this.contentTypeItemService\r\n          .getMany(settings.Formulas)\r\n          .filter(f => reader.getBestValue<boolean>(f.Attributes.Enabled));\r\n\r\n        for (const fEntity of formulaEntities) {\r\n          const sourceCode = reader.getBestValue<string>(fEntity.Attributes.Formula);\r\n          if (!sourceCode) \r\n            continue;\r\n\r\n          const target: Of<typeof FormulaTargets> = reader.getBestValue<string>(fEntity.Attributes.Target);\r\n\r\n          // create cleaned formula function, or if this fails, add info to log & results\r\n          let formulaFunction: FormulaFunction;\r\n          try {\r\n            formulaFunction = FormulaSourceCodeHelper.buildFormulaFunction(sourceCode);\r\n          } catch (error) {\r\n            cacheSvc.cacheResults({ entityGuid, fieldName: attribute.Name, target } satisfies FormulaIdentifier, undefined, true, false);\r\n            const itemTitle = ContentTypeSettingsHelpers.getTitle(contentType, language);\r\n            this.loggingService.addLog(LogSeverities.Error, `Error building formula for Entity: \"${itemTitle}\", Field: \"${attribute.Name}\", Target: \"${target}\"`, error);\r\n            this.loggingService.showMessage(this.translate.instant('Errors.FormulaConfiguration'), 2000);\r\n          }\r\n\r\n          const formulaCacheItem: FormulaCacheItem = {\r\n            cache: {},\r\n            entityGuid,\r\n            fieldName: attribute.Name,\r\n            fn: formulaFunction?.bind({}),\r\n            isDraft: formulaFunction == null,\r\n            sourceCode,\r\n            sourceCodeSaved: sourceCode,\r\n            sourceCodeGuid: fEntity.Guid,\r\n            sourceCodeId: fEntity.Id,\r\n            target,\r\n            ...this.#inputTypeSpecsForCacheItem(target, inputType),\r\n            version: FormulaSourceCodeHelper.findFormulaVersion(sourceCode),\r\n            ...shared,\r\n            stop: false,\r\n            sleep: false,\r\n            fieldIsSpecialPicker: FormulaSpecialPickerTargets.includes(target),\r\n            ...this.#createPromisedParts(),\r\n            ...this.#targetInfoForCacheItem(target),\r\n          };\r\n\r\n          formulaCache.push(formulaCacheItem);\r\n        }\r\n      }\r\n    }\r\n\r\n    return l.r(formulaCache);\r\n  }\r\n\r\n\r\n  #inputTypeSpecsForCacheItem(target: Of<typeof FormulaTargets>, inputType: InputTypeSpecs): Pick<FormulaCacheItem, 'inputType' | 'isNewPicker' | 'disabled' | 'disabledReason'> {\r\n\r\n    // Disable picker checks WIP\r\n    /* if (!inputType.isNewPicker) */\r\n    return { inputType: inputType, isNewPicker: inputType.isNewPicker, disabled: false, disabledReason: '' };\r\n    // return [FormulaDefaultTargets.Value /*, FormulaNewPickerTargets.Options */].includes(target)\r\n    //   ? { isNewPicker: true, disabled: true, disabledReason: 'New picker is not supported in formulas yet' }\r\n    //   : { isNewPicker: true, disabled: false, disabledReason: '' };\r\n  }\r\n\r\n  #targetInfoForCacheItem(target: Of<typeof FormulaTargets>): Pick<FormulaCacheItem, 'isSetting' | 'settingName' | 'isValue' | 'isValidation'> {\r\n    return target.startsWith(SettingsFormulaPrefix)\r\n      ? { isSetting: true, settingName: target.substring(SettingsFormulaPrefix.length), isValue: false, isValidation: false }\r\n      : { isSetting: false, settingName: '', isValue: target === FormulaDefaultTargets.Value, isValidation: target === FormulaDefaultTargets.Validation };\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Used for building shared parts of formula cache item.\r\n   * @param item\r\n   * @param entityGuid\r\n   * @returns\r\n   */\r\n  #getSharedParts(entityGuid: string, item: EavItem = null): FormulaCacheItemConstants {\r\n    this.log.fnIf('getSharedParts', { item, entityGuid });\r\n\r\n    if (this.#sharedPartsCache[entityGuid])\r\n      return this.#sharedPartsCache[entityGuid];\r\n\r\n    item = item ?? this.itemService.get(entityGuid);\r\n    const entity = item.Entity;\r\n    const mdFor = entity.For;\r\n    const targetEntity: FormulaV1CtxTargetEntity = {\r\n      guid: entity.Guid,\r\n      id: entity.Id,\r\n      type: {\r\n        guid: entity.Type.Id,\r\n        name: entity.Type.Name,\r\n      },\r\n      // New v15.04\r\n      for: {\r\n        targetType: mdFor?.TargetType ?? 0,\r\n        guid: mdFor?.Guid,\r\n        number: mdFor?.Number,\r\n        string: mdFor?.String,\r\n      },\r\n      // new v20\r\n      isNew: entity.Id === 0,\r\n      isCopy: this.formConfig.config.isCopy,\r\n    };\r\n    const formConfig = this.formConfig.config;\r\n    const user = formConfig.dialogContext.User ?? {} as Partial<DialogContextUser>;\r\n    const shared = {\r\n      targetEntity,\r\n      user: {\r\n        email: user.Email,\r\n        guid: user.Guid,\r\n        id: user.Id,\r\n        isAnonymous: user.IsAnonymous,\r\n        isSiteAdmin: user.IsSiteAdmin,\r\n        isContentEditor: user.isContentEditor,\r\n        isContentAdmin: user.IsContentAdmin,\r\n        isSystemAdmin: user.IsSystemAdmin,\r\n        name: user.Name,\r\n        username: user.Username,\r\n        roles: user.roles,\r\n      } satisfies FormulaV1CtxUser,\r\n      app: {\r\n        appId: formConfig.appId,\r\n        zoneId: formConfig.zoneId,\r\n        isGlobal: formConfig.dialogContext.App.IsGlobalApp,\r\n        isSite: formConfig.dialogContext.App.IsSiteApp,\r\n        isContent: formConfig.dialogContext.App.IsContentApp,\r\n        getSetting: (key: string) => undefined,\r\n      } satisfies FormulaV1CtxApp,\r\n      sxc: window.$2sxc({\r\n        zoneId: formConfig.zoneId,\r\n        appId: formConfig.appId,\r\n        pageId: formConfig.tabId,\r\n        moduleId: formConfig.moduleId,\r\n        _noContextInHttpHeaders: true,  // disable pageid etc. headers in http headers, because it would make debugging very hard\r\n        _autoAppIdsInUrl: true,         // auto-add appid and zoneid to url so formula developer can see what's happening\r\n      } as any) satisfies Sxc,\r\n    } satisfies FormulaCacheItemConstants;\r\n    this.#sharedPartsCache[entityGuid] = shared;\r\n    return shared;\r\n  }\r\n  #sharedPartsCache: Record<string, FormulaCacheItemConstants> = {};\r\n\r\n\r\n  /**\r\n   * Used for pacing promises$ and callback$ triggers. Callback$ triggers for the first time when the last promise is resolved.\r\n   * @returns\r\n   */\r\n  #createPromisedParts() {\r\n    this.log.fnIf('createPromisedParts');\r\n    const promises$ = new BehaviorSubject<FormulaPromise>(null);\r\n    const updateCallback$ = new BehaviorSubject<(result: FieldValueOrResultRaw) => void>(null);\r\n    const promiseSpecs = promises$.pipe(\r\n      filter(x => !!x),\r\n      switchMap(set => from(set.promise).pipe(map(result => ({ set, result })))),\r\n    );\r\n    // This combineLatest triggers the callback for the first time when the last promise is resolved\r\n    this.subscriptions.add(combineLatest([promiseSpecs, updateCallback$.pipe(filter(x => !!x))])\r\n      .subscribe(\r\n        ([promise, callback]) => {\r\n          promise.set.completed = true;\r\n          promise.set.sleep = false;\r\n          return callback(promise.result);\r\n        },\r\n      ));\r\n\r\n    return { promises$, updateCallback$ };\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Used for updating formula from editor.\r\n   * @param entityGuid\r\n   * @param fieldName\r\n   * @param target\r\n   * @param sourceCode\r\n   * @param run\r\n   */\r\n  public updateFormulaFromEditor(cacheSvc: FormulaCacheService, id: FormulaIdentifier, sourceCode: string, run: boolean) {\r\n    this.log.fnIf('updateFormulaFromEditor', { id, sourceCode, run });\r\n    // important: the designer contains too much info, so we need to extract the essentials\r\n    // to not have it in the cache - which would trigger loads of changes to that signal later on.\r\n    let formulaFunction: FormulaFunction;\r\n\r\n    // If we should also run it, push it to the formulas cache so it will be executed\r\n    if (run)\r\n      try {\r\n        formulaFunction = FormulaSourceCodeHelper.buildFormulaFunction(sourceCode);\r\n      } catch (error) {\r\n        cacheSvc.cacheResults(id, /* value: */ undefined, /* isError: */ true, /* isPromise */ false);\r\n        const item = this.itemService.get(id.entityGuid);\r\n        const contentType = this.contentTypeService.getContentTypeOfItem(item);\r\n        const language = this.formConfig.language();\r\n        const itemTitle = ContentTypeSettingsHelpers.getTitle(contentType, language);\r\n        const errorLabel = `Error building formula for Entity: \"${itemTitle}\", Field: \"${id.fieldName}\", Target: \"${id.target}\"`;\r\n        this.loggingService.addLog(LogSeverities.Error, errorLabel, error);\r\n\r\n        console.error(errorLabel, error);\r\n      }\r\n\r\n    // find input type\r\n    const item = this.itemService.get(id.entityGuid);\r\n    const attribute = this.contentTypeService.getAttributeOfItem(item, id.fieldName);\r\n    const inputType = this.inputTypes.getSpecs(attribute);\r\n\r\n    // Find original in case we had it already (as we would then update it)\r\n    const { list, index, value } = cacheSvc.formulaListIndexAndOriginal(id);\r\n    const formula = value ?? {} as FormulaCacheItem;\r\n\r\n    // Get shared calculated properties, which we need in case the old-formula doesn't have them yet\r\n    const shared = this.#getSharedParts(id.entityGuid);\r\n\r\n    const streams = (formula.promises$ && formula.updateCallback$)\r\n      ? { promises$: value.promises$, updateCallback$: value.updateCallback$ }\r\n      : this.#createPromisedParts();\r\n\r\n    const newFormulaItem: FormulaCacheItem = {\r\n      ...id,\r\n      cache: formula.cache ?? {},\r\n      fn: formulaFunction?.bind({}),\r\n      isDraft: run ? formulaFunction == null : true,\r\n      sourceCode,\r\n      sourceCodeSaved: formula.sourceCodeSaved,\r\n      sourceCodeGuid: formula.sourceCodeGuid,\r\n      sourceCodeId: formula.sourceCodeId,\r\n      version: FormulaSourceCodeHelper.findFormulaVersion(sourceCode),\r\n      ...this.#inputTypeSpecsForCacheItem(id.target, inputType),\r\n      ...shared,\r\n      stop: false,\r\n      sleep: false,\r\n      fieldIsSpecialPicker: FormulaSpecialPickerTargets.includes(id.target),\r\n      ...streams,\r\n      ...this.#targetInfoForCacheItem(id.target),\r\n    };\r\n\r\n    const newCache = index >= 0\r\n      ? [...list.slice(0, index), newFormulaItem, ...list.slice(index + 1)]\r\n      : [newFormulaItem, ...list];\r\n    return newCache;\r\n  }\r\n\r\n}", "import { Injectable, untracked } from '@angular/core';\r\nimport { Of, transient } from '../../../../../../core';\r\nimport { FieldValue } from '../../../../../../edit-types/src/FieldValue';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { signalObj } from '../../../shared/signals/signal.utilities';\r\nimport { DebugFields } from '../../edit-debug';\r\nimport { FormulaIdentifier } from '../results/formula-results.models';\r\nimport { FormulaDefaultTargetValues, FormulaNewPickerTargetValues, FormulaOptionalTargetValues, FormulaTargets } from '../targets/formula-targets';\r\nimport { FormulaCacheBuilder } from './formula-cache.builder';\r\nimport { FormulaCacheItem, FormulaResultCacheItem } from './formula-cache.model';\r\n\r\nconst logSpecs = {\r\n  all: true,\r\n  getActive: true,\r\n  fields: [...DebugFields],\r\n};\r\n\r\n/**\r\n * Service just to cache formulas for execution and use in the designer.\r\n */\r\n@Injectable()\r\nexport class FormulaCacheService {\r\n\r\n  log = classLog({FormulaCacheService}, logSpecs);\r\n\r\n  #cacheBuilder = transient(FormulaCacheBuilder);\r\n\r\n  constructor() { }\r\n\r\n  /** All the formulas with various additional info to enable execution and editing */\r\n  public formulas = signalObj<FormulaCacheItem[]>('formulas', []);\r\n\r\n  /** All the formula results */\r\n  #results = signalObj<FormulaResultCacheItem[]>('formula-results', []);\r\n\r\n  init() {\r\n    const formulaCache = this.#cacheBuilder.buildFormulaCache(this);\r\n    this.formulas.set(formulaCache);\r\n  }\r\n\r\n  //#region Formulas Get / Find\r\n\r\n  /**\r\n   * Used for returning formulas filtered by optional entity, field or target.\r\n   * @param entityGuid Optional entity guid\r\n   * @param fieldName Optional field\r\n   * @param target Optional target\r\n   * @param allowDraft\r\n   * @returns Filtered formula array\r\n   */\r\n  #findFormulas(entityGuid?: string, fieldName?: string, target?: Of<typeof FormulaTargets>[], allowDraft?: boolean): FormulaCacheItem[] {\r\n    return this.formulas().filter(f =>\r\n        (entityGuid ? f.entityGuid === entityGuid : true)\r\n        && (fieldName ? f.fieldName === fieldName : true)\r\n        && (target ? target?.find(target => f.target == target) : true)\r\n        && (allowDraft ? true : !f.isDraft)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Find formulas of the current field which are still running.\r\n   * Uses the designerService as that can modify the behavior while developing a formula.\r\n   */\r\n  public getActive(entityGuid: string, name: string, forNewPicker: boolean): FormulaCacheItem[] {\r\n    const l = this.log.fnIfInList('getActive', 'fields', name, () => ({ name, forNewPicker, formulas: this.formulas() }));\r\n    const targets = FormulaDefaultTargetValues\r\n      .concat(forNewPicker ? FormulaNewPickerTargetValues : FormulaOptionalTargetValues);\r\n    \r\n    const all = this.#findFormulas(entityGuid, name, targets, /* allowDraft: */ false);\r\n\r\n    const unstopped = all.filter(f => !f.stop);\r\n\r\n    return l.r(unstopped, `all: ${all.length}, unstopped: ${unstopped.length}`);\r\n  }\r\n\r\n\r\n\r\n  public formulaListIndexAndOriginal(fOrDs: FormulaIdentifier) {\r\n    const list = this.formulas();\r\n    const index = list.findIndex(f => f.entityGuid === fOrDs.entityGuid && f.fieldName === fOrDs.fieldName && f.target === fOrDs.target);\r\n    const value = list[index];\r\n    return { list, index, value };\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Formulas CRUD\r\n\r\n  /**\r\n   * Used for saving updated formula from editor.\r\n   */\r\n  public updateSaved(formulaItem: FormulaCacheItem, sourceGuid: string, sourceId: number): void {\r\n    const { list, index, value } = this.formulaListIndexAndOriginal(formulaItem);\r\n    if (value == null)\r\n      return;\r\n\r\n    const updated: FormulaCacheItem = {\r\n      ...value,\r\n      sourceCodeSaved: formulaItem.sourceCode,\r\n      sourceCodeGuid: sourceGuid,\r\n      sourceCodeId: sourceId,\r\n    };\r\n\r\n    const newCache = [...list.slice(0, index), updated, ...list.slice(index + 1)];\r\n    this.formulas.set(newCache);\r\n  }\r\n\r\n  /**\r\n   * Used for updating formula from editor.\r\n   */\r\n  public updateFormulaFromEditor(id: FormulaIdentifier, formula: string, run: boolean): void {\r\n    const newCache = this.#cacheBuilder.updateFormulaFromEditor(this, id, formula, run);\r\n    this.formulas.set(newCache);\r\n  }\r\n\r\n  /**\r\n   * Used for deleting formula.\r\n   */\r\n  public delete(id: FormulaIdentifier): void {\r\n    const { list, index } = this.formulaListIndexAndOriginal(id);\r\n    if (index < 0) return;\r\n    const newCache = [...list.slice(0, index), ...list.slice(index + 1)];\r\n    this.formulas.set(newCache);\r\n  }\r\n\r\n  /**\r\n   * Used for resetting formula.\r\n   */\r\n  public resetFormula(id: FormulaIdentifier): void {\r\n    this.#deleteResult(id);\r\n\r\n    // If we reset to saved code, then do that, otherwise delete/flush\r\n    const sourceCodeSaved = this.formulaListIndexAndOriginal(id).value?.sourceCodeSaved;\r\n    if (sourceCodeSaved != null)\r\n      this.updateFormulaFromEditor(id, sourceCodeSaved, true);\r\n    else \r\n      this.delete(id);\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region Get Results & Delete\r\n\r\n  /**\r\n   * Cache the results of a formula - mainly for showing formula result in editor.\r\n   * @param entityGuid\r\n   * @param fieldName\r\n   * @param target\r\n   * @param value\r\n   * @param isError\r\n   * @param isOnlyPromise\r\n   */\r\n  public cacheResults(formulaItem: FormulaIdentifier, value: FieldValue, isError: boolean, isOnlyPromise: boolean): void {\r\n    const newResult: FormulaResultCacheItem = {\r\n      entityGuid: formulaItem.entityGuid,\r\n      fieldName: formulaItem.fieldName,\r\n      target: formulaItem.target,\r\n      value,\r\n      isError,\r\n      isOnlyPromise,\r\n    };\r\n    const l = this.log.fn('cacheResults', { newResult });\r\n\r\n    // We should not track reading the list during formula execution\r\n    // since we don't depend on it!\r\n    untracked(() => {\r\n      const { list, index } = this.resultListIndexAndOriginal(formulaItem);\r\n      const newResults = index >= 0\r\n        ? [...list.slice(0, index), newResult, ...list.slice(index + 1)]\r\n        : [newResult, ...list];\r\n\r\n      // side effect within props calculations\r\n        l.a('set results', { list, index, newResults});\r\n        this.#results.set(newResults);\r\n    });\r\n    l.end('ok');\r\n  }\r\n\r\n  public resultListIndexAndOriginal(id: FormulaIdentifier) {\r\n    const list = this.#results();\r\n    const index = list.findIndex(r => r.entityGuid === id.entityGuid && r.fieldName === id.fieldName && r.target === id.target);\r\n    const value = list[index];\r\n    return { list, index, value };\r\n  }\r\n\r\n  /**\r\n   * Delete Results from cache.\r\n   */\r\n  #deleteResult(id: FormulaIdentifier): void {\r\n    const { list, index } = this.resultListIndexAndOriginal(id);\r\n    if (index < 0) return;\r\n    const newResults = [...list.slice(0, index), ...list.slice(index + 1)];\r\n    this.#results.set(newResults);\r\n  }  \r\n\r\n  //#endregion\r\n}\r\n", "import { Injectable } from '@angular/core';\r\nimport { Of } from '../../../../../../core';\r\nimport { InputTypeHelpers } from '../../../shared/fields/input-type-helpers';\r\nimport { TargetOption } from '../../dialog/footer/formula-designer/formula-designer.models';\r\nimport { ContentTypeService } from '../../shared/content-types/content-type.service';\r\nimport { ItemService } from '../../state/item.service';\r\nimport { FormulaCacheItem } from '../cache/formula-cache.model';\r\nimport { FormulaIdentifier } from '../results/formula-results.models';\r\nimport { FormulaDefaultTargets, FormulaNewPickerTargets, FormulaOptionalTargets, FormulaTargets } from './formula-targets';\r\n\r\n/**\r\n * Small helper service to get the target options for the formula designer.\r\n * \r\n * The purpose is to figure out what targets are possible for each field (eg. Settings.Name, etc.)\r\n * and to ensure that the information (eg. hasFormula) is correct.\r\n */\r\n@Injectable()\r\nexport class FormulaTargetsService {\r\n\r\n  constructor(\r\n    private itemService: ItemService,\r\n    private contentTypeService: ContentTypeService,\r\n  ) { }\r\n\r\n  getTargetOptions(id: FormulaIdentifier, formulas: FormulaCacheItem[]): TargetOption[] {\r\n    // Create a list of formula targets for the selected field - eg. Value, Tooltip, ListItem.Label, ListItem.Tooltip etc.\r\n    const targetOptions: TargetOption[] = [];\r\n    if (id.entityGuid == null || id.fieldName == null)\r\n      return targetOptions;\r\n\r\n    const fieldFormulas = formulas.filter(f => f.entityGuid === id.entityGuid && f.fieldName === id.fieldName);\r\n\r\n    // default targets\r\n    for (const target of Object.values(FormulaDefaultTargets)) {\r\n      const targetOption: TargetOption = {\r\n        hasFormula: fieldFormulas.some(f => f.target === target),\r\n        label: target.substring(target.lastIndexOf('.') + 1),\r\n        target,\r\n      };\r\n      targetOptions.push(targetOption);\r\n    }\r\n\r\n    // optional targets\r\n    const item = this.itemService.get(id.entityGuid);\r\n    const attribute = this.contentTypeService.getAttributeOfItem(item, id.fieldName);\r\n    const inputType = attribute.InputType;\r\n    if (InputTypeHelpers.isGroupStart(inputType)) {\r\n      for (const target of [FormulaOptionalTargets.Collapsed]) {\r\n        const targetOption: TargetOption = {\r\n          hasFormula: fieldFormulas.some(f => f.target === target),\r\n          label: target.substring(target.lastIndexOf('.') + 1),\r\n          target: target as Of<typeof FormulaTargets>,\r\n        };\r\n        targetOptions.push(targetOption);\r\n      }\r\n    }\r\n    if (InputTypeHelpers.isOldValuePicker(inputType)) {\r\n      for (const target of [FormulaOptionalTargets.DropdownValues]) {\r\n        const targetOption: TargetOption = {\r\n          hasFormula: fieldFormulas.some(f => f.target === target),\r\n          label: target.substring(target.lastIndexOf('.') + 1),\r\n          target: target as Of<typeof FormulaTargets>,\r\n        };\r\n        targetOptions.push(targetOption);\r\n      }\r\n    }\r\n\r\n    // TODO: HERE\r\n    if (InputTypeHelpers.isNewPicker(inputType)) {\r\n      for (const target of Object.values(FormulaNewPickerTargets)) {\r\n        const targetOption: TargetOption = {\r\n          hasFormula: fieldFormulas.some(f => f.target === target),\r\n          label: \"Picker \" + target.substring(target.lastIndexOf('.') + 1),\r\n          target: target as Of<typeof FormulaTargets>,\r\n        };\r\n        targetOptions.push(targetOption);\r\n      }\r\n    }\r\n\r\n    /* TODO: for picker types WIP\r\n      add formulas -> Field.ListItem.Label\r\n                      Field.ListItem.Tooltip\r\n                      Field.ListItem.Information\r\n                      Field.ListItem.HelpLink\r\n                      Field.ListItem.Disabled\r\n\r\n      Template for all new type formulas\r\n      v2((data, context, item) => {\r\n        return data.value;\r\n      });\r\n\r\n      old template for all of the rest\r\n\r\n      run formulas upon dropdowning the picker, upon each opening\r\n    */\r\n\r\n    // targets for formulas\r\n    for (const formula of fieldFormulas) {\r\n      const formulaExists = targetOptions.some(t => t.target === formula.target);\r\n      if (formulaExists) \r\n        continue;\r\n\r\n      const targetOption: TargetOption = {\r\n        hasFormula: true,\r\n        label: formula.target.substring(formula.target.lastIndexOf('.') + 1),\r\n        target: formula.target,\r\n      };\r\n      targetOptions.push(targetOption);\r\n    }\r\n\r\n    // currently selected target\r\n    const selectedExists = targetOptions.some(t => t.target === id.target);\r\n    if (!selectedExists) {\r\n      const targetOption: TargetOption = {\r\n        hasFormula: fieldFormulas.some(f => f.target === id.target),\r\n        label: id.target.substring(id.target.lastIndexOf('.') + 1),\r\n        target: id.target,\r\n      };\r\n      targetOptions.push(targetOption);\r\n    }\r\n    return targetOptions;    \r\n  }\r\n\r\n}", "import { untracked } from '@angular/core';\r\nimport { FormulaCacheItem } from './cache/formula-cache.model';\r\nimport { FormulaDesignerService } from './designer/formula-designer.service';\r\nimport { FormulaPropsV1 } from './formula-run-one-helpers.factory';\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { LoggingService, LogSeverities } from '../shared/services/logging.service';\r\nimport { FieldValue } from '../../../../../edit-types/src/FieldValue';\r\n\r\nexport class FormulaDeveloperHelper {\r\n\r\n  constructor(\r\n    private designerSvc: FormulaDesignerService,\r\n    private translate: TranslateService,\r\n    private logSvc: LoggingService,\r\n    private formula: FormulaCacheItem,\r\n    private ctTitle: string,\r\n    private formulaProps: FormulaPropsV1,\r\n  ) {\r\n    this.isOpen = this.#isDesignerOpen(formula);\r\n  }\r\n  \r\n  /** The designer is currently open, so we should show more information to the developer */\r\n  public isOpen: boolean = false;\r\n\r\n  showStart() {\r\n    if (!this.isOpen) return;\r\n    const f = this.formula;\r\n    console.log(`Running formula${f.version?.toLocaleUpperCase()} for Entity: \"${this.ctTitle}\", Field: \"${f.fieldName}\", Target: \"${f.target}\", arguments:`, this.formulaProps);\r\n  }\r\n\r\n  showResult(value: FieldValue, isError: boolean, isOnlyPromise: boolean) {\r\n    this.designerSvc.cache.cacheResults(this.formula, value, false, false);\r\n    if (this.isOpen)\r\n      console.log('Formula result:', value);\r\n  }\r\n\r\n  showError(error: unknown) {\r\n    const formula = this.formula;\r\n    const errorLabel = `Error in formula calculation for Entity: \"${this.ctTitle}\", Field: \"${formula.fieldName}\", Target: \"${formula.target}\"`;\r\n    this.designerSvc.cache.cacheResults(formula, undefined, true, false);\r\n    this.logSvc.addLog(LogSeverities.Error, errorLabel, error);\r\n    if (this.isOpen)\r\n      console.error(errorLabel, error);\r\n    else\r\n      this.logSvc.showMessage(this.translate.instant('Errors.FormulaCalculation'), 2000);\r\n  }\r\n\r\n  /**\r\n   * Used for checking if the currently running formula is open in designer.\r\n   * @param f\r\n   * @returns True if formula is open in designer, otherwise false\r\n   */\r\n  #isDesignerOpen(f: FormulaCacheItem): boolean {\r\n    return untracked(() => {\r\n      const ds = this.designerSvc.designerState();\r\n      const isOpenInDesigner = ds.isOpen && ds.entityGuid === f.entityGuid && ds.fieldName === f.fieldName && ds.target === f.target;\r\n      return isOpenInDesigner;\r\n    });\r\n  }\r\n}", "import { FieldValue } from '../../../../../../edit-types/src/FieldValue';\r\nimport { DataTypeCatalog } from \"../../../shared/fields/data-type-catalog\";\r\nimport { InputTypeCatalog } from \"../../../shared/fields/input-type-catalog\";\r\nimport { classLog } from '../../../shared/logging';\r\nimport { DebugFields } from '../../edit-debug';\r\nimport { StateUiMapperBase } from '../../fields/picker/adapters/state-ui-mapper-base';\r\nimport { PickerItem } from '../../fields/picker/models/picker-item.model';\r\nimport { InputTypeSpecs } from '../../shared/input-types/input-type-specs.model';\r\nimport { EavContentType } from '../../shared/models/eav/eav-content-type';\r\nimport { FieldFormulasResultRaw, FieldValueOrResultRaw } from \"./formula-results.models\";\r\n\r\nconst logSpecs = {\r\n  all: false,\r\n  v1: false,\r\n  v2: false,\r\n  allValues: true,\r\n  oneValue: true,\r\n  fields: [...DebugFields],\r\n}\r\n\r\n/**\r\n * Contains methods for correcting formula results.\r\n */\r\nexport class FormulaValueCorrections {\r\n\r\n  log = classLog({FormulaValueCorrections}, logSpecs);\r\n\r\n  constructor(\r\n    private contentType: EavContentType,\r\n    // private contentTypeSvc: ContentTypeService,\r\n    private entityGuid: string,\r\n    private fieldName: string,\r\n    private isValue: boolean,\r\n    private inputType: InputTypeSpecs,\r\n    private isOpen: boolean,\r\n    private valueMapper?: StateUiMapperBase,\r\n  ) { }\r\n\r\n\r\n  v1(v1Result: FieldValueOrResultRaw): { ok: boolean, v1Result: FieldFormulasResultRaw } {\r\n    const isArray = v1Result && Array.isArray(v1Result) && v1Result.every(r => typeof r === 'string');\r\n    const resultIsPure = ['string', 'number', 'boolean'].includes(typeof v1Result) || v1Result instanceof Date || isArray || !v1Result;\r\n    if (!resultIsPure)\r\n      return { ok: false, v1Result: this.toFormulaResult(undefined) };\r\n\r\n    const v1Value = this.isValue\r\n      ? this.#oneValue(v1Result as FieldValue)\r\n      : v1Result as FieldValue;\r\n    return { ok: true, v1Result: this.toFormulaResult(v1Value) };\r\n  }\r\n\r\n  v2(result: FieldValueOrResultRaw): FieldFormulasResultRaw {\r\n    const raw = this.allValues(result);\r\n    return { ...raw, openInDesigner: this.isOpen };\r\n  }\r\n\r\n  /**\r\n   * This method is used to support duck typing in the formula result and from it to fill FormulaResultRaw object with corrected values.\r\n   * @param target Formula target\r\n   * @param result Formula result\r\n   * @param inputType InputType is needed to check if the result is a date which needs to be corrected\r\n   * @returns Strongly typed FormulaResultRaw object\r\n   */\r\n  allValues(result: FieldValueOrResultRaw): FieldFormulasResultRaw {\r\n    const l = this.log.fnIfInList('allValues', 'fields', this.fieldName, { result });\r\n\r\n    // if (l.enabled)\r\n    //   debugger;\r\n\r\n    // 2024-09-10 21:15 2dm changed this, as I believe all cases have a clear stop-value\r\n    // const stop = (result as FormulaResultRaw)?.stop ?? null;\r\n    const defaults: Partial<FieldFormulasResultRaw> = { value: undefined, fields: [], stop: null, sleep: null };\r\n    if (result == null)\r\n      return l.r({ ...defaults, value: result as FieldValue}, 'null/empty');\r\n    \r\n    const targetIsValue = this.isValue;\r\n\r\n    // Show warning if array - new v18 newPicker\r\n    if (Array.isArray(result)) {\r\n      console.warn('Formula result was an array - this is not allowed. Please return an object containing the array instead: { value: [...] }.', result);\r\n      return l.r(defaults, 'array');\r\n    }\r\n\r\n    // Handle object results - the larger / more complex case\r\n    if (typeof result === 'object') {\r\n      if (result instanceof Date && targetIsValue)\r\n        return l.r({ ...defaults, value: this.#oneValue(result) }, 'date');\r\n\r\n      if (result instanceof Promise)\r\n        return l.r({\r\n          ...defaults,\r\n          value: undefined,\r\n          promise: result as Promise<FieldFormulasResultRaw>,\r\n        }, 'promise');\r\n\r\n      const raw: FieldFormulasResultRaw = result as FieldFormulasResultRaw;\r\n\r\n      // fix stop so it's never undefined\r\n      raw.stop ??= null;\r\n      raw.sleep ??= null;\r\n\r\n      // Fix single value - but only if it's not an array, in which case we must leave as is\r\n      if (raw.value && targetIsValue)\r\n        raw.value = Array.isArray(raw.value)\r\n          ? this.valueMapper?.toState(raw.value) ?? raw.value\r\n          : this.#oneValue(raw.value);\r\n\r\n      // fix fields\r\n      if (raw.fields)\r\n        raw.fields = raw.fields?.map(f => {\r\n          f.value = this.#oneValue(f.value, f.name);\r\n          return f;\r\n        });\r\n\r\n      // test options\r\n      if (raw.options) {\r\n        if (!Array.isArray(raw.options)) {\r\n          console.error('options is not an array', raw.options);\r\n          raw.options = [];\r\n        } else if (raw.options.length > 0) {\r\n          if (raw.options.find(o => !o || o.value == null)) {\r\n            console.error('some options are missing value', raw.options);\r\n            raw.options = [];\r\n          }\r\n          if (hasDuplicateValues(raw.options)) {\r\n            console.error('duplicate values in options', raw.options);\r\n            raw.options = [];\r\n          }\r\n        }\r\n      }\r\n      return l.r(raw, 'object');\r\n    }\r\n\r\n    // Non-Object results\r\n    const value: FieldFormulasResultRaw = { value: result as FieldValue };\r\n\r\n    // Handle value only result\r\n    // atm we are only correcting Value formulas\r\n    if (targetIsValue)\r\n      return l.r({ ...defaults, value: this.#oneValue(value.value) }, 'non-object, value');\r\n    return l.r(value, 'non-object, non-value');\r\n  }\r\n\r\n  /**\r\n   * Used to correct datetime field value from formula result.\r\n   * @param value Field value from formula result\r\n   * @param inputType InputType is needed to check if the result is a date which needs to be corrected\r\n   * @returns Corrected field value\r\n   */\r\n  #oneValue(value: FieldValue | Date, otherFieldName: string = null): FieldValue {\r\n    const l = this.log.fnIf('oneValue', { fieldName: this.fieldName, otherFieldName, value, type: typeof value });\r\n    if (value == null)\r\n      return l.r(value as FieldValue, 'null');\r\n\r\n    let inputType = this.inputType.inputType;\r\n\r\n    // If doing this for another field, we must lookup the definition of the other field and handle it's expected input type\r\n    if (otherFieldName) {\r\n      const otherAttribute = this.contentType.Attributes.find(a => a.Name === otherFieldName);\r\n      \r\n      if (!otherAttribute?.InputType)\r\n        return l.r(value as FieldValue, `other field ${otherFieldName}; value not changed as target field not found`);\r\n            \r\n      inputType = otherAttribute.InputType;\r\n      l.a(`other field ${otherFieldName} found, inputType: ${inputType}`);\r\n    }\r\n\r\n\r\n    if (inputType === InputTypeCatalog.DateTimeDefault || value instanceof Date) {\r\n      const date = new Date(value as string | number | Date);\r\n\r\n      // if value is not ISO string, nor milliseconds, correct timezone\r\n      if (!(typeof value === 'string' && value.endsWith('Z')) && date.getTime() !== value)\r\n        date.setTime(date.getTime() - date.getTimezoneOffset() * 60000);\r\n\r\n      date.setMilliseconds(0);\r\n      return l.r(date.toJSON(), 'date');\r\n    }\r\n    \r\n    if (typeof (value) !== 'string' && (inputType?.startsWith(DataTypeCatalog.String.toLocaleLowerCase())\r\n      || inputType?.startsWith(DataTypeCatalog.Hyperlink.toLocaleLowerCase()))) {\r\n      return l.r(value.toString(), 'not string, but input is string or hyperlink');\r\n    }\r\n    return l.r(value, 'unchanged');\r\n  }\r\n\r\n\r\n  toFormulaResult(value: FieldValue): FieldFormulasResultRaw {\r\n    return {\r\n      value,\r\n      fields: [],\r\n      stop: null,\r\n      sleep: null,\r\n      openInDesigner: this.isOpen\r\n    };\r\n  }\r\n}\r\n\r\nfunction hasDuplicateValues(options: PickerItem[]) {\r\n  var ids = options.map(o => o.value);\r\n  var uniqueIds = new Set(ids);\r\n  if (ids.length !== uniqueIds.size) {\r\n    console.error('Duplicate values in options', options, ids, uniqueIds);\r\n    return true;\r\n  }\r\n  return false;\r\n}", "import { FieldSettings } from '../../../../../../edit-types/src/FieldSettings';\r\nimport { EntityReader } from '../../shared/helpers';\r\nimport { ItemValuesOfLanguage } from '../../state/item-values-of-language.model';\r\nimport { FormulaExecutionSpecsWithRunParams } from './formula-objects-internal-data';\r\nimport { FormulaContextEntityInfo, FormulaV1Experimental } from './formula-run-experimental.model';\r\n\r\nconst messageObsolete = 'A formula in this dialog is using an experimental feature: \"{0}\" - this will be removed soon.';\r\n\r\n/**\r\n * The object containing experimental information which can change at any time.\r\n * Usually given to a formula on the third parameter, but not officially documented.\r\n * eg v2((data, ctx, experimental) => { ... })\r\n */\r\nexport class FormulaExperimentalObject implements FormulaV1Experimental {\r\n  #specs: FormulaExecutionSpecsWithRunParams;\r\n  constructor(specs: FormulaExecutionSpecsWithRunParams) { \r\n    this.#specs = specs; \r\n  }\r\n\r\n  getEntities(): FormulaContextEntityInfo[] {\r\n    this.#showWarningObsolete('getEntities');\r\n    const v1Entities = this.#specs.itemService.getMany(this.#specs.formConfig.config.itemGuids).map(i => ({\r\n      guid: i.Entity.Guid,\r\n      id: i.Entity.Id,\r\n      type: {\r\n        guid: i.Entity.Type.Id,\r\n        name: i.Entity.Type.Name,\r\n      }\r\n    } satisfies FormulaContextEntityInfo));\r\n    return v1Entities;\r\n  }\r\n\r\n  getSettings(fieldName: string): FieldSettings {\r\n    this.#showWarningObsolete('getSettings');\r\n    return this.#specs.fieldsSettingsSvc.settings[fieldName]();\r\n  }\r\n\r\n  getValues(entityGuid: string): ItemValuesOfLanguage {\r\n    this.#showWarningObsolete('getValues');\r\n    const item = this.#specs.itemService.get(entityGuid);\r\n    const reader = new EntityReader(this.#specs.language);\r\n    return reader.currentValues(item.Entity.Attributes);\r\n  }\r\n\r\n  #showWarningObsolete(name: string) {\r\n    const msg = messageObsolete.replace('{0}', name);\r\n    console.error(msg);\r\n\r\n    if (this.#specs.warningsObsolete[name])\r\n      return;\r\n    this.#specs.warningsObsolete[name] = true;\r\n    alert(msg);\r\n  }\r\n}", "import { Sxc } from '@2sic.com/2sxc-typings';\r\nimport { FormulaVersions } from '../formula-definitions';\r\nimport { FormulaExperimentalObject } from './formula-experimental-object';\r\nimport { FormulaExecutionSpecsWithRunParams } from './formula-objects-internal-data';\r\nimport { FormulaV1Context, FormulaV1CtxApp, FormulaV1CtxCulture, FormulaV1CtxFeatures, FormulaV1CtxForm, FormulaV1CtxTarget, FormulaV1CtxTargetEntity, FormulaV1CtxUser } from './formula-run-context.model';\r\nimport { FormulaContextEntityInfo } from './formula-run-experimental.model';\r\n\r\n/**\r\n * The object containing context information.\r\n * Usually given to a formula on the second parameter.\r\n * eg v2((data, CTX) => { ... })\r\n */\r\nexport class FormulaContextObject implements FormulaV1Context {\r\n\r\n  cache: Record<string, any>;\r\n  debug: boolean;\r\n  sxc: Sxc;\r\n  user: FormulaV1CtxUser;\r\n  app: FormulaV1CtxApp;\r\n  culture: FormulaV1CtxCulture;\r\n\r\n  /**\r\n   * new v18.01\r\n   */\r\n  entities: FormulaContextEntities;\r\n\r\n  features: FormulaV1CtxFeatures;\r\n  form: FormulaV1CtxForm;\r\n  target: FormulaV1CtxTarget;\r\n\r\n  xp: FormulaExperimentalObject;\r\n\r\n  constructor(specs: FormulaExecutionSpecsWithRunParams, experimental: FormulaExperimentalObject) {\r\n    const formula = specs.runParameters.formula;\r\n    this.cache = formula.cache;\r\n    this.debug = specs.debugEnabled;\r\n    this.sxc = formula.sxc;\r\n    this.user = formula.user;\r\n\r\n    // Build the App, but don't include the getSetting method which would be an empty method\r\n    const { getSetting, ...partialApp } = specs.runParameters.formula.app;\r\n    this.app = Object.assign(new FormulaContextApp(specs), partialApp);\r\n\r\n    this.target = new FormulaContextTarget(specs);\r\n\r\n    const language = specs.language;\r\n    const languages = specs.languages\r\n    this.culture = {\r\n      code: language.current,\r\n      name: languages.find(l => l.NameId === language.current)?.Culture,\r\n    };\r\n\r\n    this.features = new FormulaContextFeatures(specs);\r\n\r\n    this.form = new FormulaContextForm(specs);\r\n\r\n    this.entities = new FormulaContextEntities(specs);\r\n\r\n    this.xp = experimental;\r\n  }\r\n\r\n}\r\n\r\n/**\r\n * new v18.01\r\n */\r\nclass FormulaContextEntities {\r\n  #specs: FormulaExecutionSpecsWithRunParams\r\n  constructor(specs: FormulaExecutionSpecsWithRunParams) {\r\n    this.#specs = specs;\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @returns All entities in the context\r\n   * new v18.01\r\n   */\r\n  getAll() {\r\n    const v1Entities = this.#specs.itemService.getMany(this.#specs.formConfig.config.itemGuids).map(i => ({\r\n      guid: i.Entity.Guid,\r\n      id: i.Entity.Id,\r\n      type: {\r\n        guid: i.Entity.Type.Id,\r\n        name: i.Entity.Type.Name,\r\n      }\r\n    } satisfies FormulaContextEntityInfo));\r\n    return v1Entities;\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param guidOrName \r\n   * @returns The first entity in the context which matches the guid or name\r\n   * new v18.01\r\n   */\r\n  getOfType(guidOrName: string) {\r\n    return this.getAll().find(a => a.type.guid == guidOrName || a.type.name == guidOrName);\r\n  }\r\n}\r\n\r\nclass FormulaContextFeatures implements FormulaV1CtxFeatures {\r\n  #specs: FormulaExecutionSpecsWithRunParams;\r\n  constructor(specs: FormulaExecutionSpecsWithRunParams) {\r\n    this.#specs = specs;\r\n  }\r\n\r\n  isEnabled(name: string): boolean {\r\n    return this.#specs.features().find(f => f.nameId === name)?.isEnabled ?? false;\r\n  }\r\n}\r\n\r\nclass FormulaContextForm implements FormulaV1CtxForm {\r\n  #specs: FormulaExecutionSpecsWithRunParams;\r\n\r\n  constructor(specs: FormulaExecutionSpecsWithRunParams) {\r\n    this.#specs = specs;\r\n  }\r\n\r\n  runFormulas(): void {\r\n    // Pre v20 (2025-04-22)\r\n    // const formula = this.#specs.runParameters.formula;\r\n    // if (formula.version === FormulaVersions.V1) {\r\n    //   console.error('form.runFormulas() is being deprecated and will stop working end of 2024. Use V2 formulas and return the promise. Formulas will auto-run when it completes.');\r\n    //   this.#specs.fieldsSettingsSvc.retriggerFormulas('form.runFormulas()');\r\n    //   return;\r\n    // }\r\n    \r\n    // console.error('form.runFormulas() is not supported in V2 formulas. Just return a promise.');\r\n\r\n    // New v20 - to be removed completely ca. EOY 2025\r\n    console.error('A formula uses form.runFormulas(). This is deprecated since v18.. It is now disabled. Change formula to V2 and return a promise to achieve the same effect.');\r\n  }\r\n}\r\n\r\n/**\r\n * The object containing app context information.\r\n * Usually on the context.app property.\r\n * \r\n * Note that most properties are assigned to this object from outside, which is why we don't initialize them.\r\n * This is because they are created once, and don't need to be re-created for each formula run.\r\n */\r\nclass FormulaContextApp implements FormulaV1CtxApp {\r\n  /** Private variable containing the data used in the getters */\r\n  #propsData: FormulaExecutionSpecsWithRunParams;\r\n\r\n  constructor(propsData: FormulaExecutionSpecsWithRunParams) {\r\n    this.#propsData = propsData;\r\n  }\r\n\r\n  appId: number;\r\n  zoneId: number;\r\n  isGlobal: boolean;\r\n  isSite: boolean;\r\n  isContent: boolean;\r\n  getSetting(settingPath: string) {\r\n    if (this.#propsData.runParameters.formula.version === FormulaVersions.V1) {\r\n      console.warn('app.getSetting() is not available in v1 formulas, please use v2.');\r\n      return ' error - see console';\r\n    }\r\n\r\n    const result = this.#propsData.formConfig.config.settings.Values[settingPath];\r\n    if (result != null)\r\n      return result;\r\n    console.warn(`Error: Setting '${settingPath}' not found. Did you configure it in the ContentType to be included? ` +\r\n      `See https://go.2sxc.org/formulas`);\r\n    return ' error - see console';\r\n  }\r\n}\r\n\r\n/**\r\n * The object containing formula target information.\r\n * So it says what the formula is for, which entity, field, setting/value etc.\r\n * Usually on the context.target property.\r\n */\r\nclass FormulaContextTarget implements FormulaV1CtxTarget {\r\n\r\n  entity: FormulaV1CtxTargetEntity;\r\n  name: string;\r\n  type: string;\r\n\r\n  /** Private variable containing the data used in the getters */\r\n  #propsData: FormulaExecutionSpecsWithRunParams;\r\n\r\n  constructor(propsData: FormulaExecutionSpecsWithRunParams) {\r\n    this.#propsData = propsData;\r\n    const def = propsData.runParameters.formula;\r\n    this.entity = def.targetEntity;\r\n\r\n    // Name and type are truncated from the original target string if it's a setting\r\n    const isValueOrValidation = def.isValue || def.isValidation;\r\n    this.name = isValueOrValidation\r\n      ? def.fieldName\r\n      : def.target.substring(def.target.lastIndexOf('.') + 1);\r\n    this.type = isValueOrValidation\r\n      ? def.target\r\n      : def.target.substring(0, def.target.lastIndexOf('.'))\r\n  }\r\n\r\n}", "import { FormulaFieldValidation } from '../targets/formula-targets';\r\nimport { FormulaV1Data } from './formula-run-data.model';\r\nimport { FormulaExecutionSpecsWithRunParams, FormulaRunParameters, FormulaRunPickers } from './formula-objects-internal-data';\r\nimport { FieldValue } from '../../../../../../edit-types/src/FieldValue';\r\nimport { PickerItem } from '../../fields/picker/models/picker-item.model';\r\nimport { StateUiMapperBase } from '../../fields/picker/adapters/state-ui-mapper-base';\r\nimport { FieldSettings } from '../../../../../../edit-types/src/FieldSettings';\r\n\r\n/**\r\n * The object containing data information.\r\n * Usually given to a formula on the first parameter.\r\n * eg v2((DATA, ctx) => { ... })\r\n */\r\nexport class FormulaDataObject implements FormulaV1Data {\r\n  /** Private variable containing the data used in the getters */\r\n  #propsData: FormulaExecutionSpecsWithRunParams;\r\n  #params: FormulaRunParameters;\r\n  #valueMapper: StateUiMapperBase;\r\n  #picker: FormulaRunPickers;\r\n\r\n  constructor(propsData: FormulaExecutionSpecsWithRunParams) {\r\n    this.#propsData = propsData;\r\n    this.#params = propsData.runParameters;\r\n    this.#picker = this.#params.pickerHelper.infos;\r\n    this.#valueMapper = this.#params.pickerHelper.infos.mapper;\r\n  }\r\n\r\n  get default(): FieldValue {\r\n    const { formula } = this.#params;\r\n    if (formula.isValue)\r\n      return this.#value(this.#params.defaultValueHelper().getDefaultOrPrefillValue());\r\n\r\n    if (formula.isSetting)\r\n      return (this.#params.settingsInitial)[formula.settingName as keyof FieldSettings] as FieldValue;\r\n\r\n    if (formula.isNewPicker)\r\n      return this.#picker.options.list as unknown as FieldValue;\r\n  }\r\n\r\n  get initial(): FieldValue {\r\n    const formula = this.#params.formula;\r\n    return formula.isValue\r\n      ? this.#value(this.#propsData.initialFormValues[formula.fieldName])\r\n      : null;\r\n  }\r\n\r\n  get parameters(): Record<string, any> {\r\n    return this.#propsData.parameters.all();\r\n  }\r\n\r\n  get prefill(): FieldValue {\r\n    const { formula } = this.#params;\r\n    return formula.isValue\r\n      ? this.#value(this.#params.defaultValueHelper().getDefaultOrPrefillValue(true))\r\n      : null;\r\n  }\r\n\r\n  get value(): FieldValue | FormulaFieldValidation {\r\n    const formula = this.#params.formula;\r\n\r\n    if (formula.isValue)\r\n      return this.#value(this.#params.currentValues[formula.fieldName]);\r\n\r\n    if (formula.isSetting)\r\n      return (this.#params.settingsCurrent)[formula.settingName as keyof FieldSettings] as FieldValue;\r\n\r\n    if (formula.isValidation)\r\n      return {\r\n        severity: '',\r\n        message: '',\r\n      } satisfies FormulaFieldValidation;\r\n  }\r\n\r\n  /** Get the selected data - make sure it's a copy of each item, so changes don't affect the source! */\r\n  get selected(): PickerItem[] { return this.#getSelected('list'); }\r\n\r\n  get selectedRaw(): PickerItem[] { return this.#getSelected('listRaw'); }\r\n\r\n  #getSelected(part: 'list' | 'listRaw') {\r\n    const list = this.#picker.selected[part];\r\n    return this.#picker.picker.selectedCopy(list);\r\n  }\r\n\r\n  get options(): PickerItem[] {\r\n    return this.#getOptions('list');\r\n  }\r\n\r\n  get optionsRaw(): PickerItem[] {\r\n    return this.#getOptions('listRaw');\r\n  }\r\n\r\n  #getOptions(part: 'list' | 'listRaw') {\r\n    // TODO: create copy!\r\n    const list = this.#picker.options[part];\r\n    return list;\r\n  }\r\n\r\n\r\n  #value(raw: FieldValue): FieldValue {\r\n    return this.#valueMapper?.toUi(raw) ?? raw;\r\n  }\r\n}\r\n", "\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { EavContentType } from '../shared/models/eav';\r\nimport { LoggingService } from '../shared/services/logging.service';\r\nimport { FormulaDesignerService } from './designer/formula-designer.service';\r\nimport { FormulaVersions } from './formula-definitions';\r\nimport { FormulaDeveloperHelper } from './formula-developer-helper';\r\nimport { FormulaValueCorrections } from './results/formula-value-corrections.helper';\r\nimport { FormulaExperimentalObject } from './run/formula-experimental-object';\r\nimport { FormulaExecutionSpecsWithRunParams } from './run/formula-objects-internal-data';\r\nimport { FormulaContextObject } from './run/formula-run-context';\r\nimport { FormulaV1Context } from './run/formula-run-context.model';\r\nimport { FormulaDataObject } from './run/formula-run-data';\r\nimport { FormulaV1Data } from './run/formula-run-data.model';\r\n\r\n/**\r\n * Helper to run a single formula.\r\n * Will be initialized for each field as it's about to run all, and can then provide\r\n * helper objects and build the formula props (data/context/experimental).\r\n */\r\nexport class FormulaRunOneHelpersFactory {\r\n\r\n  constructor(\r\n    private designerSvc: FormulaDesignerService,\r\n    private translate: TranslateService,\r\n    private logSvc: LoggingService,\r\n    private contentType: EavContentType,\r\n    private entityGuid: string,\r\n    public ctTitle: string,\r\n  ) { }\r\n\r\n  public getPartsFor(execSpecs: FormulaExecutionSpecsWithRunParams) {\r\n    const f = execSpecs.runParameters.formula;\r\n    const params = this.#dataAndCtx(execSpecs);\r\n    const devHelper = new FormulaDeveloperHelper(this.designerSvc, this.translate, this.logSvc, f, this.ctTitle, params);\r\n    const valueMapper = execSpecs.runParameters.pickerHelper.infos.mapper;\r\n\r\n    return {\r\n      formula: f,\r\n      fieldName: f.fieldName,\r\n      params,\r\n      title: this.ctTitle,\r\n      devHelper,\r\n      valHelper: new FormulaValueCorrections(this.contentType, this.entityGuid, f.fieldName, f.isValue, f.inputType, devHelper.isOpen, valueMapper),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Used to build formula props parameters.\r\n   * @returns Formula properties\r\n   */\r\n  #dataAndCtx(runParams: FormulaExecutionSpecsWithRunParams,): FormulaPropsV1 {\r\n    const { formula, currentValues: formValues } = runParams.runParameters;\r\n    \r\n    switch (formula.version) {\r\n      case FormulaVersions.V1:\r\n      case FormulaVersions.V2:\r\n\r\n        // Create the data object and add all value properties of the form to it\r\n        const data = Object.assign(new FormulaDataObject(runParams), formValues);\r\n\r\n        const experimental = new FormulaExperimentalObject(runParams);\r\n\r\n        const context = new FormulaContextObject(runParams, experimental);\r\n\r\n        return {\r\n          data,\r\n          context,\r\n          // 2025-04-22 #DropFormulaParamExperimental - remove this comment and warnings ca. 2026-Q2\r\n          // experimental,\r\n        } satisfies FormulaPropsV1;\r\n\r\n      default:\r\n        // default should never happen, so don't return any data to use; will probably error if this happens\r\n        throw new Error(`Formula version '${formula.version}' unknown not supported`);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Used to build the formula props parameters as a record of key-value pairs.\r\n * @param prefillAsParameters\r\n * @returns\r\n */\r\nexport class FormulaPropsParameters {\r\n  constructor(private prefill: Record<string, unknown>) { }\r\n\r\n  all(): Record<string, any> {\r\n    if (!this.#cache)\r\n      this.#cache = this.prefill ? JSON.parse(JSON.stringify(this.prefill)) : {};\r\n    return this.#cache;\r\n  }\r\n  #cache: Record<string, any>;\r\n}\r\n\r\n\r\n\r\nexport interface FormulaPropsV1 {\r\n  data: FormulaV1Data;\r\n  context: FormulaV1Context;\r\n  // 2025-04-22 #DropFormulaParamExperimental - remove this comment and warnings ca. 2026-Q2\r\n  // experimental: FormulaV1Experimental;\r\n}\r\n", "import { DesignerSnippet, FieldOption } from '../../dialog/footer/formula-designer/formula-designer.models';\r\nimport { FormulaVersions } from '../formula-definitions';\r\nimport { FormulaCacheItem } from '../cache/formula-cache.model';\r\nimport { FormulaPropsParameters, FormulaRunOneHelpersFactory } from '../formula-run-one-helpers.factory';\r\n\r\nexport class FormulaV1Helpers {\r\n\r\n  /**\r\n   * Used to build the designer snippets context for use in formulas.\r\n   * @param formula\r\n   * @returns Designer snippets context for use in formulas\r\n   */\r\n  static buildDesignerSnippetsContext(formula: FormulaCacheItem): DesignerSnippet[] {\r\n    switch (formula.version) {\r\n      case FormulaVersions.V1:\r\n        const snippets = [\r\n          'app.appId',\r\n          'app.zoneId',\r\n          'app.isGlobal',\r\n          'app.isSite',\r\n          'app.isContent',\r\n          'cache.ChangeThis',\r\n          'culture.code',\r\n          'culture.name',\r\n          'debug',\r\n          'features.isEnabled(\\'nameId\\')',\r\n          'form.runFormulas()',\r\n          'sxc.ChangeThis',\r\n          'target.entity.id',\r\n          'target.entity.guid',\r\n          'target.name',\r\n          'target.type',\r\n          'user.id',\r\n          'user.isAnonymous',\r\n          'user.isSiteAdmin',\r\n          'user.isSystemAdmin',\r\n        ].map(name => {\r\n          const code = `context.${name}`;\r\n          const fieldSnippet: DesignerSnippet = {\r\n            code,\r\n            label: code,\r\n          };\r\n          return fieldSnippet;\r\n        });\r\n        return snippets;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Used to build the designer snippets for use in formulas.\r\n   * @param formula\r\n   * @param fieldOptions\r\n   * @param itemHeader\r\n   * @returns Designer snippets for use in formulas\r\n   */\r\n  static getSnippets(formula: FormulaCacheItem, fieldOptions: FieldOption[], prefill: Record<string, unknown>): DesignerSnippet[] {\r\n    switch (formula.version) {\r\n      case FormulaVersions.V1:\r\n        const formulaPropsParameters = new FormulaPropsParameters(prefill).all;\r\n        const snippets = [\r\n          'value',\r\n          'default',\r\n          'prefill',\r\n          'initial',\r\n          ...fieldOptions.map(f => f.fieldName),\r\n          'parameters.ChangeThis',\r\n          ...Object.keys(formulaPropsParameters).map(key => `parameters.${key}`),\r\n        ].map(name => {\r\n          const code = `data.${name}`;\r\n          const fieldSnippet: DesignerSnippet = {\r\n            code,\r\n            label: code,\r\n          };\r\n          return fieldSnippet;\r\n        });\r\n        return snippets;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n}", "/*\r\n  This is a special file which is not compiled as a normal TypeScript.\r\n  Instead it's loaded as raw text, to hand over to Monaco.\r\n  It ensures that v2 functions have intellisense.\r\n\r\n  TIP: To edit this file, briefly rename it to ...raw.ts, then back to ...rawts\r\n       This will make VSCode load it as a normal TypeScript file, so you can edit it.\r\n\r\n  - Try to keep in sync with the real code in the 2sxc project.\r\n  - The comments are _documentation_ for the user, so they can see what's available\r\n  - If you need any \"internal\" comments, use // instead\r\n  - Note that the [inject:...] comments are replaced by the build process\r\n*/\r\n\r\n/**\r\n * The data object is the main object for figuring out what the field or setting contained and what other fields currently store.\r\n * It has properties such as `.value` etc.\r\n * Just start typing to see the intellisense.\r\n */\r\n// Note that the type must be explicitly like `string | boolean | number | string[]`\r\n// Otherwise it won't show the details to the user\r\ndeclare interface FormulaData {\r\n  /**\r\n   * The value of the current field/setting when the formula runs.\r\n   *\r\n   * _It's exact type depends on the underlying type._\r\n   */\r\n  value: string | boolean | number | string[];\r\n  /**\r\n   * The _default_ value of the current field/setting as defined in the field settings.\r\n   *\r\n   * _It's exact type depends on the underlying type._\r\n   */\r\n  default: string | boolean | number | string[];\r\n  /**\r\n   * A prefill value that was passed into the form when it was loaded.\r\n   *\r\n   * _It's exact type depends on the underlying type._\r\n   */\r\n  prefill: string | boolean | number | string[];\r\n  /**\r\n   * The value of the current field/setting when the form initially loaded.\r\n   *\r\n   * _It's exact type depends on the underlying type._\r\n   */\r\n  initial: string | boolean | number | string[];\r\n  /* [inject:AllFields] */\r\n  /**\r\n   * All parameters which were passed to the form when it was loaded\r\n   *\r\n   * _It's exact type depends on the parameter, but it's usually a string._\r\n   */\r\n  parameters: {\r\n    /* [inject:AllParameters] */\r\n  };\r\n}\r\n\r\ndeclare interface FormulaContext {\r\n  /**\r\n   * Information about the current App\r\n   */\r\n  app: {\r\n    /** The current App ID */\r\n    appId: number;\r\n    /** The current Zone ID */\r\n    zoneId: number;\r\n    /** Determines if the current App is the global App */\r\n    isGlobal: boolean;\r\n    /** Determines if the current App is the primary (main) App on the site */\r\n    isSite: boolean;\r\n    /** Determines if the current App is a content App */\r\n    isContent: boolean;\r\n    /**\r\n     * Retrieve a setting like an App setting.\r\n     * You need the full path like `Settings.ShowCategories`.\r\n     * \r\n     * Important: For security reasons formulas will only get settings which where configured in the ContentType for use in Formulas.\r\n     */\r\n    getSetting(settingPath: string): string;\r\n  };\r\n  /**\r\n   * Cache for this formula. You can store any data here and it will be available in the next run.\r\n   */\r\n  cache: Record<string, any>;\r\n  /**\r\n   * Information about the current language\r\n   */\r\n  culture: {\r\n    code: string;\r\n    name: string;\r\n  };\r\n  debug: boolean;\r\n  /**\r\n   * API to detect what features are currently enabled/available\r\n   */\r\n  features: {\r\n    // /**\r\n    //  * Get internal information about a feature if it's available. This is rarely used.\r\n    //  * @param nameId The name of the feature, eg. `PasteImageFromClipboard`\r\n    //  */\r\n    // get(nameId: string): Record<string, any>;\r\n    /** Find out if the feature is enabled. Eg. `...isEnabled('PasteImageFromClipboard')` */\r\n    isEnabled(nameId: string): boolean;\r\n  };\r\n  /**\r\n   * Work with the current form\r\n   */\r\n  form: {\r\n    // v16 Deprecated for v2\r\n    // /** Re-trigger all formulas. Usually used inside promises when they complete. */\r\n    // runFormulas(): void;\r\n  };\r\n  /**\r\n   * The standard sxc object for the current App.\r\n   * It's the same as the sxc-instance in the page.\r\n   *\r\n   * You can use it to make API calls to the server.\r\n   */\r\n  sxc: {\r\n    /** The module ID */\r\n    id: number;\r\n    /** The Content-Block ID - matches the module ID unless it's an inner-content block inside another module */\r\n    cbid: number;\r\n    /** The sxc WebAPI object. Check the docs: https://docs.2sxc.org/api/js/SxcWebApi.html */\r\n    webApi: {\r\n      /**\r\n       * Get data from a url and return the json-object\r\n       * @param url Url to call. It's usually a virtual url such as `app/auto/api/basic/hello`\r\n       * @param data Optional data. If provided, it will use a POST\r\n       * @param method Optional method, default is `GET` unless you specify data, then it's `POST`\r\n       */\r\n      fetchJson<TData>(url: string, data?: string | Record<string, any>, method?: string): Promise<TData>;\r\n      /**\r\n       * Get data from a url and return the response (not a nice object)\r\n       * @param url Url to call. It's usually a virtual url such as `app/auto/api/basic/hello`\r\n       * @param data Optional data. If provided, it will use a POST\r\n       * @param method Optional method, default is `GET` unless you specify data, then it's `POST`\r\n       */\r\n      fetchRaw<TData>(url: string, data?: string | Record<string, any>, method?: string): Promise<TData>;\r\n    };\r\n    // turn off for now v16.00 - confusing\r\n    // [key: string]: any;\r\n  };\r\n  /**\r\n   * Information about the item this formula targets.\r\n   */\r\n  target: {\r\n    /** The entity the current formula affects */\r\n    entity: {\r\n      /** The entity ID */\r\n      id: number;\r\n      /** The entity GUID */\r\n      guid: string;\r\n      /** Metadata For information */\r\n      for: {\r\n        /** The target type like `4` (Entity). `0` if it's not metadata  */\r\n        targetType: number;\r\n        /** The int-key if it uses number keys, otherwise null */\r\n        number?: number;\r\n        /** The string-key if it uses string keys, otherwise null */\r\n        string?: string;\r\n        /** The GUID-key if it uses GUIDs, otherwise null */\r\n        guid?: string;\r\n      },\r\n      /** this is a new entity */\r\n      isNew: boolean;\r\n      /** this is a copy, note that isNew will also be true */\r\n      isCopy: boolean;\r\n    };\r\n    name: string;\r\n    /** The entity type name */\r\n    type: string;\r\n  };\r\n  /**\r\n   * Information about the current user\r\n   */\r\n  user: {\r\n    /** The current user ID */\r\n    id: number;\r\n    /** Check if the current user is anonymous eg. not logged in */\r\n    isAnonymous: boolean;\r\n    /** Check if the current user is a content admin */\r\n    isContentAdmin: boolean;\r\n    /** Check if the current user is a content editor (but maybe not admin) - new v20.01 */\r\n    isContentEditor: boolean;\r\n    /** Check if the current user is a site admin */\r\n    isSiteAdmin: boolean;\r\n    /** Check if the current user is a system admin */\r\n    isSystemAdmin: boolean;\r\n    /** current user e-mail */\r\n    email: string;\r\n    /** The user GUID */\r\n    guid: string;\r\n    /** the name usually shown in greetings */\r\n    name: string;\r\n    /** The user name used for login */\r\n    username: string;\r\n    /** The names of user roles of the current user is in - new v20.01 */\r\n    roles: string[];\r\n  };\r\n}\r\n\r\n// /**\r\n//  * Test docs\r\n//  * @param data The data object\r\n//  */\r\n// declare function callbackV2(data: FormulaData): string | string[];\r\n\r\n// /**\r\n//  * test docs 3\r\n//  * @param callback The real code of the formula\r\n//  */\r\n// declare function v3(callback: typeof callbackV2);\r\n\r\n/**\r\n * This `v2` wrapper is required for the intellisense to work.\r\n * @param callback The real code of the formula\r\n * @returns A string, boolean, number, date or an advanced object\r\n */\r\ndeclare function v2(\r\n  // The main function - adding comments here does not show up, so we don't have them ATM\r\n  callback: (\r\n    data: FormulaData,\r\n    context: FormulaContext,\r\n  ) => string | boolean | number | Date | {\r\n    value?: string | boolean | number | Date | { severity: 'warning' | 'error', message: string },\r\n    fields?: {\r\n      name: string,\r\n      value: string | boolean | number | Date\r\n    }[],\r\n    promise?: Promise<any>,\r\n    stop?: boolean,\r\n  },\r\n): void;\r\n", "import { FieldOption } from '../../dialog/footer/formula-designer/formula-designer.models';\r\nimport { PickerItem } from '../../fields/picker/models/picker-item.model';\r\nimport { FormulaCacheItem } from '../cache/formula-cache.model';\r\nimport { FormulaVersions } from '../formula-definitions';\r\nimport { FormulaPropsParameters } from '../formula-run-one-helpers.factory';\r\nimport { FormulaV1Context } from '../run/formula-run-context.model';\r\nimport { FormulaV1Data } from '../run/formula-run-data.model';\r\nimport { FormulaV1Experimental } from '../run/formula-run-experimental.model';\r\n\r\n// Import the type definitions for intellisense\r\nimport editorTypesForIntellisense from './editor-intellisense-function-v2.rawts';\r\n\r\nexport class IntellisenseV2 {\r\n  /**\r\n   * Used to build the formula typings for use in intellisense.\r\n   * @param formula\r\n   * @param fieldOptions\r\n   * @param itemHeader\r\n   * @returns Formula typings for use in intellisense\r\n   */\r\n  static getTypings(formula: FormulaCacheItem, fieldOptions: FieldOption[], prefill: Record<string, unknown>): string {\r\n    switch (formula.version) {\r\n      case FormulaVersions.V2: {\r\n        const formulaPropsParameters = new FormulaPropsParameters(prefill).all;\r\n\r\n        const allFields = fieldOptions.map(f => `${f.fieldName}: ${this.#inputTypeToDataType(f.inputType)};`).join('\\n');\r\n        const allParameters = Object.keys(formulaPropsParameters).map(key => `${key}: any;`).join('\\n');\r\n        const final = editorTypesForIntellisense\r\n          .replace('/* [inject:AllFields] */', allFields)\r\n          .replace('/* [inject:AllParameters] */', allParameters);\r\n\r\n        return final;\r\n\r\n        // TODO: probably update the entity-type info which was added in v14.07.05\r\n      }\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n\r\n  static #inputTypeToDataType(inputType: string) {\r\n    const lower = inputType.toLowerCase();\r\n    if (lower.startsWith('string')) return 'string';\r\n    if (lower.startsWith('number')) return 'number';\r\n    if (lower.startsWith('date')) return 'Date';\r\n    if (lower.startsWith('boolean')) return 'boolean';\r\n    return \"any\";\r\n  }\r\n}\r\n\r\n\r\ninterface FormulaPropsV1 {\r\n  data: FormulaV1Data;\r\n  context: FormulaV1Context;\r\n  experimental: FormulaV1Experimental;\r\n  item?: PickerItem; //@SDV possibly add PickerTreeItem also\r\n}\r\n\r\n\r\n", "import { Injectable } from '@angular/core';\r\nimport { transient } from '../../../../../../core';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { computedObj, signalObj } from '../../../shared/signals/signal.utilities';\r\nimport { EntityOption, FieldOption, TargetOption } from '../../dialog/footer/formula-designer/formula-designer.models';\r\nimport { FieldsSettingsService } from '../../state/fields-settings.service';\r\nimport { ItemService } from '../../state/item.service';\r\nimport { FormulaCacheItem } from '../cache/formula-cache.model';\r\nimport { FormulaCacheService } from '../cache/formula-cache.service';\r\nimport { FormulaTargets } from '../targets/formula-targets';\r\nimport { FormulaTargetsService } from '../targets/formula-targets.service';\r\nimport { DesignerState } from './designer-state.model';\r\nimport { FormulaV1Helpers } from './formula-v1-snippets';\r\nimport { IntellisenseV2 } from './intellisense-v2';\r\n\r\nconst logSpecs = {\r\n  all: false,\r\n  constructor: false,\r\n  setDesignerOpen: false,\r\n}\r\n\r\n/**\r\n * Contains methods for extended CRUD operations for formulas.\r\n */\r\n@Injectable()\r\nexport class FormulaDesignerService {\r\n\r\n  log = classLog({FormulaDesignerService}, logSpecs);\r\n\r\n  public cache = transient(FormulaCacheService);\r\n  #targetsService = transient(FormulaTargetsService);\r\n\r\n  constructor(private itemService: ItemService) {\r\n    this.log.fnIf('constructor');\r\n  }\r\n\r\n  /**\r\n   * Contain all the settings to all items/settings in this form\r\n   * for rare cases (formulas) which need to access settings of all items\r\n   */\r\n  public itemSettingsServices: Record<string, FieldsSettingsService> = {};\r\n\r\n  /** The current state of the UI, what field is being edited etc. */\r\n  public designerState = signalObj<DesignerState>('designerState', {\r\n    editMode: false,\r\n    entityGuid: undefined,\r\n    fieldName: undefined,\r\n    isOpen: false,\r\n    target: undefined,\r\n  } satisfies DesignerState);\r\n\r\n  /** Formula result of the formula which is currently open in the editor */\r\n  formulaResult = computedObj('formulaResult', () => {\r\n    const state = this.designerState();\r\n    return this.cache.resultListIndexAndOriginal(state).value;\r\n  });\r\n\r\n  currentTargetOptions = computedObj<TargetOption[]>('currentTargetOptions', () => {\r\n    const state = this.designerState();\r\n    const formulas = this.cache.formulas();\r\n    return this.#targetsService.getTargetOptions(state, formulas);\r\n  });\r\n\r\n  /** Possible entities incl. state if they have formulas */\r\n  entityOptions = computedObj<EntityOption[]>('entityOptions', () => {\r\n    // this is a signal, so this will change when the data is loaded...\r\n    const formulas = this.cache.formulas();\r\n    return Object.entries(this.itemSettingsServices).map(([entityGuid, settingsSvc]) => {\r\n      const entityFormulas = formulas.filter(f => f.entityGuid === entityGuid);\r\n      return {\r\n        entityGuid: entityGuid,\r\n        formulas: entityFormulas,\r\n        hasFormula: entityFormulas.length > 0,\r\n        label: settingsSvc.contentTypeSettings()._itemTitle,\r\n      } satisfies EntityOption;\r\n    })\r\n  });\r\n\r\n  /** possible fields of the current entity incl. state such as if it has formulas */\r\n  fieldsOptions = computedObj<FieldOption[]>('fieldsOptions', () => {\r\n    const guid = this.designerState().entityGuid;\r\n    if (guid == null)\r\n      return [];\r\n    const entityFormulas = this.entityOptions().find(e => e.entityGuid == guid).formulas;\r\n    // find the current fieldSettingsService to get all properties\r\n    const selectedSettings = this.itemSettingsServices[guid];\r\n    const fieldsProps = selectedSettings.allProps();\r\n    const fieldOptions: FieldOption[] = Object.keys(fieldsProps).map(fieldName => {\r\n      const formulas = entityFormulas.filter(f => f.fieldName === fieldName);\r\n      return {\r\n        fieldName,\r\n        formulas,\r\n        hasFormula: formulas.length > 0,\r\n        inputType: fieldsProps[fieldName].settings.InputType,\r\n        label: fieldName,\r\n      } satisfies FieldOption;\r\n    });\r\n    return fieldOptions;\r\n  });\r\n\r\n  initAfterItemSettingsAreReady(): void {\r\n    // Initialize the first designer state to contain the first item and field\r\n    const oldState = this.designerState();\r\n    const [entityGuid, settingsSvc] = Object.entries(this.itemSettingsServices)[0];\r\n    const fieldsProps = settingsSvc.allProps();\r\n    const firstFieldName = Object.keys(fieldsProps)[0];\r\n    const target = firstFieldName != null ? FormulaTargets.Value : null;\r\n\r\n    const newState: DesignerState = {\r\n      ...oldState,\r\n      entityGuid,\r\n      fieldName: firstFieldName,\r\n      target,\r\n    };\r\n    this.designerState.set(newState);\r\n  }\r\n\r\n  /** The currently selected formula or null */\r\n  currentFormula = computedObj<FormulaCacheItem>('currentFormula', () => {\r\n    const s = this.designerState();\r\n    const { value } = this.cache.formulaListIndexAndOriginal(s);\r\n    return value;\r\n  });\r\n\r\n  /** Snippets for the current formula based on it's version */\r\n  v1ContextSnippets = computedObj('v1ContextSnippets', () => {\r\n    const current = this.currentFormula();\r\n    return current != null\r\n    ? FormulaV1Helpers.buildDesignerSnippetsContext(current)\r\n    : [];\r\n  });\r\n\r\n  /** Snippets for the current item header based on the current formulas target guid */\r\n  #currentItemHeader = computedObj('currentItemHeader', () => {\r\n    const guid = this.designerState().entityGuid;\r\n    return guid == null ? null : this.itemService.getItemHeader(guid);\r\n  });\r\n\r\n  /** JS Typings for V2 formulas - all the properties and type names */\r\n  v2JsTypings = computedObj('v2JsTypings', () => {\r\n    const formula = this.currentFormula();\r\n    const itemHeader = this.#currentItemHeader();\r\n    return formula != null && itemHeader != null\r\n      ? IntellisenseV2.getTypings(formula, this.fieldsOptions(), itemHeader.Prefill)\r\n      : ''\r\n  });\r\n\r\n  /** Data snippets for the current formula V1 - all the data that can be used in formulas */\r\n  v1DataSnippets = computedObj('v1DataSnippets', () => {\r\n    const formula = this.currentFormula();\r\n    const itemHeader = this.#currentItemHeader();\r\n    return formula != null && itemHeader != null\r\n    ? FormulaV1Helpers.getSnippets(formula, this.fieldsOptions(), itemHeader.Prefill)\r\n    : []\r\n  });\r\n\r\n\r\n  /**\r\n   * Used for opening or closing designer\r\n   * @param isOpen\r\n   */\r\n  setDesignerOpen(isOpen: boolean): void {\r\n    this.log.fnIf('setDesignerOpen', { isOpen });\r\n    this.designerState.set({\r\n      ...this.designerState(),\r\n      isOpen,\r\n    } satisfies DesignerState);\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["LoggingService", "constructor", "snackBar", "logs$", "BehaviorSubject", "logLimit", "lastSnackBarTime", "snackBarDebounce", "ngOnDestroy", "complete", "addLog", "severity", "label", "error", "newLogEntry", "time", "Date", "now", "oldLogs", "value", "newLogs", "slice", "next", "showMessage", "message", "duration", "force", "nowTime", "open", "getLogs$", "asObservable", "getLogsSignal", "toSignal", "\u0275\u0275inject", "MatSnackBar", "factory", "\u0275fac", "LogSeverities", "Error", "Log", "Warn", "storeKey", "UserPreferences", "constructor", "log", "classLog", "#partCache", "fn", "local", "#local", "StateManagerLocal", "session", "#session", "StateManagerSession", "get", "key", "longTerm", "set", "value", "add", "part", "data", "#getPart", "created", "UserPreferencesPart", "factory", "\u0275fac", "providedIn", "userSettings", "merged", "__spreadValues", "#data", "signal", "snapshot", "asReadonly", "update", "__spreadProps", "#save", "toggle", "setAll", "setMany", "old", "footerPreferences", "key", "data", "tab", "expanded", "size", "pinned", "EavContentTypeAttribute", "dtoToEav", "ctAttributeDto", "metadata", "EavEntity", "dtoToEavMany", "Metadata", "settings", "EavEntityAttributes", "mergeSettings", "InputType", "IsTitle", "Name", "Settings", "Type", "ctAttributesDto", "map", "a", "EavDimension", "create", "dimCode", "EavEntity", "dtoToEav", "entityDto", "attributes", "EavEntityAttributes", "Attributes", "metadata", "dtoToEavMany", "Metadata", "Guid", "Id", "Owner", "Type", "Version", "For", "entitiesDto", "map", "e", "EavEntityAttributes", "dtoToEav", "attributesDto", "attributes", "typeName", "attributeDto", "Object", "entries", "attributeName", "valueDto", "EavField", "mergeSettings", "metadataItems", "merged", "item", "Type", "Id", "name", "value", "Attributes", "copy", "__spreadValues", "exists", "emptyAll", "Values", "EavField", "dtoToEav", "valueDto", "type", "Values", "EavFieldValue", "Type", "EavFieldValue", "create", "value", "dimensions", "dtoToEav", "valuesDto", "Object", "entries", "map", "langs", "split", "lang", "EavDimension", "createEavFieldValue", "dimCode", "EavItem", "anyToEav", "entityBundleDto", "override", "Header", "ClientData", "overrideContents", "objToEav", "Entity", "dtoToEav", "EavEntity", "header", "entityDto", "attributes", "key", "value", "type", "getType", "Values", "EavFieldValue", "createEavFieldValue", "Type", "entity", "Attributes", "eavToObj", "eavItem", "result", "attr", "length", "EavContentType", "dtoToEav", "contentTypeDto", "attributes", "EavContentTypeAttribute", "dtoToEavMany", "Attributes", "metadata", "EavEntity", "Metadata", "settings", "EavEntityAttributes", "mergeSettings", "Id", "Name", "Scope", "Settings", "Title", "contentTypesDto", "map", "ct", "ContentTypeItemService", "SignalStoreBase", "constructor", "classLog", "getId", "item", "Guid", "addContentTypeItems", "contentTypeItems", "converted", "EavEntity", "dtoToEavMany", "addMany", "factory", "\u0275fac", "providedIn", "ItemHelper", "getContentTypeNameId", "item", "Entity", "Type", "Id", "Header", "ContentTypeName", "ContentTypeService", "SignalStoreBase", "constructor", "classLog", "getId", "item", "Id", "addContentTypes", "contentTypes", "converted", "EavContentType", "dtoToEavMany", "addMany", "getContentTypeOfItem", "nameId", "ItemHelper", "getContentTypeNameId", "get", "getAttribute", "guid", "name", "Attributes", "find", "a", "Name", "getAttributeOfItem", "factory", "\u0275fac", "providedIn", "InputTypeService", "SignalStoreBase", "constructor", "classLog", "getId", "item", "Type", "getAttributeInputTypes", "attributes", "inputTypes", "getAll", "map", "attribute", "specs", "#getSpecsInternal", "InputType", "name", "Name", "inputType", "getSpecs", "inputTypeMetadata", "find", "i", "toString", "isExternal", "UiAssets", "default", "mustUseGuid", "startsWith", "componentTagName", "componentTagDialogName", "metadata", "isNewPicker", "InputTypeHelpers", "factory", "\u0275fac", "providedIn", "FieldWriter", "constructor", "log", "classLog", "#updateAttribute", "oldAttributes", "attributeKey", "attribute", "newAttributes", "Object", "keys", "length", "attributeCopy", "__spreadValues", "key", "updateAttributesValues", "allFields", "updateValues", "language", "l", "fn", "eavAttributes", "forEach", "newItemValue", "undefined", "FieldReader", "isEditableOrReadonlyTranslationExist", "newValues", "__spreadProps", "Values", "map", "val", "DimensionReader", "dimensions", "hasCurrent", "value", "a", "newEavValue", "EavFieldValue", "create", "EavDimension", "current", "updateAttributeValue", "allAttributes", "updateValue", "isReadOnly", "newLanguageValue", "d", "dimCode", "primary", "addAttributeValue", "attributeValue", "attributeType", "Type", "addAttributeDimension", "newDimensionValue", "existingDimensionValue", "defaultLanguage", "eavValue", "find", "concat", "removeAttributeDimension", "attributes", "validDimensions", "some", "includes", "newAttribute", "filter", "logSpecs", "all", "updateItemId", "updateItemHeader", "addItemAttributeValue", "updateItemAttributeValue", "setDefaultValue", "updateItemAttributesValues", "addItemAttributeDimension", "removeItemAttributeDimension", "updateItemMetadata", "ItemUpdateHelper", "constructor", "itemSvc", "log", "classLog", "saveResult", "l", "fnIf", "entityGuid", "Object", "keys", "entityId", "oldItem", "get", "Header", "EntityId", "Entity", "Id", "newItem", "__spreadProps", "__spreadValues", "add", "header", "end", "attributeKey", "newValue", "currentLanguage", "isReadOnly", "attributeType", "isTransaction", "transactionItem", "newValueDimension", "newEavValue", "EavFieldValue", "create", "EavDimension", "Attributes", "FieldWriter", "addAttributeValue", "language", "updateAttributeValue", "item", "ctAttribute", "inputType", "settings", "languages", "defaultLanguage", "Name", "defaultValue", "FieldDefaults", "Type", "getDefaultOrPrefillValue", "defaultLanguageValue", "FieldReader", "currentOrDefault", "value", "languageCode", "length", "DisableI18n", "undefined", "Guid", "current", "primary", "r", "newValues", "reader", "EntityReader", "oldValues", "relevantValues", "entries", "filter", "name", "hasOwnProperty", "values", "getBestValue", "changes", "FieldValueHelpers", "getItemValuesChanges", "newAttributes", "updateAttributesValues", "shareWithLanguage", "addAttributeDimension", "fieldName", "delayUpsert", "removeAttributeDimension", "metadata", "Metadata", "ItemService", "SignalStoreObservableBase", "constructor", "classLog", "getId", "item", "Entity", "Guid", "updater", "ItemUpdateHelper", "#itemAttributesCache", "ComputedCacheHelper", "#itemHeaderCache", "#slotIsEmptyCache", "loadItems", "dtoItems", "items", "map", "EavItem", "anyToEav", "addMany", "itemAttributesSignal", "entityGuid", "l", "log", "fn", "result", "getOrCreate", "getSignal", "Attributes", "r", "getItemAttributes", "get", "getItemAttributes$", "list$", "pipe", "find", "mapUntilChanged", "m", "getItemHeader", "Header", "getItemHeader$", "mapUntilObjChanged", "getItemHeaderSignal", "slotIsEmpty", "header", "IsEmptyAllowed", "IsEmpty", "getItemFor", "For", "getItemNote", "Metadata", "metadata", "Type", "Name", "eavConstants", "contentTypes", "notes", "factory", "\u0275fac", "providedIn", "SettingsFormulaPrefix", "FormulaDefaultTargets", "Disabled", "Name", "Notes", "Required", "Value", "Visible", "Validation", "FormulaDefaultTargetValues", "Object", "values", "FormulaNewPickerTargets", "Options", "Selected", "FormulaNewPickerTargetValues", "FormulaSpecialPickerTargets", "FormulaSpecialPickerAutoSleep", "FormulaOptionalTargets", "Collapsed", "DropdownValues", "FormulaOptionalTargetValues", "FormulaTargets", "__spreadValues", "runFormulaPrefix", "defaultFormulaV2", "defaultFormula", "listItemFormulaV2", "defaultListItemFormula", "FormulaVersions", "V1", "V2", "logSpecs", "all", "constructor", "update", "fields", "DebugFields", "FieldLogicBase", "log", "#log", "classLog", "extendName", "name", "inheritingClass", "logThis", "canAutoTranslate", "fnIf", "add", "logic", "logicInstance", "FieldLogicManager", "singleton", "importMe", "isValueEmpty", "value", "isCreateMode", "l", "fn", "emptyEntityField", "Array", "isArray", "length", "r", "undefined", "findAndMergeAdvanced", "tools", "possibleGuid", "defaults", "wysiwygConfig", "eavConfig", "settings", "Entities", "find", "e", "Guid", "advanced", "reader", "flatten", "__spreadValues", "UnknownLogic", "FieldLogicBase", "constructor", "name", "InputTypeCatalog", "Unknown", "canAutoTranslate", "update", "settings", "logSpecs", "all", "get", "FieldLogicManager", "constructor", "logics", "log", "classLog", "add", "UnknownLogic", "singleton", "window", "eavFieldLogicManager", "logic", "name", "inputTypeName", "l", "fnIf", "r", "getOrUnknown", "InputTypeCatalog", "Unknown", "TranslationLinks", "Translate", "DontTranslate", "MissingDefaultLangValue", "LinkReadOnly", "LinkReadWrite", "LinkCopyFrom", "TranslateMenuHelpers", "getTranslationStateClass", "linkType", "TranslationLinks", "MissingDefaultLangValue", "Translate", "LinkCopyFrom", "DontTranslate", "LinkReadOnly", "LinkReadWrite", "calculateSharedInfoMessage", "dimensions", "currentLanguage", "calculateShortDimensions", "result", "calculateEditAndReadDimensions", "editableDimensions", "readOnlyDimensions", "infoMessage", "editableExist", "length", "readOnlyExist", "join", "dimMap", "langCode", "slice", "indexOf", "forEach", "dimension", "shortNoReadOnly", "replace", "push", "map", "shortDimension", "d", "logSpecs", "all", "mergeGenericSettings", "getDefaultSettings", "fields", "DebugFields", "FieldsSettingsHelpers", "constructor", "source", "log", "classLog", "fieldName", "settings", "l", "fnIfInList", "asWithGenericSettings", "SettingsGeneric", "r", "genericSettings", "JSON", "parse", "__spreadValues", "error", "console", "defSettings", "AllDeprecated", "moveDeprecatedSettings", "Name", "Placeholder", "Notes", "Required", "Disabled", "DisableTranslation", "Visible", "DefaultCollapsed", "Collapsed", "Formulas", "logic", "FieldLogicManager", "singleton", "get", "InputType", "DisableAutoTranslation", "canAutoTranslate", "isLastInGroup", "contentType", "attribute", "index", "Attributes", "indexOf", "indexOfFirstEmpty", "findIndex", "a", "InputTypeHelpers", "isGroupStart", "isGroupEnd", "endsPreviousGroup", "getDisabledBecauseTranslations", "attributeValues", "disableTranslation", "language", "fieldReader", "FieldReader", "current", "primary", "hasPrimary", "hasEditableValues", "hasCurrentReadonly", "getTranslationState", "debug", "fn", "infoLabel", "infoMessage", "hasEditable", "hasReadonly", "dimensions", "map", "dimension", "dimCode", "filter", "includes", "length", "TranslateMenuHelpers", "calculateSharedInfoMessage", "state", "#getTranslationStateCore", "linkType", "TranslationLinks", "MissingDefaultLangValue", "DontTranslate", "editableElements", "d", "LinkReadWrite", "Translate", "LinkReadOnly", "asDeprecated", "VisibleInEditUI", "FormulaSourceCodeHelper", "#cleanFormula", "formula", "cleanFormula", "trim", "startsWith", "replace", "FormulaVersions", "V1", "runFormulaPrefix", "substring", "lastIndexOf", "findFormulaVersion", "versionPart", "length", "indexOf", "Object", "values", "includes", "undefined", "buildFormulaFunction", "Function", "logSpecs", "all", "buildFormulaCache", "updateFormulaFromEditor", "createPromisedParts", "getSharedParts", "FormulaCacheBuilder", "ServiceBase", "constructor", "formConfig", "itemService", "contentTypeService", "contentTypeItemService", "loggingService", "translate", "inputTypes", "log", "classLog", "#sharedPartsCache", "cacheSvc", "l", "fnIf", "formulaCache", "language", "reader", "EntityReader", "fss", "FieldsSettingsHelpers", "name", "entityGuid", "config", "itemGuids", "item", "get", "shared", "#getSharedParts", "contentType", "getContentTypeOfItem", "attribute", "Attributes", "settings", "getDefaultSettings", "flatten", "Metadata", "inputType", "getSpecs", "formulaEntities", "getMany", "Formulas", "filter", "f", "getBestValue", "Enabled", "fEntity", "sourceCode", "Formula", "target", "Target", "formulaFunction", "FormulaSourceCodeHelper", "buildFormulaFunction", "error", "cacheResults", "fieldName", "Name", "undefined", "itemTitle", "ContentTypeSettingsHelpers", "getTitle", "addLog", "LogSeverities", "Error", "showMessage", "instant", "formulaCacheItem", "__spreadValues", "__spreadProps", "cache", "fn", "bind", "isDraft", "sourceCodeSaved", "sourceCodeGuid", "Guid", "sourceCodeId", "Id", "#inputTypeSpecsForCacheItem", "version", "findFormulaVersion", "stop", "sleep", "fieldIsSpecialPicker", "FormulaSpecialPickerTargets", "includes", "#createPromisedParts", "#targetInfoForCacheItem", "push", "r", "isNewPicker", "disabled", "disabledReason", "startsWith", "SettingsFormulaPrefix", "isSetting", "settingName", "substring", "length", "isValue", "isValidation", "FormulaDefaultTargets", "Value", "Validation", "entity", "Entity", "mdFor", "For", "targetEntity", "guid", "id", "type", "Type", "for", "targetType", "TargetType", "number", "Number", "string", "String", "isNew", "isCopy", "user", "dialogContext", "User", "email", "Email", "isAnonymous", "IsAnonymous", "isSiteAdmin", "IsSiteAdmin", "isContentEditor", "isContentAdmin", "IsContentAdmin", "isSystemAdmin", "IsSystemAdmin", "username", "Username", "roles", "app", "appId", "zoneId", "isGlobal", "App", "IsGlobalApp", "isSite", "IsSiteApp", "isContent", "IsContentApp", "getSetting", "key", "sxc", "window", "$2sxc", "pageId", "tabId", "moduleId", "_noContextInHttpHeaders", "_autoAppIdsInUrl", "promises$", "BehaviorSubject", "updateCallback$", "promiseSpecs", "pipe", "x", "switchMap", "set", "from", "promise", "map", "result", "subscriptions", "add", "combineLatest", "subscribe", "callback", "completed", "run", "errorLabel", "console", "getAttributeOfItem", "list", "index", "value", "formulaListIndexAndOriginal", "formula", "streams", "newFormulaItem", "slice", "\u0275\u0275inject", "FormConfigService", "ItemService", "ContentTypeService", "ContentTypeItemService", "LoggingService", "TranslateService", "InputTypeService", "factory", "\u0275fac", "logSpecs", "all", "getActive", "fields", "DebugFields", "FormulaCacheService", "#cacheBuilder", "constructor", "log", "classLog", "transient", "FormulaCacheBuilder", "formulas", "signalObj", "#results", "init", "formulaCache", "buildFormulaCache", "set", "#findFormulas", "entityGuid", "fieldName", "target", "allowDraft", "filter", "f", "find", "isDraft", "name", "forNewPicker", "l", "fnIfInList", "targets", "FormulaDefaultTargetValues", "concat", "FormulaNewPickerTargetValues", "FormulaOptionalTargetValues", "unstopped", "stop", "r", "length", "formulaListIndexAndOriginal", "fOrDs", "list", "index", "findIndex", "value", "updateSaved", "formulaItem", "sourceGuid", "sourceId", "updated", "__spreadProps", "__spreadValues", "sourceCodeSaved", "sourceCode", "sourceCodeGuid", "sourceCodeId", "newCache", "slice", "updateFormulaFromEditor", "id", "formula", "run", "delete", "resetFormula", "#deleteResult", "cacheResults", "isError", "isOnlyPromise", "newResult", "fn", "untracked", "resultListIndexAndOriginal", "newResults", "a", "end", "factory", "\u0275fac", "FormulaTargetsService", "constructor", "itemService", "contentTypeService", "getTargetOptions", "id", "formulas", "targetOptions", "entityGuid", "fieldName", "fieldFormulas", "filter", "f", "target", "Object", "values", "FormulaDefaultTargets", "targetOption", "hasFormula", "some", "label", "substring", "lastIndexOf", "push", "item", "get", "inputType", "getAttributeOfItem", "InputType", "InputTypeHelpers", "isGroupStart", "FormulaOptionalTargets", "Collapsed", "isOldValuePicker", "DropdownValues", "isNewPicker", "FormulaNewPickerTargets", "formula", "t", "\u0275\u0275inject", "ItemService", "ContentTypeService", "factory", "\u0275fac", "FormulaDeveloperHelper", "constructor", "designerSvc", "translate", "logSvc", "formula", "ctTitle", "formulaProps", "isOpen", "#isDesignerOpen", "showStart", "f", "console", "log", "version", "toLocaleUpperCase", "fieldName", "target", "showResult", "value", "isError", "isOnlyPromise", "cache", "cacheResults", "showError", "error", "errorLabel", "undefined", "addLog", "LogSeverities", "Error", "showMessage", "instant", "untracked", "ds", "designerState", "entityGuid", "logSpecs", "all", "v1", "v2", "allValues", "oneValue", "fields", "DebugFields", "FormulaValueCorrections", "constructor", "contentType", "entityGuid", "fieldName", "isValue", "inputType", "isOpen", "valueMapper", "log", "classLog", "v1Result", "isArray", "Array", "every", "r", "includes", "Date", "ok", "toFormulaResult", "undefined", "v1Value", "#oneValue", "result", "raw", "__spreadProps", "__spreadValues", "openInDesigner", "l", "fnIfInList", "defaults", "value", "stop", "sleep", "targetIsValue", "console", "warn", "Promise", "promise", "toState", "map", "f", "name", "options", "length", "find", "o", "error", "hasDuplicateValues", "otherFieldName", "fnIf", "type", "otherAttribute", "Attributes", "a", "Name", "InputType", "InputTypeCatalog", "DateTimeDefault", "date", "endsWith", "getTime", "setTime", "getTimezoneOffset", "setMilliseconds", "toJSON", "startsWith", "DataTypeCatalog", "String", "toLocaleLowerCase", "Hyperlink", "toString", "ids", "uniqueIds", "Set", "size", "messageObsolete", "FormulaExperimentalObject", "#specs", "constructor", "specs", "getEntities", "#showWarningObsolete", "itemService", "getMany", "formConfig", "config", "itemGuids", "map", "i", "guid", "Entity", "Guid", "id", "Id", "type", "Type", "name", "Name", "getSettings", "fieldName", "fieldsSettingsSvc", "settings", "getValues", "entityGuid", "item", "get", "EntityReader", "language", "currentValues", "Attributes", "msg", "replace", "console", "error", "warningsObsolete", "alert", "FormulaContextObject", "constructor", "specs", "experimental", "formula", "runParameters", "cache", "debug", "debugEnabled", "sxc", "user", "app", "getSetting", "partialApp", "Object", "assign", "FormulaContextApp", "target", "FormulaContextTarget", "language", "languages", "culture", "code", "current", "name", "find", "l", "NameId", "Culture", "features", "FormulaContextFeatures", "form", "FormulaContextForm", "entities", "FormulaContextEntities", "xp", "#specs", "getAll", "itemService", "getMany", "formConfig", "config", "itemGuids", "map", "i", "guid", "Entity", "Guid", "id", "Id", "type", "Type", "Name", "getOfType", "guidOrName", "a", "isEnabled", "f", "nameId", "runFormulas", "console", "error", "#propsData", "propsData", "settingPath", "version", "FormulaVersions", "V1", "warn", "result", "settings", "Values", "def", "entity", "targetEntity", "isValueOrValidation", "isValue", "isValidation", "fieldName", "substring", "lastIndexOf", "FormulaDataObject", "#propsData", "#params", "#valueMapper", "#picker", "constructor", "propsData", "runParameters", "pickerHelper", "infos", "mapper", "default", "formula", "isValue", "#value", "defaultValueHelper", "getDefaultOrPrefillValue", "isSetting", "settingsInitial", "settingName", "isNewPicker", "options", "list", "initial", "initialFormValues", "fieldName", "parameters", "all", "prefill", "value", "currentValues", "settingsCurrent", "isValidation", "severity", "message", "selected", "#getSelected", "selectedRaw", "part", "picker", "selectedCopy", "#getOptions", "optionsRaw", "raw", "toUi", "FormulaRunOneHelpersFactory", "constructor", "designerSvc", "translate", "logSvc", "contentType", "entityGuid", "ctTitle", "getPartsFor", "execSpecs", "f", "runParameters", "formula", "params", "#dataAndCtx", "devHelper", "FormulaDeveloperHelper", "valueMapper", "pickerHelper", "infos", "mapper", "fieldName", "title", "valHelper", "FormulaValueCorrections", "isValue", "inputType", "isOpen", "runParams", "currentValues", "formValues", "version", "FormulaVersions", "V1", "V2", "data", "Object", "assign", "FormulaDataObject", "experimental", "FormulaExperimentalObject", "context", "FormulaContextObject", "Error", "FormulaPropsParameters", "prefill", "all", "#cache", "JSON", "parse", "stringify", "FormulaV1Helpers", "buildDesignerSnippetsContext", "formula", "version", "FormulaVersions", "V1", "map", "name", "code", "label", "getSnippets", "fieldOptions", "prefill", "formulaPropsParameters", "FormulaPropsParameters", "all", "f", "fieldName", "Object", "keys", "key", "editor_intellisense_function_v2_default", "IntellisenseV2", "getTypings", "formula", "fieldOptions", "prefill", "version", "FormulaVersions", "V2", "formulaPropsParameters", "FormulaPropsParameters", "all", "allFields", "map", "f", "fieldName", "#inputTypeToDataType", "inputType", "join", "allParameters", "Object", "keys", "key", "editorTypesForIntellisense", "replace", "lower", "toLowerCase", "startsWith", "logSpecs", "all", "constructor", "setDesignerOpen", "FormulaDesignerService", "#targetsService", "itemService", "log", "classLog", "cache", "transient", "FormulaCacheService", "FormulaTargetsService", "itemSettingsServices", "designerState", "signalObj", "editMode", "entityGuid", "undefined", "fieldName", "isOpen", "target", "formulaResult", "computedObj", "state", "resultListIndexAndOriginal", "value", "currentTargetOptions", "formulas", "getTargetOptions", "entityOptions", "Object", "entries", "map", "settingsSvc", "entityFormulas", "filter", "f", "hasFormula", "length", "label", "contentTypeSettings", "_itemTitle", "fieldsOptions", "guid", "find", "e", "fieldsProps", "allProps", "keys", "inputType", "settings", "InputType", "currentFormula", "s", "formulaListIndexAndOriginal", "v1ContextSnippets", "current", "FormulaV1Helpers", "buildDesignerSnippetsContext", "#currentItemHeader", "getItemHeader", "v2JsTypings", "formula", "itemHeader", "IntellisenseV2", "getTypings", "Prefill", "v1DataSnippets", "getSnippets", "fnIf", "initAfterItemSettingsAreReady", "oldState", "firstFieldName", "FormulaTargets", "Value", "newState", "__spreadProps", "__spreadValues", "set", "\u0275\u0275inject", "ItemService", "factory", "\u0275fac"]
}

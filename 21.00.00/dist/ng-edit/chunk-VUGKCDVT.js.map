{
  "version": 3,
  "sources": ["projects/eav-ui/src/app/edit/shared/controls/ui-control.ts", "projects/eav-ui/src/app/edit/shared/validation/validation-messages.helpers.ts"],
  "sourcesContent": ["import { AbstractControl } from '@angular/forms';\r\nimport isEqual from 'lodash-es/isEqual';\r\nimport { FieldValue } from '../../../../../../edit-types/src/FieldValue';\r\nimport { classLog } from '../../../shared/logging';\r\nimport { DebugFields } from '../../edit-debug';\r\nimport { FieldValueHelpers } from '../helpers/field-value.helpers';\r\nimport { ValidationMsgHelper } from '../validation/validation-messages.helpers';\r\nimport { AbstractControlPro } from '../validation/validation.helpers';\r\n\r\nconst logSpecs = {\r\n  all: true,\r\n  constructor: false,\r\n  markTouched: false,\r\n  set: false,\r\n  disable: false,\r\n  getErrors: true,\r\n  fields: [...DebugFields, '*'],\r\n};\r\n\r\nconst pfx = 'ValidationMessage.';\r\n\r\n/**\r\n * Provides information about the UI Control, but NOT the value.\r\n * It is used to simplify the logic when interacting with the Angular Virtual Form.\r\n */\r\nexport class UiControl {\r\n\r\n  log = classLog({UiControl}, logSpecs);\r\n\r\n  constructor(\r\n    public control: AbstractControl,\r\n    private name = 'unknown',\r\n    private moreDisabled: boolean = false,\r\n  ) {\r\n    // Patch control with dummy object for the nullable case where we're just creating a fake control...\r\n    this.control ??= { dirty: false, invalid: false, touched: false, value: null, disabled: false } as AbstractControl;\r\n    this.log.extendName(`[${name}]`);\r\n    this.log.aIfInList('fields', this.name, { moreDisabled }, 'constructor');\r\n  }\r\n\r\n  static emptyControl() {\r\n    return new UiControl({ dirty: false, invalid: false, touched: false, value: null, disabled: false } as AbstractControl);\r\n  }\r\n\r\n  //#region simple direct properties & complex properties\r\n  get dirty() { return this.control.dirty; }\r\n  get invalid() { return this.control.invalid; }\r\n  get touched() { return this.control.touched; }\r\n  get disabled() { return this.control.disabled || this.moreDisabled; }\r\n  get touchedAndInvalid() { return this.control.touched && this.control.invalid; }\r\n  //#endregion\r\n\r\n  //#region methods\r\n\r\n  markTouched(): void {\r\n    this.log.aIfInList('fields', this.name, null, 'markTouched');\r\n    UiControl.markTouched(this.control);\r\n  }\r\n\r\n  setIfChanged(newValue: FieldValue): void {\r\n    const before = this.control.value;\r\n    this.log.aIfInList('fields', this.name, { before, newValue }, 'setIfChanged');\r\n    if (isEqual(newValue, this.control.value)) return;\r\n    this.#set(newValue);\r\n  }\r\n\r\n  /** Use to update form controls value */\r\n  #set(newValue: FieldValue): void {\r\n    const control = this.control;\r\n    const before = control.value;\r\n    this.log.aIfInList('fields', this.name, { before, newValue }, 'set');\r\n\r\n    if (!control.touched)\r\n      control.markAsTouched();\r\n\r\n    if (!control.dirty && !FieldValueHelpers.fieldValuesAreEqual(before, newValue))\r\n      control.markAsDirty();\r\n\r\n    // Note: 2024-10-21 ca. 18.02 we have some timing issues, error always seems to show previous error; maybe fixed now, otherwise revisit\r\n    // Set value must happen at the end, otherwise errors will be late by one cycle\r\n    // for example, they could show \"required\" after the value was\r\n    control.patchValue(newValue);\r\n  }\r\n\r\n  disable(disable: boolean): void {\r\n    this.log.aIfInList('fields', this.name, null, `disable: ${disable}`);\r\n    UiControl.disable(this.control, disable);\r\n  }\r\n\r\n  //#endregion\r\n\r\n  //#region private helpers\r\n\r\n  /** TODO: Try to remove this by assigning controls [formControlName] in [formGroup] */\r\n  static markTouched(control: AbstractControl): void {\r\n    if (control.touched)\r\n      return;\r\n\r\n    control.markAsTouched();\r\n    control.updateValueAndValidity();\r\n  }\r\n\r\n  /** Disables/enables control if not already disabled/enabled. Use this helper to trigger fewer events on the form */\r\n  static disable(control: AbstractControl, disable: boolean) {\r\n    if (control.disabled === disable)\r\n      return;\r\n\r\n    if (disable)\r\n      control.disable();\r\n    else\r\n      control.enable();\r\n  }\r\n  //#endregion\r\n\r\n  /** Calculates error message */\r\n  getErrors(): string {\r\n    const control = this.control;\r\n    const errors = control.errors;\r\n    const l = this.log.fnIfInList('getErrors', 'fields', this.name, { control, name: this.name });\r\n    if (!control.invalid)\r\n      return l.r('', 'valid');\r\n    if (!control.dirty && !control.touched)\r\n      return l.r('', 'not dirty or touched');\r\n\r\n    for (const errorKey of Object.keys(errors)) {\r\n      const error = (errorKey === 'formulaError')\r\n        ? control.errors['formulaMessage'] ?? ValidationMsgHelper.messages[errorKey]?.(true)\r\n        : ValidationMsgHelper.messages[errorKey]?.(true);\r\n      if (error)\r\n        return l.r(error, 'error found');\r\n    }\r\n\r\n    return l.r('', 'no error');\r\n  }\r\n\r\n  #warningMessages: Record<string, string> = {\r\n    jsonWarning: `${pfx}JsonWarning`,\r\n    formulaWarning: `${pfx}NotValid`,\r\n  };\r\n\r\n  getWarnings(): string {\r\n    const control = this.control as AbstractControlPro;\r\n    if (control._warning == null)\r\n      return '';\r\n    if (!control.dirty && !control.touched)\r\n      return '';\r\n\r\n    let warning = '';\r\n    for (const warningKey of Object.keys(control._warning)) {\r\n      warning = (warningKey === 'formulaWarning')\r\n        ? control._warning['formulaMessage'] ?? this.#warningMessages[warningKey]\r\n        : this.#warningMessages[warningKey];\r\n      if (warning)\r\n        break;\r\n    }\r\n    return warning;\r\n  }\r\n}\r\n", "import { UntypedFormGroup } from '@angular/forms';\r\nimport { UiControl } from '../controls/ui-control';\r\n\r\n// prefix for translation keys\r\nconst prefix = 'ValidationMessage.';\r\nconst notValid = 'ValidationMessage.NotValid';\r\n\r\nexport class ValidationMsgHelper {\r\n\r\n  public static messages: Record<string, (long: boolean) => string> = {\r\n    required: (long: boolean) => long ? `${prefix}Required` : `${prefix}RequiredShort` /* short version in snackbar*/,\r\n    min: (long: boolean) => long ? `${prefix}Min` : notValid,\r\n    max: (long: boolean) => long ? `${prefix}Max` : notValid,\r\n    minNoItems: (long: boolean) => long ? `${prefix}MinNoItems` : notValid,\r\n    maxNoItems: (long: boolean) => long ? `${prefix}MaxNoItems` : notValid,\r\n    pattern: (long: boolean) => long ? `${prefix}Pattern` : notValid,\r\n    decimals: (long: boolean) => long ? `${prefix}Decimals` : notValid,\r\n    jsonError: (long: boolean) => long ? `${prefix}JsonError` : notValid,\r\n    formulaError: (long: boolean) => notValid,\r\n  };\r\n\r\n  /** Marks controls as touched to show errors beneath controls and collects error messages */\r\n  static validateForm(form: UntypedFormGroup): Record<string, string> {\r\n    const errors: Record<string, string> = {};\r\n    for (const [controlKey, control] of Object.entries(form.controls)) {\r\n      UiControl.markTouched(control);\r\n\r\n      if (!control.invalid) continue;\r\n\r\n      for (const errorKey of Object.keys(control.errors)) {\r\n        errors[controlKey] = this.messages[errorKey]?.(false);\r\n        if (errors[controlKey]) break;\r\n      }\r\n    }\r\n    return errors;\r\n  }\r\n\r\n}\r\n"],
  "mappings": "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",
  "names": ["logSpecs", "all", "constructor", "markTouched", "set", "disable", "getErrors", "fields", "DebugFields", "pfx", "UiControl", "control", "name", "moreDisabled", "log", "classLog", "#warningMessages", "jsonWarning", "formulaWarning", "dirty", "invalid", "touched", "value", "disabled", "extendName", "aIfInList", "emptyControl", "touchedAndInvalid", "setIfChanged", "newValue", "before", "isEqual", "#set", "markAsTouched", "FieldValueHelpers", "fieldValuesAreEqual", "markAsDirty", "patchValue", "updateValueAndValidity", "enable", "errors", "l", "fnIfInList", "r", "errorKey", "Object", "keys", "error", "ValidationMsgHelper", "messages", "getWarnings", "_warning", "warning", "warningKey", "prefix", "notValid", "ValidationMsgHelper", "messages", "required", "long", "min", "max", "minNoItems", "maxNoItems", "pattern", "decimals", "jsonError", "formulaError", "validateForm", "form", "errors", "controlKey", "control", "Object", "entries", "controls", "UiControl", "markTouched", "invalid", "errorKey", "keys"]
}
